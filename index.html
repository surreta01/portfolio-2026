<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Portfolio Institucional 2026</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#060a10;--bg2:#0d1521;--bg3:#111927;--bg4:#1a2332;
  --border:#1e293b;--border2:#2d3f55;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --green:#10b981;--green-bg:rgba(16,185,129,.12);--green-border:rgba(16,185,129,.25);
  --red:#f87171;--red-bg:rgba(248,113,113,.12);--red-border:rgba(248,113,113,.25);
  --yellow:#fbbf24;--yellow-bg:rgba(251,191,36,.12);--yellow-border:rgba(251,191,36,.25);
  --blue:#60a5fa;--blue-bg:rgba(96,165,250,.12);--blue-border:rgba(96,165,250,.25);
  --orange:#fb923c;
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* â”€â”€ TOP NAV â”€â”€ */
.topnav{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:14px 24px;display:flex;align-items:center;gap:16px;
  position:sticky;top:0;z-index:100;
}
.logo{font-size:15px;font-weight:800;letter-spacing:-0.5px;color:#f1f5f9;}
.logo span{color:var(--blue);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;
  cursor:pointer;border:none;transition:all .15s;
}
.btn-primary{background:var(--blue);color:#000;}
.btn-primary:hover{background:#93c5fd;}
.btn-ghost{background:var(--bg3);color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--bg4);color:var(--text);}
.btn-danger{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.btn-danger:hover{background:rgba(248,113,113,.2);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.btn-green:hover{background:rgba(16,185,129,.2);}

/* â”€â”€ LAYOUT â”€â”€ */
.main{display:flex;min-height:calc(100vh - 53px);}
.sidebar{
  width:260px;flex-shrink:0;background:var(--bg2);
  border-right:1px solid var(--border);padding:20px 16px;
  position:sticky;top:53px;height:calc(100vh - 53px);overflow-y:auto;
}
.content{flex:1;padding:24px;overflow-x:auto;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar-section{margin-bottom:24px;}
.sidebar-title{
  font-size:10px;font-weight:700;text-transform:uppercase;
  letter-spacing:1.2px;color:var(--text3);margin-bottom:12px;
}
.filter-group{display:flex;flex-direction:column;gap:6px;}
.filter-chip{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:8px;cursor:pointer;
  background:var(--bg3);border:1px solid var(--border);
  transition:all .15s;user-select:none;
}
.filter-chip:hover{border-color:var(--border2);}
.filter-chip.active{border-color:var(--blue);background:var(--blue-bg);}
.filter-chip input[type=checkbox]{accent-color:var(--blue);width:14px;height:14px;flex-shrink:0;}
.filter-chip .chip-label{font-size:12px;font-weight:500;color:var(--text2);flex:1;}
.filter-chip.active .chip-label{color:var(--text);}
.chip-count{
  font-size:10px;font-weight:700;
  padding:2px 6px;border-radius:100px;
  background:var(--bg4);color:var(--text3);
}

.range-group{display:flex;flex-direction:column;gap:8px;}
.range-item label{font-size:11px;color:var(--text3);display:block;margin-bottom:4px;}
.range-item input[type=range]{width:100%;accent-color:var(--blue);}
.range-val{font-size:11px;font-weight:700;color:var(--blue);float:right;}

.search-box{
  width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;padding:8px 10px;color:var(--text);
  font-size:12px;font-family:'Inter',sans-serif;
  outline:none;transition:border-color .15s;
}
.search-box:focus{border-color:var(--blue);}
.search-box::placeholder{color:var(--text3);}

/* â”€â”€ HEADER â”€â”€ */
.page-header{margin-bottom:24px;}
.header-top{display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap;margin-bottom:16px;}
.header-title{font-size:22px;font-weight:900;letter-spacing:-0.5px;color:#f1f5f9;}
.header-sub{font-size:12px;color:var(--text3);margin-top:4px;}
.header-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;}

/* KPI bar */
.kpi-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;}
.kpi-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  padding:12px 16px;flex:1;min-width:130px;
}
.kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:6px;}
.kpi-val{font-size:20px;font-weight:800;}
.kpi-sub{font-size:10px;color:var(--text3);margin-top:3px;}

/* â”€â”€ SECTION â”€â”€ */
.section{margin-bottom:32px;}
.section-header{
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;border-radius:10px;margin-bottom:0;
  cursor:pointer;user-select:none;
}
.sh-core  {background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(59,130,246,.06));border:1px solid rgba(59,130,246,.2);}
.sh-growth{background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(245,158,11,.06));border:1px solid rgba(245,158,11,.2);}
.sh-special{background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(239,68,68,.06));border:1px solid rgba(239,68,68,.2);}
.section-icon{font-size:20px;}
.section-name{font-size:14px;font-weight:800;color:#f1f5f9;}
.section-desc{font-size:11px;color:var(--text3);margin-top:1px;}
.section-badge{
  margin-left:auto;font-size:11px;font-weight:700;
  padding:4px 10px;border-radius:100px;
}
.badge-blue  {background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}
.badge-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.badge-red   {background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.chevron{margin-left:8px;font-size:12px;color:var(--text3);transition:transform .2s;}
.chevron.open{transform:rotate(180deg);}

/* â”€â”€ TABLE â”€â”€ */
.tbl-wrap{
  border:1px solid var(--border);border-radius:0 0 12px 12px;
  overflow:hidden;border-top:none;
}
table{width:100%;border-collapse:collapse;min-width:800px;}
thead th{
  background:var(--bg3);padding:9px 12px;
  font-size:10px;font-weight:700;text-transform:uppercase;
  letter-spacing:0.8px;color:var(--text3);text-align:left;
  white-space:nowrap;cursor:pointer;
}
thead th:hover{color:var(--text2);}
thead th.sorted{color:var(--blue);}
tbody td{
  padding:11px 12px;border-top:1px solid var(--border);
  font-size:13px;color:var(--text2);vertical-align:middle;
}
tbody tr{transition:background .1s;}
tbody tr:hover td{background:var(--bg3);}
tbody tr.hidden{display:none;}

/* cells */
.ticker-cell{display:flex;align-items:center;gap:9px;}
.tlogo{
  width:32px;height:32px;border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:-0.5px;
}
.tname{font-size:10px;color:var(--text3);}
.tfull{font-size:13px;font-weight:700;color:#f1f5f9;}

.pill{display:inline-block;padding:2px 8px;border-radius:100px;font-size:11px;font-weight:700;}
.pill-green {background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.pill-red   {background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.pill-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.pill-blue  {background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}

.upside-val{font-size:14px;font-weight:800;color:var(--green);}
.upside-warn{font-size:14px;font-weight:800;color:var(--yellow);}
.rr-val{font-weight:700;color:var(--blue);}

.w-bar-wrap{display:flex;align-items:center;gap:6px;}
.w-bar{height:5px;border-radius:3px;}
.wb-blue  {background:linear-gradient(90deg,#3b82f6,#60a5fa);}
.wb-yellow{background:linear-gradient(90deg,#d97706,#fbbf24);}
.wb-red   {background:linear-gradient(90deg,#dc2626,#f87171);}

/* editable */
.editable{
  background:transparent;border:1px solid transparent;
  border-radius:5px;padding:3px 6px;color:var(--text2);
  font-size:13px;font-family:'Inter',sans-serif;
  cursor:text;transition:all .15s;width:90px;
}
.editable:hover{border-color:var(--border2);}
.editable:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}

/* actions col */
.row-actions{display:flex;gap:4px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-actions{opacity:1;}
.row-btn{
  padding:4px 8px;border-radius:5px;font-size:11px;font-weight:600;
  cursor:pointer;border:none;transition:all .15s;
}
.row-btn-del{background:var(--red-bg);color:var(--red);}
.row-btn-del:hover{background:rgba(248,113,113,.25);}
.row-btn-hide{background:var(--bg4);color:var(--text3);}
.row-btn-hide:hover{background:var(--border2);color:var(--text2);}

/* empty state */
.empty-state{
  text-align:center;padding:40px 20px;color:var(--text3);
}
.empty-state .es-icon{font-size:32px;margin-bottom:8px;}
.empty-state p{font-size:13px;}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;
  z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;
}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{
  background:var(--bg2);border:1px solid var(--border2);
  border-radius:16px;padding:28px;width:100%;max-width:520px;
  max-height:90vh;overflow-y:auto;
  transform:translateY(20px);transition:transform .2s;
}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:17px;font-weight:800;color:#f1f5f9;margin-bottom:20px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-field{display:flex;flex-direction:column;gap:5px;}
.form-field.full{grid-column:1/-1;}
.form-field label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;}
.form-field input,.form-field select,.form-field textarea{
  background:var(--bg3);border:1px solid var(--border2);
  border-radius:8px;padding:9px 12px;color:var(--text);
  font-size:13px;font-family:'Inter',sans-serif;outline:none;
  transition:border-color .15s;
}
.form-field input:focus,.form-field select:focus,.form-field textarea:focus{border-color:var(--blue);}
.form-field select option{background:var(--bg3);}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}

/* â”€â”€ TOAST â”€â”€ */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:300;
  background:var(--bg3);border:1px solid var(--border2);border-radius:10px;
  padding:12px 18px;font-size:13px;font-weight:500;color:var(--text);
  transform:translateY(80px);opacity:0;transition:all .25s;
  display:flex;align-items:center;gap:8px;
}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green-border);color:var(--green);}
.toast.error{border-color:var(--red-border);color:var(--red);}

/* â”€â”€ TRADINGVIEW LINK â”€â”€ */
.tv-link{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 9px;border-radius:6px;
  background:rgba(41,98,255,.12);border:1px solid rgba(41,98,255,.3);
  color:#5b8af5;font-size:11px;font-weight:700;
  text-decoration:none;cursor:pointer;transition:all .15s;white-space:nowrap;
}
.tv-link:hover{background:rgba(41,98,255,.22);color:#7ba3ff;border-color:rgba(41,98,255,.5);}
.tv-icon{font-size:13px;}

/* â”€â”€ PRICE SIGNAL (semÃ¡foro) â”€â”€ */
.signal-wrap{display:flex;align-items:center;gap:7px;}
.signal-dot{
  width:10px;height:10px;border-radius:50%;flex-shrink:0;
  box-shadow:0 0 6px 2px currentColor;
}
.sig-green{background:#10b981;color:#10b981;}
.sig-yellow{background:#fbbf24;color:#fbbf24;}
.sig-red{background:#f87171;color:#f87171;}
.signal-pct{font-size:12px;font-weight:700;}
.signal-sub{font-size:10px;color:var(--text3);margin-top:1px;}

/* price input in table */
.price-input{
  background:transparent;border:1px solid transparent;
  border-radius:5px;padding:3px 6px;color:var(--text2);
  font-size:12px;font-family:'Inter',sans-serif;
  cursor:text;transition:all .15s;width:80px;
}
.price-input:hover{border-color:var(--border2);}
.price-input:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}
.price-input::placeholder{color:var(--text3);font-size:11px;}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:768px){
  .sidebar{display:none;}
  .content{padding:16px;}
  .form-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- TOP NAV -->
<nav class="topnav">
  <div class="logo">Portfolio<span>2026</span></div>
  <div class="nav-right">
    <button class="btn btn-ghost" onclick="toggleHidden()">ğŸ‘ Mostrar ocultas</button>
    <button class="btn btn-primary" onclick="openModal()">ï¼‹ Agregar posiciÃ³n</button>
  </div>
</nav>

<div class="main">

<!-- SIDEBAR FILTERS -->
<aside class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ” Buscar</div>
    <input class="search-box" type="text" placeholder="Ticker o empresa..." oninput="applyFilters()" id="searchInput"/>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ“‚ Capa</div>
    <div class="filter-group" id="layerFilters">
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','core')">
        <input type="checkbox" checked readonly/><span class="chip-label">ğŸ”µ Core</span><span class="chip-count" id="cnt-core">6</span>
      </label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','growth')">
        <input type="checkbox" checked readonly/><span class="chip-label">ğŸŸ¡ Growth</span><span class="chip-count" id="cnt-growth">7</span>
      </label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','special')">
        <input type="checkbox" checked readonly/><span class="chip-label">ğŸ”´ Special</span><span class="chip-count" id="cnt-special">2</span>
      </label>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ“ˆ Upside mÃ­nimo</div>
    <div class="range-group">
      <div class="range-item">
        <label>Upside: <span class="range-val" id="upsideVal">0%</span></label>
        <input type="range" min="0" max="140" value="0" id="upsideRange" oninput="document.getElementById('upsideVal').textContent=this.value+'%';applyFilters()"/>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-title">âš–ï¸ R/R mÃ­nimo</div>
    <div class="range-group">
      <div class="range-item">
        <label>Ratio: <span class="range-val" id="rrVal">0</span>:1</label>
        <input type="range" min="0" max="5" step="0.1" value="0" id="rrRange" oninput="document.getElementById('rrVal').textContent=parseFloat(this.value).toFixed(1);applyFilters()"/>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ’¼ Peso mÃ­nimo</div>
    <div class="range-group">
      <div class="range-item">
        <label>Peso: <span class="range-val" id="weightVal">0%</span></label>
        <input type="range" min="0" max="12" value="0" id="weightRange" oninput="document.getElementById('weightVal').textContent=this.value+'%';applyFilters()"/>
      </div>
    </div>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ¯ % bajo mÃ¡ximo</div>
    <div class="filter-group" id="dropFilters">
      <label class="filter-chip active" onclick="toggleFilter(this,'drop','lt15')">
        <input type="checkbox" checked readonly/><span class="chip-label">Menos de 15%</span>
      </label>
      <label class="filter-chip active" onclick="toggleFilter(this,'drop','15to30')">
        <input type="checkbox" checked readonly/><span class="chip-label">15% â€“ 30%</span>
      </label>
      <label class="filter-chip active" onclick="toggleFilter(this,'drop','gt30')">
        <input type="checkbox" checked readonly/><span class="chip-label">MÃ¡s de 30%</span>
      </label>
    </div>
  </div>

  <div class="sidebar-section">
    <button class="btn btn-ghost" style="width:100%" onclick="resetFilters()">â†º Resetear filtros</button>
  </div>
</aside>

<!-- MAIN CONTENT -->
<main class="content">

  <!-- HEADER -->
  <div class="page-header">
    <div class="header-top">
      <div>
        <div class="header-title">Watchlist Institucional 2026</div>
        <div class="header-sub">16 Feb 2026 Â· Blackrock Style Â· 15 posiciones Â· Actualizable en tiempo real</div>
        <div style="display:flex;gap:14px;margin-top:8px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:#94a3b8;">
            <div style="width:8px;height:8px;border-radius:50%;background:#f87171;box-shadow:0 0 5px #f87171"></div> SeÃ±al roja: precio &lt;3% sobre entrada
          </div>
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:#94a3b8;">
            <div style="width:8px;height:8px;border-radius:50%;background:#fbbf24;box-shadow:0 0 5px #fbbf24"></div> SeÃ±al amarilla: 3%â€“10% sobre entrada
          </div>
          <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:#94a3b8;">
            <div style="width:8px;height:8px;border-radius:50%;background:#10b981;box-shadow:0 0 5px #10b981"></div> SeÃ±al verde: &gt;10% sobre entrada
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="exportCSV()">â¬‡ Exportar CSV</button>
        <button class="btn btn-green" onclick="fetchPrices()">ğŸ”„ Actualizar precios</button>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:10px 14px;background:#0d1521;border:1px solid #1e293b;border-radius:10px;">
      <span style="font-size:13px;color:#64748b" id="lastUpdate">â³ Cargando precios desde Yahoo Finance...</span>
    </div>
    <div class="kpi-bar" id="kpiBar"></div>
  </div>

  <!-- CORE -->
  <div class="section" id="sec-core">
    <div class="section-header sh-core" onclick="toggleSection('core')">
      <span class="section-icon">ğŸ”µ</span>
      <div><div class="section-name">CAPA 1 â€” CORE HOLDINGS</div><div class="section-desc">Mayor convicciÃ³n Â· Menor volatilidad relativa</div></div>
      <span class="section-badge badge-blue" id="badge-core">50% Peso</span>
      <span class="chevron open" id="chev-core">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-core">
      <table><thead><tr>
        <th onclick="sortTable('core','ticker')">Ticker â‡…</th>
        <th onclick="sortTable('core','entry')">Entrada â‡…</th>
        <th onclick="sortTable('core','stop')">Stop Loss â‡…</th>
        <th onclick="sortTable('core','target')">Objetivo â‡…</th>
        <th onclick="sortTable('core','upside')">Upside â‡…</th>
        <th onclick="sortTable('core','rr')">R/R â‡…</th>
        <th onclick="sortTable('core','weight')">Peso â‡…</th>
        <th onclick="sortTable('core','drop')">% Bajo mÃ¡x. â‡…</th>
        <th>Precio actual</th>
        <th>ğŸš¦ SeÃ±al</th>
        <th>Catalizador</th>
        <th></th>
      </tr></thead>
      <tbody id="tbody-core"></tbody></table>
    </div>
  </div>

  <!-- GROWTH -->
  <div class="section" id="sec-growth">
    <div class="section-header sh-growth" onclick="toggleSection('growth')">
      <span class="section-icon">ğŸŸ¡</span>
      <div><div class="section-name">CAPA 2 â€” GROWTH HOLDINGS</div><div class="section-desc">Mayor upside Â· Volatilidad media-alta</div></div>
      <span class="section-badge badge-yellow" id="badge-growth">35% Peso</span>
      <span class="chevron open" id="chev-growth">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-growth">
      <table><thead><tr>
        <th onclick="sortTable('growth','ticker')">Ticker â‡…</th>
        <th onclick="sortTable('growth','entry')">Entrada â‡…</th>
        <th onclick="sortTable('growth','stop')">Stop Loss â‡…</th>
        <th onclick="sortTable('growth','target')">Objetivo â‡…</th>
        <th onclick="sortTable('growth','upside')">Upside â‡…</th>
        <th onclick="sortTable('growth','rr')">R/R â‡…</th>
        <th onclick="sortTable('growth','weight')">Peso â‡…</th>
        <th onclick="sortTable('growth','drop')">% Bajo mÃ¡x. â‡…</th>
        <th>Precio actual</th>
        <th>ğŸš¦ SeÃ±al</th>
        <th>Catalizador</th>
        <th></th>
      </tr></thead>
      <tbody id="tbody-growth"></tbody></table>
    </div>
  </div>

  <!-- SPECIAL -->
  <div class="section" id="sec-special">
    <div class="section-header sh-special" onclick="toggleSection('special')">
      <span class="section-icon">ğŸ”´</span>
      <div><div class="section-name">CAPA 3 â€” SPECIAL SITUATIONS</div><div class="section-desc">Alto riesgo Â· Retorno asimÃ©trico Â· Stop estricto</div></div>
      <span class="section-badge badge-red" id="badge-special">15% Peso</span>
      <span class="chevron open" id="chev-special">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-special">
      <table><thead><tr>
        <th onclick="sortTable('special','ticker')">Ticker â‡…</th>
        <th onclick="sortTable('special','entry')">Entrada â‡…</th>
        <th onclick="sortTable('special','stop')">Stop Loss â‡…</th>
        <th onclick="sortTable('special','target')">Objetivo â‡…</th>
        <th onclick="sortTable('special','upside')">Upside â‡…</th>
        <th onclick="sortTable('special','rr')">R/R â‡…</th>
        <th onclick="sortTable('special','weight')">Peso â‡…</th>
        <th onclick="sortTable('special','drop')">% Bajo mÃ¡x. â‡…</th>
        <th>Precio actual</th>
        <th>ğŸš¦ SeÃ±al</th>
        <th>Riesgo / Catalizador</th>
        <th></th>
      </tr></thead>
      <tbody id="tbody-special"></tbody></table>
    </div>
  </div>

</main>
</div>

<!-- ADD MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-title" id="modalTitle">ï¼‹ Nueva posiciÃ³n</div>
    <div class="form-grid">
      <div class="form-field">
        <label>Ticker *</label>
        <input id="f-ticker" placeholder="ej. AAPL" oninput="this.value=this.value.toUpperCase()"/>
      </div>
      <div class="form-field">
        <label>Empresa *</label>
        <input id="f-company" placeholder="ej. Apple Inc."/>
      </div>
      <div class="form-field">
        <label>Capa *</label>
        <select id="f-layer">
          <option value="core">ğŸ”µ Core</option>
          <option value="growth">ğŸŸ¡ Growth</option>
          <option value="special">ğŸ”´ Special Situation</option>
        </select>
      </div>
      <div class="form-field">
        <label>Color logo</label>
        <input id="f-color" type="color" value="#3b82f6" style="height:40px;cursor:pointer;"/>
      </div>
      <div class="form-field">
        <label>Entrada *</label>
        <input id="f-entry" placeholder="ej. $100â€“$110"/>
      </div>
      <div class="form-field">
        <label>Stop Loss *</label>
        <input id="f-stop" placeholder="ej. $85"/>
      </div>
      <div class="form-field">
        <label>Objetivo *</label>
        <input id="f-target" placeholder="ej. $150"/>
      </div>
      <div class="form-field">
        <label>Upside % *</label>
        <input id="f-upside" type="number" placeholder="ej. 50"/>
      </div>
      <div class="form-field">
        <label>Ratio R/R *</label>
        <input id="f-rr" type="number" step="0.1" placeholder="ej. 3.5"/>
      </div>
      <div class="form-field">
        <label>Peso % *</label>
        <input id="f-weight" type="number" placeholder="ej. 5"/>
      </div>
      <div class="form-field">
        <label>% bajo mÃ¡ximo *</label>
        <input id="f-drop" type="number" placeholder="ej. 25"/>
      </div>
      <div class="form-field">
        <label>Precio entrada bajo *</label>
        <input id="f-entrylow" type="number" step="0.01" placeholder="ej. 100"/>
      </div>
      <div class="form-field">
        <label>Precio actual</label>
        <input id="f-currentprice" type="number" step="0.01" placeholder="ej. 105"/>
      </div>
      <div class="form-field full">
        <label>Catalizador</label>
        <input id="f-catalyst" placeholder="ej. Revenue +50% YoY Â· Insiders comprando"/>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="savePosition()">Guardar posiciÃ³n</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let positions = [
  // CORE
  {id:1,layer:'core',ticker:'MSFT',company:'Microsoft',color:'#0078d4',entry:'$395â€“$410',stop:'$355',target:'$600',upside:49.6,rr:4.3,weight:10,drop:27.8,catalyst:'Azure AI Â· #1 compra Congreso',entryLow:395,currentPrice:401,hidden:false},
  {id:2,layer:'core',ticker:'GOOGL',company:'Alphabet',color:'#4285f4',entry:'$170â€“$182',stop:'$155',target:'$270',upside:51.7,rr:4.0,weight:10,drop:13.6,catalyst:'Cloud +48% YoY Â· Congresistas',entryLow:170,currentPrice:178,hidden:false},
  {id:3,layer:'core',ticker:'AVGO',company:'Broadcom',color:'#cc5500',entry:'$315â€“$335',stop:'$285',target:'$490',upside:50.8,rr:4.1,weight:8,drop:21.6,catalyst:'AI chips Â· MSFT/GOOGL/OpenAI',entryLow:315,currentPrice:325,hidden:false},
  {id:4,layer:'core',ticker:'SE',company:'Sea Limited',color:'#e91e63',entry:'$105â€“$115',stop:'$88',target:'$182',upside:67,rr:3.5,weight:7,drop:45.3,catalyst:'Shopee 52% ASEAN Â· FCF 7.2%',entryLow:105,currentPrice:109,hidden:false},
  {id:5,layer:'core',ticker:'PANW',company:'Palo Alto',color:'#00b4d8',entry:'$160â€“$172',stop:'$145',target:'$250',upside:49.7,rr:3.8,weight:7,drop:34.7,catalyst:'Ciberseg. Â· Pelosi $500Kâ€“$1M',entryLow:160,currentPrice:167,hidden:false},
  {id:6,layer:'core',ticker:'MU',company:'Micron',color:'#8b5cf6',entry:'$90â€“$100',stop:'$78',target:'$155',upside:63.2,rr:3.5,weight:8,drop:17,catalyst:'HBM3E para NVDA Â· Rev +57%',entryLow:90,currentPrice:95,hidden:false},
  // GROWTH
  {id:7,layer:'growth',ticker:'CRDO',company:'Credo Tech',color:'#f97316',entry:'$115â€“$130',stop:'$95',target:'$227',upside:84.6,rr:3.7,weight:6,drop:50,catalyst:'Conectividad AI Â· Rev +272%',entryLow:115,currentPrice:123,hidden:false},
  {id:8,layer:'growth',ticker:'DDOG',company:'Datadog',color:'#10b981',entry:'$120â€“$132',stop:'$100',target:'$185',upside:48,rr:2.4,weight:5,drop:38,catalyst:'NRR 120% Â· Multi-producto 84%',entryLow:120,currentPrice:125,hidden:false},
  {id:9,layer:'growth',ticker:'NET',company:'Cloudflare',color:'#f97316',entry:'$185â€“$205',stop:'$160',target:'$300',upside:53.1,rr:2.9,weight:5,drop:24.6,catalyst:'20% trÃ¡fico global Â· AI edge',entryLow:185,currentPrice:196,hidden:false},
  {id:10,layer:'growth',ticker:'APP',company:'AppLovin',color:'#6366f1',entry:'$370â€“$410',stop:'$310',target:'$670',upside:71.8,rr:3.5,weight:5,drop:47.7,catalyst:'EBITDA 84% Â· FCF +88% YoY',entryLow:370,currentPrice:390,hidden:false},
  {id:11,layer:'growth',ticker:'NBIS',company:'Nebius Group',color:'#0ea5e9',entry:'$90â€“$102',stop:'$72',target:'$164',upside:69.1,rr:2.7,weight:4,drop:31.3,catalyst:'Rev +355% Â· Contrato $17.4B',entryLow:90,currentPrice:97,hidden:false},
  {id:12,layer:'growth',ticker:'PLTR',company:'Palantir',color:'#8b5cf6',entry:'$125â€“$138',stop:'$105',target:'$207',upside:58,rr:2.9,weight:5,drop:36.9,catalyst:'DOGE + Gobierno Â· Com +121%',entryLow:125,currentPrice:131,hidden:false},
  {id:13,layer:'growth',ticker:'AMD',company:'Adv. Micro Dev.',color:'#ef4444',entry:'$100â€“$112',stop:'$85',target:'$175',upside:66.7,rr:3.5,weight:5,drop:40,catalyst:'Alt. NVDA Â· OpenAI partner',entryLow:100,currentPrice:105,hidden:false},
  // SPECIAL
  {id:14,layer:'special',ticker:'HIMS',company:'Hims & Hers',color:'#ec4899',entry:'$14â€“$17',stop:'$11',target:'$38',upside:137.5,rr:4.4,weight:3,drop:77.7,catalyst:'âš ï¸ Earnings 23 Feb Â· Riesgo reg.',entryLow:14,currentPrice:16,hidden:false},
  {id:15,layer:'special',ticker:'CRWV',company:'CoreWeave',color:'#14b8a6',entry:'$35â€“$42',stop:'$26',target:'$90',upside:136.8,rr:4.3,weight:2,drop:99,catalyst:'âš ï¸ AI cloud Â· Backlog $55B',entryLow:35,currentPrice:38,hidden:false},
];

let nextId = 16;
let activeFilters = {layer:['core','growth','special'],drop:['lt15','15to30','gt30']};
let showHidden = false;
let editId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADINGVIEW URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTVUrl(ticker){
  // Weekly chart with SMA 8,20,50,200 weekly + SMA 200 daily overlay
  // TradingView supports symbol and interval via URL params
  const symbol = encodeURIComponent('NASDAQ:'+ticker);
  // Fallback for non-NASDAQ tickers
  const nyseMap = {SE:'NYSE',PANW:'NASDAQ',MU:'NASDAQ',AVGO:'NASDAQ',MSFT:'NASDAQ',GOOGL:'NASDAQ',CRDO:'NASDAQ',DDOG:'NASDAQ',NET:'NYSE',APP:'NASDAQ',NBIS:'NASDAQ',PLTR:'NASDAQ',AMD:'NASDAQ',HIMS:'NYSE',CRWV:'NASDAQ'};
  const exchange = nyseMap[ticker] || 'NASDAQ';
  const sym = encodeURIComponent(exchange+':'+ticker);
  // interval=W for weekly, with studies for SMA 8,20,50,200
  return `https://www.tradingview.com/chart/?symbol=${sym}&interval=W&studies=MASimple%408%2CMASimple%4020%2CMASimple%4050%2CMASimple%40200%2CMASimple%40200D`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICE SIGNAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPriceSignal(currentPrice, entryLow){
  if(!currentPrice || !entryLow || entryLow<=0) return null;
  const pct = ((currentPrice - entryLow) / entryLow) * 100;
  return pct;
}

function renderSignal(p){
  const pct = getPriceSignal(p.currentPrice, p.entryLow);
  if(pct === null) return `<div style="color:var(--text3);font-size:11px">Sin precio</div>`;
  
  let sigClass, label, dotClass;
  if(pct < 3){
    sigClass='signal-pct'; dotClass='sig-red'; label = pct < 0 ? `${pct.toFixed(1)}%` : `+${pct.toFixed(1)}%`;
  } else if(pct <= 10){
    sigClass='signal-pct'; dotClass='sig-yellow'; label=`+${pct.toFixed(1)}%`;
  } else {
    sigClass='signal-pct'; dotClass='sig-green'; label=`+${pct.toFixed(1)}%`;
  }

  const color = dotClass==='sig-green'?'#10b981':dotClass==='sig-yellow'?'#fbbf24':'#f87171';
  return `
    <div class="signal-wrap">
      <div class="signal-dot ${dotClass}"></div>
      <div>
        <div class="signal-pct" style="color:${color}">${label}</div>
        <div class="signal-sub">vs entrada $${p.entryLow}</div>
      </div>
    </div>`;
}

function updatePrice(id, val){
  const p = positions.find(x=>x.id===id);
  if(p){ 
    p.currentPrice = parseFloat(val)||0;
    // re-render just that cell
    const cell = document.getElementById('sig-'+id);
    if(cell) cell.innerHTML = renderSignal(p);
  }
}
function render(){
  ['core','growth','special'].forEach(layer=>{
    const tbody = document.getElementById('tbody-'+layer);
    const layerPositions = positions.filter(p=>p.layer===layer);
    
    if(layerPositions.length===0){
      tbody.innerHTML=`<tr><td colspan="10"><div class="empty-state"><div class="es-icon">ğŸ“­</div><p>No hay posiciones en esta capa</p></div></td></tr>`;
      return;
    }

    tbody.innerHTML = layerPositions.map(p=>{
      const vis = isVisible(p);
      const dropClass = p.drop<15?'pill-blue':p.drop<30?'pill-yellow':'pill-red';
      const upClass = p.layer==='special'?'upside-warn':'upside-val';
      const wBarClass = layer==='core'?'wb-blue':layer==='growth'?'wb-yellow':'wb-red';
      const wBarW = Math.min(p.weight*6,72);
      const tvUrl = getTVUrl(p.ticker);
      return `<tr id="row-${p.id}" class="${p.hidden&&!showHidden?'hidden':''}${!vis?' hidden':''}">
        <td>
          <div class="ticker-cell">
            <div class="tlogo" style="background:${p.color}">${p.ticker.substring(0,4)}</div>
            <div>
              <div class="tfull">${p.ticker}</div>
              <div class="tname">${p.company}</div>
            </div>
          </div>
          <a href="${tvUrl}" target="_blank" class="tv-link" style="margin-top:5px;display:inline-flex" title="Ver en TradingView â€” Semanal + MM 8/20/50/200">
            <span class="tv-icon">ğŸ“ˆ</span> TradingView
          </a>
        </td>
        <td><input class="editable" value="${p.entry}" onchange="updateField(${p.id},'entry',this.value)"/></td>
        <td><span class="pill pill-red">${p.stop}</span></td>
        <td><span class="pill pill-green">${p.target}</span></td>
        <td><span class="${upClass}">+${p.upside}%</span></td>
        <td><span class="rr-val">${p.rr}:1</span></td>
        <td><div class="w-bar-wrap"><div class="w-bar ${wBarClass}" style="width:${wBarW}px"></div><span style="font-size:12px;font-weight:700;color:#94a3b8">${p.weight}%</span></div></td>
        <td><span class="pill ${dropClass}">âˆ’${p.drop}%</span></td>
        <td>
          <input class="price-input" type="number" step="0.01"
            value="${p.currentPrice||''}" 
            placeholder="Precio actual"
            onchange="updatePrice(${p.id},this.value)"
            title="IngresÃ¡ el precio actual del ticker"/>
        </td>
        <td id="sig-${p.id}">${renderSignal(p)}</td>
        <td style="max-width:200px;color:#94a3b8;font-size:12px">${p.catalyst}</td>
        <td><div class="row-actions">
          <button class="row-btn row-btn-hide" onclick="toggleHideRow(${p.id})" title="${p.hidden?'Mostrar':'Ocultar'}">${p.hidden?'ğŸ‘':'ğŸ™ˆ'}</button>
          <button class="row-btn row-btn-del" onclick="deleteRow(${p.id})" title="Eliminar">âœ•</button>
        </div></td>
      </tr>`;
    }).join('');
  });

  updateKPIs();
  updateCounts();
}

function isVisible(p){
  const search = document.getElementById('searchInput').value.toLowerCase();
  const minUpside = parseFloat(document.getElementById('upsideRange').value);
  const minRR = parseFloat(document.getElementById('rrRange').value);
  const minWeight = parseFloat(document.getElementById('weightRange').value);

  if(!activeFilters.layer.includes(p.layer)) return false;
  if(search && !p.ticker.toLowerCase().includes(search) && !p.company.toLowerCase().includes(search)) return false;
  if(p.upside < minUpside) return false;
  if(p.rr < minRR) return false;
  if(p.weight < minWeight) return false;

  const dropBucket = p.drop<15?'lt15':p.drop<=30?'15to30':'gt30';
  if(!activeFilters.drop.includes(dropBucket)) return false;

  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKPIs(){
  const vis = positions.filter(p=>isVisible(p)&&(!p.hidden||showHidden));
  const totalWeight = vis.reduce((a,p)=>a+p.weight,0);
  const avgUpside = vis.length ? (vis.reduce((a,p)=>a+p.upside,0)/vis.length).toFixed(1) : 0;
  const weightedUpside = totalWeight>0 ? (vis.reduce((a,p)=>a+(p.upside*p.weight),0)/totalWeight).toFixed(1) : 0;
  const avgRR = vis.length ? (vis.reduce((a,p)=>a+p.rr,0)/vis.length).toFixed(1) : 0;
  
  document.getElementById('kpiBar').innerHTML=`
    <div class="kpi-card"><div class="kpi-label">Posiciones visibles</div><div class="kpi-val" style="color:#60a5fa">${vis.length}</div><div class="kpi-sub">de ${positions.length} totales</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside ponderado</div><div class="kpi-val" style="color:#10b981">+${weightedUpside}%</div><div class="kpi-sub">por peso del portfolio</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside promedio</div><div class="kpi-val" style="color:#10b981">+${avgUpside}%</div><div class="kpi-sub">media simple</div></div>
    <div class="kpi-card"><div class="kpi-label">R/R promedio</div><div class="kpi-val" style="color:#60a5fa">${avgRR}:1</div><div class="kpi-sub">ponderado</div></div>
    <div class="kpi-card"><div class="kpi-label">Peso acumulado</div><div class="kpi-val" style="color:${totalWeight>100?'#f87171':'#fbbf24'}">${totalWeight}%</div><div class="kpi-sub">${totalWeight>100?'âš ï¸ Supera 100%':'del portfolio'}</div></div>
  `;
}

function updateCounts(){
  ['core','growth','special'].forEach(l=>{
    const el=document.getElementById('cnt-'+l);
    if(el) el.textContent=positions.filter(p=>p.layer===l&&(!p.hidden||showHidden)).length;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter(el, type, val){
  el.classList.toggle('active');
  el.querySelector('input').checked = el.classList.contains('active');
  const arr = activeFilters[type];
  const idx = arr.indexOf(val);
  if(idx>-1) arr.splice(idx,1); else arr.push(val);
  applyFilters();
}

function applyFilters(){ render(); }

function resetFilters(){
  activeFilters = {layer:['core','growth','special'],drop:['lt15','15to30','gt30']};
  document.querySelectorAll('.filter-chip').forEach(c=>{c.classList.add('active');c.querySelector('input').checked=true;});
  document.getElementById('upsideRange').value=0; document.getElementById('upsideVal').textContent='0%';
  document.getElementById('rrRange').value=0; document.getElementById('rrVal').textContent='0.0';
  document.getElementById('weightRange').value=0; document.getElementById('weightVal').textContent='0%';
  document.getElementById('searchInput').value='';
  render();
  showToast('â†º Filtros reseteados','');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECTIONS TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSection(layer){
  const tbl = document.getElementById('tbl-'+layer);
  const chev = document.getElementById('chev-'+layer);
  const open = tbl.style.display!=='none';
  tbl.style.display = open?'none':'block';
  chev.classList.toggle('open',!open);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT / DELETE / HIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateField(id, field, val){ 
  const p = positions.find(x=>x.id===id);
  if(p){ p[field]=val; updateKPIs(); }
}

function deleteRow(id){
  if(!confirm('Â¿Eliminar esta posiciÃ³n?')) return;
  positions = positions.filter(p=>p.id!==id);
  render();
  showToast('ğŸ—‘ PosiciÃ³n eliminada','error');
}

function toggleHideRow(id){
  const p = positions.find(x=>x.id===id);
  if(p){ p.hidden=!p.hidden; render(); }
}

function toggleHidden(){
  showHidden=!showHidden;
  document.querySelector('.btn-ghost').textContent = showHidden?'ğŸ‘ Ocultar ocultas':'ğŸ‘ Mostrar ocultas';
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sortState={col:null,asc:true};
function sortTable(layer, col){
  if(sortState.col===col) sortState.asc=!sortState.asc; else{sortState.col=col;sortState.asc=true;}
  const layerPos = positions.filter(p=>p.layer===layer);
  layerPos.sort((a,b)=>{
    let va=a[col],vb=b[col];
    if(typeof va==='string') return sortState.asc?va.localeCompare(vb):vb.localeCompare(va);
    return sortState.asc?va-vb:vb-va;
  });
  // reorder in main array
  positions = positions.filter(p=>p.layer!==layer).concat(layerPos);
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id=null){
  editId=id;
  document.getElementById('modalTitle').textContent = id?'âœï¸ Editar posiciÃ³n':'ï¼‹ Nueva posiciÃ³n';
  if(id){
    const p=positions.find(x=>x.id===id);
    document.getElementById('f-ticker').value=p.ticker;
    document.getElementById('f-company').value=p.company;
    document.getElementById('f-layer').value=p.layer;
    document.getElementById('f-color').value=p.color;
    document.getElementById('f-entry').value=p.entry;
    document.getElementById('f-stop').value=p.stop;
    document.getElementById('f-target').value=p.target;
    document.getElementById('f-upside').value=p.upside;
    document.getElementById('f-rr').value=p.rr;
    document.getElementById('f-weight').value=p.weight;
    document.getElementById('f-drop').value=p.drop;
    document.getElementById('f-entrylow').value=p.entryLow||'';
    document.getElementById('f-currentprice').value=p.currentPrice||'';
    document.getElementById('f-catalyst').value=p.catalyst;
  } else {
    ['ticker','company','entry','stop','target','upside','rr','weight','drop','catalyst','entrylow','currentprice'].forEach(f=>document.getElementById('f-'+f).value='');
    document.getElementById('f-layer').value='core';
    document.getElementById('f-color').value='#3b82f6';
  }
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal(){ document.getElementById('modalOverlay').classList.remove('open'); }
function closeModalOutside(e){ if(e.target.id==='modalOverlay') closeModal(); }

function savePosition(){
  const ticker=document.getElementById('f-ticker').value.trim();
  const company=document.getElementById('f-company').value.trim();
  if(!ticker||!company){ showToast('âš ï¸ Ticker y Empresa son obligatorios','error'); return; }
  
  const data={
    ticker, company,
    layer:document.getElementById('f-layer').value,
    color:document.getElementById('f-color').value,
    entry:document.getElementById('f-entry').value||'â€”',
    stop:document.getElementById('f-stop').value||'â€”',
    target:document.getElementById('f-target').value||'â€”',
    upside:parseFloat(document.getElementById('f-upside').value)||0,
    rr:parseFloat(document.getElementById('f-rr').value)||0,
    weight:parseFloat(document.getElementById('f-weight').value)||0,
    drop:parseFloat(document.getElementById('f-drop').value)||0,
    entryLow:parseFloat(document.getElementById('f-entrylow').value)||0,
    currentPrice:parseFloat(document.getElementById('f-currentprice').value)||0,
    catalyst:document.getElementById('f-catalyst').value||'â€”',
    hidden:false,
  };

  if(editId){
    const idx=positions.findIndex(p=>p.id===editId);
    positions[idx]={...positions[idx],...data};
    showToast('âœ… PosiciÃ³n actualizada','success');
  } else {
    positions.push({id:nextId++,...data});
    showToast('âœ… PosiciÃ³n agregada','success');
  }
  closeModal();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV(){
  const headers=['Ticker','Empresa','Capa','Entrada','Stop Loss','Objetivo','Upside%','R/R','Peso%','%BajoMax','Catalizador'];
  const rows=positions.map(p=>[p.ticker,p.company,p.layer,p.entry,p.stop,p.target,p.upside,p.rr,p.weight,p.drop,p.catalyst]);
  const csv=[headers,...rows].map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='portfolio_2026.csv';
  a.click();
  showToast('â¬‡ CSV descargado','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show '+(type||'');
  setTimeout(()=>t.classList.remove('show'),2800);
}

// â”€â”€ INIT â”€â”€
render();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YAHOO FINANCE â€” AUTO PRICE UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RAPIDAPI_KEY = '1f1a074f75msh519b89fd0e03c4ep172cc3jsnfe77f0a20dcd';
const RAPIDAPI_HOST = 'yahoo-finance15.p.rapidapi.com';

async function fetchPrices(){
  const tickers = positions.map(p=>p.ticker).join(',');
  const url = `https://yahoo-finance15.p.rapidapi.com/api/v1/markets/stock/quotes?ticker=${tickers}`;

  // Show loading state
  showToast('ğŸ”„ Actualizando precios desde Yahoo Finance...','');
  document.getElementById('lastUpdate').textContent = 'Actualizando...';

  try {
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'x-rapidapi-key': RAPIDAPI_KEY,
        'x-rapidapi-host': RAPIDAPI_HOST
      }
    });

    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    // Yahoo Finance returns body.body as array of quotes
    const quotes = data.body || data.quoteResponse?.result || [];

    let updated = 0;
    quotes.forEach(q => {
      const ticker = (q.symbol||q.ticker||'').replace(/\.[A-Z]+$/,'').toUpperCase();
      const price = parseFloat(q.regularMarketPrice || q.price || 0);
      if(!ticker || !price) return;

      const p = positions.find(x => x.ticker === ticker);
      if(p){
        p.currentPrice = Math.round(price * 100) / 100;
        updated++;
      }
    });

    render();

    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-AR', {hour:'2-digit',minute:'2-digit'});
    const dateStr = now.toLocaleDateString('es-AR', {day:'2-digit',month:'2-digit',year:'numeric'});
    document.getElementById('lastUpdate').textContent = `âœ… Actualizado: ${dateStr} ${timeStr} Â· ${updated}/${positions.length} tickers`;
    document.getElementById('lastUpdate').style.color = '#10b981';

    if(updated === 0){
      showToast('âš ï¸ Respuesta recibida pero sin precios. RevisÃ¡ la API key.','error');
    } else {
      showToast(`âœ… ${updated} precios actualizados correctamente`,'success');
    }

  } catch(err) {
    console.error('Yahoo Finance error:', err);
    document.getElementById('lastUpdate').textContent = `âŒ Error al actualizar: ${err.message}`;
    document.getElementById('lastUpdate').style.color = '#f87171';
    showToast('âŒ Error conectando con Yahoo Finance. RevisÃ¡ tu API key o el lÃ­mite de llamadas.','error');
  }
}

// Auto-fetch on load + every 5 minutes during market hours
fetchPrices();

function isMarketHours(){
  const now = new Date();
  const utcH = now.getUTCHours();
  const day = now.getUTCDay(); // 0=Sun, 6=Sat
  if(day===0||day===6) return false;
  // NYSE 9:30amâ€“4pm ET = 14:30â€“21:00 UTC
  const utcMin = now.getUTCHours()*60+now.getUTCMinutes();
  return utcMin >= 14*60+30 && utcMin <= 21*60;
}

setInterval(()=>{
  if(isMarketHours()) fetchPrices();
}, 5 * 60 * 1000); // every 5 min
</script>
</body>
</html>
