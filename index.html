<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Portfolio Institucional 2026</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#060a10;--bg2:#0d1521;--bg3:#111927;--bg4:#1a2332;
  --border:#1e293b;--border2:#2d3f55;
  --text:#e2e8f0;--text2:#94a3b8;--text3:#64748b;
  --green:#10b981;--green-bg:rgba(16,185,129,.12);--green-border:rgba(16,185,129,.25);
  --red:#f87171;--red-bg:rgba(248,113,113,.12);--red-border:rgba(248,113,113,.25);
  --yellow:#fbbf24;--yellow-bg:rgba(251,191,36,.12);--yellow-border:rgba(251,191,36,.25);
  --blue:#60a5fa;--blue-bg:rgba(96,165,250,.12);--blue-border:rgba(96,165,250,.25);
  --purple:#a78bfa;--purple-bg:rgba(167,139,250,.12);--purple-border:rgba(167,139,250,.25);
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* NAV */
.topnav{background:var(--bg2);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;}
.logo{font-size:15px;font-weight:800;letter-spacing:-0.5px;color:#f1f5f9;}
.logo span{color:var(--blue);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.btn-primary{background:var(--blue);color:#000;}
.btn-primary:hover{background:#93c5fd;}
.btn-ghost{background:var(--bg3);color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--bg4);color:var(--text);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.btn-green:hover{background:rgba(16,185,129,.22);}
.btn-purple{background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border);}
.btn-purple:hover{background:rgba(167,139,250,.22);}

/* LAYOUT */
.main{display:flex;min-height:calc(100vh - 53px);}
.sidebar{width:250px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:18px 14px;position:sticky;top:53px;height:calc(100vh - 53px);overflow-y:auto;}
.content{flex:1;padding:22px;overflow-x:auto;}

/* SIDEBAR */
.sidebar-section{margin-bottom:20px;}
.sidebar-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:10px;}
.filter-group{display:flex;flex-direction:column;gap:5px;}
.filter-chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;background:var(--bg3);border:1px solid var(--border);transition:all .15s;user-select:none;}
.filter-chip:hover{border-color:var(--border2);}
.filter-chip.active{border-color:var(--blue);background:var(--blue-bg);}
.filter-chip input[type=checkbox]{accent-color:var(--blue);width:13px;height:13px;flex-shrink:0;}
.filter-chip .chip-label{font-size:11px;font-weight:500;color:var(--text2);flex:1;}
.filter-chip.active .chip-label{color:var(--text);}
.chip-count{font-size:10px;font-weight:700;padding:1px 5px;border-radius:100px;background:var(--bg4);color:var(--text3);}
.range-item label{font-size:11px;color:var(--text3);display:block;margin-bottom:3px;}
.range-item input[type=range]{width:100%;accent-color:var(--blue);}
.range-val{font-size:11px;font-weight:700;color:var(--blue);float:right;}
.search-box{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-size:12px;font-family:'Inter',sans-serif;outline:none;transition:border-color .15s;}
.search-box:focus{border-color:var(--blue);}
.search-box::placeholder{color:var(--text3);}

/* PORTFOLIO SUMMARY CARD */
.portfolio-summary{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;
  margin-bottom:20px;padding:16px;
  background:linear-gradient(135deg,rgba(96,165,250,.06),rgba(167,139,250,.04));
  border:1px solid var(--border2);border-radius:14px;
}
.ps-title{grid-column:1/-1;font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.ps-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;}
.ps-label{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:5px;}
.ps-val{font-size:18px;font-weight:800;}
.ps-sub{font-size:10px;color:var(--text3);margin-top:2px;}

/* KPI bar */
.kpi-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 14px;flex:1;min-width:120px;}
.kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:5px;}
.kpi-val{font-size:18px;font-weight:800;}
.kpi-sub{font-size:10px;color:var(--text3);margin-top:2px;}

/* STATUS BAR */
.status-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:9px 14px;background:#0d1521;border:1px solid #1e293b;border-radius:10px;}
.legend{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:14px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:11px;color:#94a3b8;}
.leg-dot{width:8px;height:8px;border-radius:50%;}

/* SECTION */
.section{margin-bottom:28px;}
.section-header{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;user-select:none;}
.sh-core{background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(59,130,246,.06));border:1px solid rgba(59,130,246,.2);}
.sh-growth{background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(245,158,11,.06));border:1px solid rgba(245,158,11,.2);}
.sh-special{background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(239,68,68,.06));border:1px solid rgba(239,68,68,.2);}
.section-icon{font-size:18px;}
.section-name{font-size:14px;font-weight:800;color:#f1f5f9;}
.section-desc{font-size:11px;color:var(--text3);margin-top:1px;}
.section-badge{margin-left:auto;font-size:11px;font-weight:700;padding:3px 9px;border-radius:100px;}
.badge-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}
.badge-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.badge-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.chevron{margin-left:8px;font-size:11px;color:var(--text3);transition:transform .2s;}
.chevron.open{transform:rotate(180deg);}

/* TABLE */
.tbl-wrap{border:1px solid var(--border);border-radius:0 0 12px 12px;overflow:hidden;border-top:none;}
table{width:100%;border-collapse:collapse;min-width:1000px;}
thead th{background:var(--bg3);padding:8px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.7px;color:var(--text3);text-align:left;white-space:nowrap;cursor:pointer;user-select:none;}
thead th:hover{color:var(--text2);}
thead th.sorted-asc::after{content:' â–²';color:var(--blue);}
thead th.sorted-desc::after{content:' â–¼';color:var(--blue);}
thead th.sortable{color:var(--text2);}
tbody td{padding:10px 10px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);vertical-align:middle;}
tbody tr{transition:background .1s;}
tbody tr:hover td{background:var(--bg3);}
tbody tr.row-hidden{display:none;}

/* CELLS */
.ticker-cell{display:flex;align-items:center;gap:8px;}
.tlogo{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff;flex-shrink:0;}
.tname{font-size:10px;color:var(--text3);}
.tfull{font-size:12px;font-weight:700;color:#f1f5f9;}
.tv-link{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:5px;background:rgba(41,98,255,.12);border:1px solid rgba(41,98,255,.25);color:#5b8af5;font-size:10px;font-weight:700;text-decoration:none;margin-top:4px;white-space:nowrap;}
.tv-link:hover{background:rgba(41,98,255,.22);}

.pill{display:inline-block;padding:2px 7px;border-radius:100px;font-size:11px;font-weight:700;}
.pill-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.pill-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.pill-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.pill-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}

.signal-wrap{display:flex;align-items:center;gap:6px;}
.signal-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;box-shadow:0 0 7px 2px currentColor;}
.sig-green{background:#10b981;color:#10b981;}
.sig-yellow{background:#fbbf24;color:#fbbf24;}
.sig-red{background:#f87171;color:#f87171;}
.sig-none{background:#475569;color:#475569;box-shadow:none;}

.upside-val{font-size:13px;font-weight:800;color:var(--green);}
.upside-warn{font-size:13px;font-weight:800;color:var(--yellow);}
.rr-val{font-weight:700;color:var(--blue);}
.w-bar-wrap{display:flex;align-items:center;gap:5px;}
.w-bar{height:4px;border-radius:3px;}
.wb-blue{background:linear-gradient(90deg,#3b82f6,#60a5fa);}
.wb-yellow{background:linear-gradient(90deg,#d97706,#fbbf24);}
.wb-red{background:linear-gradient(90deg,#dc2626,#f87171);}

.editable{background:transparent;border:1px solid transparent;border-radius:5px;padding:2px 5px;color:var(--text2);font-size:12px;font-family:'Inter',sans-serif;cursor:text;transition:all .15s;width:85px;}
.editable:hover{border-color:var(--border2);}
.editable:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}
.price-input{background:transparent;border:1px solid transparent;border-radius:5px;padding:2px 5px;color:var(--text2);font-size:12px;font-family:'Inter',sans-serif;cursor:text;transition:all .15s;width:75px;}
.price-input:hover{border-color:var(--border2);}
.price-input:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}

/* PURCHASES */
.purchases-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border);cursor:pointer;margin-top:3px;}
.purchases-badge:hover{background:rgba(167,139,250,.2);}
.avg-price{font-size:11px;font-weight:700;color:var(--purple);}
.avg-sub{font-size:10px;color:var(--text3);}
.pnl-pos{color:var(--green);font-weight:700;}
.pnl-neg{color:var(--red);font-weight:700;}

/* ROW ACTIONS */
.row-actions{display:flex;gap:3px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-actions{opacity:1;}
.row-btn{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.row-btn-del{background:var(--red-bg);color:var(--red);}
.row-btn-del:hover{background:rgba(248,113,113,.25);}
.row-btn-hide{background:var(--bg4);color:var(--text3);}
.row-btn-hide:hover{background:var(--border2);color:var(--text2);}
.row-btn-buy{background:var(--purple-bg);color:var(--purple);}
.row-btn-buy:hover{background:rgba(167,139,250,.22);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:24px;width:100%;max-width:560px;max-height:92vh;overflow-y:auto;transform:translateY(20px);transition:transform .2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:16px;font-weight:800;color:#f1f5f9;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-field{display:flex;flex-direction:column;gap:4px;}
.form-field.full{grid-column:1/-1;}
.form-field label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;}
.form-field input,.form-field select,.form-field textarea{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:8px 11px;color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .15s;}
.form-field input:focus,.form-field select:focus{border-color:var(--blue);}
.form-field select option{background:var(--bg3);}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;}
.modal-divider{grid-column:1/-1;border:none;border-top:1px solid var(--border);margin:4px 0;}

/* PURCHASES MODAL */
.purchase-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;max-height:280px;overflow-y:auto;}
.purchase-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;}
.purchase-item-info{flex:1;}
.purchase-date{font-size:10px;color:var(--text3);}
.purchase-detail{font-size:12px;font-weight:700;color:var(--text);}
.purchase-pnl{font-size:11px;font-weight:700;text-align:right;}
.del-purchase{background:var(--red-bg);color:var(--red);border:none;border-radius:5px;padding:3px 8px;font-size:11px;cursor:pointer;}
.del-purchase:hover{background:rgba(248,113,113,.25);}
.purchase-summary{padding:12px 14px;background:var(--bg4);border-radius:10px;margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.ps-item label{font-size:10px;color:var(--text3);display:block;text-transform:uppercase;letter-spacing:.5px;}
.ps-item span{font-size:14px;font-weight:800;}
.add-purchase-form{background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.add-purchase-form label{font-size:10px;color:var(--text3);display:block;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}
.add-purchase-form input{background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px 9px;color:var(--text);font-size:12px;font-family:'Inter',sans-serif;outline:none;width:100%;}
.add-purchase-form input:focus{border-color:var(--blue);}
.add-purchase-form .full{grid-column:1/-1;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:300;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:11px 16px;font-size:12px;font-weight:600;color:var(--text);transform:translateY(80px);opacity:0;transition:all .25s;display:flex;align-items:center;gap:8px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green-border);color:var(--green);}
.toast.error{border-color:var(--red-border);color:var(--red);}

.empty-state{text-align:center;padding:32px 20px;color:var(--text3);}

@media(max-width:800px){.sidebar{display:none;}.content{padding:14px;}.form-grid{grid-template-columns:1fr;}.portfolio-summary{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<nav class="topnav">
  <div class="logo">Portfolio<span>2026</span></div>
  <div class="nav-right">
    <button class="btn btn-ghost" id="btnToggleHidden" onclick="toggleHidden()">ğŸ‘ Mostrar ocultas</button>
    <button class="btn btn-green" onclick="fetchPrices()">ğŸ”„ Actualizar precios</button>
    <button class="btn btn-ghost" onclick="exportCSV()">â¬‡ CSV</button>
    <button class="btn btn-primary" onclick="openPositionModal()">ï¼‹ Agregar posiciÃ³n</button>
  </div>
</nav>

<div class="main">
<aside class="sidebar">
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ” Buscar</div>
    <input class="search-box" type="text" placeholder="Ticker o empresa..." oninput="applyFilters()" id="searchInput"/>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ“‚ Capa</div>
    <div class="filter-group">
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','core')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸ”µ Core</span><span class="chip-count" id="cnt-core">6</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','growth')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸŸ¡ Growth</span><span class="chip-count" id="cnt-growth">7</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','special')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸ”´ Special</span><span class="chip-count" id="cnt-special">2</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸš¦ SeÃ±al</div>
    <div class="filter-group">
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','green')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸŸ¢ Verde (&gt;10%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','yellow')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸŸ¡ Amarillo (3â€“10%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','red')"><input type="checkbox" checked readonly/><span class="chip-label">ğŸ”´ Rojo (&lt;3%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','none')"><input type="checkbox" checked readonly/><span class="chip-label">âšª Sin precio</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ“ˆ Upside mÃ­nimo</div>
    <div class="range-item"><label>Upside: <span class="range-val" id="upsideVal">0%</span></label><input type="range" min="0" max="140" value="0" id="upsideRange" oninput="document.getElementById('upsideVal').textContent=this.value+'%';applyFilters()"/></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">âš–ï¸ R/R mÃ­nimo</div>
    <div class="range-item"><label>Ratio: <span class="range-val" id="rrVal">0.0</span>:1</label><input type="range" min="0" max="5" step="0.1" value="0" id="rrRange" oninput="document.getElementById('rrVal').textContent=parseFloat(this.value).toFixed(1);applyFilters()"/></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">ğŸ’¼ Solo con compras</div>
    <div class="filter-group">
      <label class="filter-chip" id="chip-withbuys" onclick="toggleBuyFilter(this)"><input type="checkbox" readonly/><span class="chip-label">ğŸ’œ Con compras reales</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <button class="btn btn-ghost" style="width:100%" onclick="resetFilters()">â†º Resetear filtros</button>
  </div>
</aside>

<main class="content">

  <!-- PORTFOLIO SUMMARY -->
  <div class="portfolio-summary" id="portfolioSummary">
    <div class="ps-title">ğŸ’¼ RESUMEN DEL PORTFOLIO REAL</div>
    <div class="ps-card"><div class="ps-label">Capital invertido</div><div class="ps-val" id="ps-invested" style="color:var(--blue)">$0</div><div class="ps-sub" id="ps-positions-count">0 posiciones con compras</div></div>
    <div class="ps-card"><div class="ps-label">Valor actual</div><div class="ps-val" id="ps-current" style="color:var(--text)">$0</div><div class="ps-sub">a precios de hoy</div></div>
    <div class="ps-card"><div class="ps-label">P&L total</div><div class="ps-val" id="ps-pnl">$0</div><div class="ps-sub" id="ps-pnl-pct">0.00%</div></div>
    <div class="ps-card"><div class="ps-label">Rendimiento anual</div><div class="ps-val" id="ps-annual">â€”</div><div class="ps-sub" id="ps-annual-sub">dÃ­as desde primer compra</div></div>
    <div class="ps-card"><div class="ps-label">Mejor posiciÃ³n</div><div class="ps-val" id="ps-best" style="color:var(--green)">â€”</div><div class="ps-sub" id="ps-best-sub"></div></div>
    <div class="ps-card"><div class="ps-label">Peor posiciÃ³n</div><div class="ps-val" id="ps-worst" style="color:var(--red)">â€”</div><div class="ps-sub" id="ps-worst-sub"></div></div>
  </div>

  <!-- HEADER -->
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="background:#f87171;box-shadow:0 0 4px #f87171"></div>Rojo: &lt;3% sobre entrada</div>
    <div class="leg-item"><div class="leg-dot" style="background:#fbbf24;box-shadow:0 0 4px #fbbf24"></div>Amarillo: 3â€“10%</div>
    <div class="leg-item"><div class="leg-dot" style="background:#10b981;box-shadow:0 0 4px #10b981"></div>Verde: &gt;10%</div>
    <div class="leg-item" style="margin-left:auto;font-size:10px;color:var(--text3)">ğŸ’œ Click en ticker para registrar compras</div>
  </div>

  <div class="status-bar">
    <span style="font-size:12px;color:var(--text3)" id="lastUpdate">â³ Cargando precios desde Stooq...</span>
  </div>

  <div class="kpi-bar" id="kpiBar"></div>

  <!-- CORE -->
  <div class="section">
    <div class="section-header sh-core" onclick="toggleSection('core')">
      <span class="section-icon">ğŸ”µ</span>
      <div><div class="section-name">CAPA 1 â€” CORE HOLDINGS</div><div class="section-desc">Mayor convicciÃ³n Â· Menor volatilidad</div></div>
      <span class="section-badge badge-blue">50% Peso</span>
      <span class="chevron open" id="chev-core">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-core">
      <table><thead id="thead-core"><tr></tr></thead><tbody id="tbody-core"></tbody></table>
    </div>
  </div>

  <!-- GROWTH -->
  <div class="section">
    <div class="section-header sh-growth" onclick="toggleSection('growth')">
      <span class="section-icon">ğŸŸ¡</span>
      <div><div class="section-name">CAPA 2 â€” GROWTH HOLDINGS</div><div class="section-desc">Mayor upside Â· Volatilidad media-alta</div></div>
      <span class="section-badge badge-yellow">35% Peso</span>
      <span class="chevron open" id="chev-growth">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-growth">
      <table><thead id="thead-growth"><tr></tr></thead><tbody id="tbody-growth"></tbody></table>
    </div>
  </div>

  <!-- SPECIAL -->
  <div class="section">
    <div class="section-header sh-special" onclick="toggleSection('special')">
      <span class="section-icon">ğŸ”´</span>
      <div><div class="section-name">CAPA 3 â€” SPECIAL SITUATIONS</div><div class="section-desc">Alto riesgo Â· Retorno asimÃ©trico</div></div>
      <span class="section-badge badge-red">15% Peso</span>
      <span class="chevron open" id="chev-special">â–¼</span>
    </div>
    <div class="tbl-wrap" id="tbl-special">
      <table><thead id="thead-special"><tr></tr></thead><tbody id="tbody-special"></tbody></table>
    </div>
  </div>

</main>
</div>

<!-- POSITION MODAL -->
<div class="modal-overlay" id="positionModal" onclick="closeModalOutside(event,'positionModal')">
  <div class="modal">
    <div class="modal-title" id="posModalTitle">ï¼‹ Nueva posiciÃ³n</div>
    <div class="form-grid">
      <div class="form-field"><label>Ticker *</label><input id="f-ticker" placeholder="ej. AAPL" oninput="this.value=this.value.toUpperCase()"/></div>
      <div class="form-field"><label>Empresa *</label><input id="f-company" placeholder="ej. Apple Inc."/></div>
      <div class="form-field"><label>Capa *</label><select id="f-layer"><option value="core">ğŸ”µ Core</option><option value="growth">ğŸŸ¡ Growth</option><option value="special">ğŸ”´ Special</option></select></div>
      <div class="form-field"><label>Color logo</label><input id="f-color" type="color" value="#3b82f6" style="height:38px;cursor:pointer;"/></div>
      <div class="form-field"><label>Entrada</label><input id="f-entry" placeholder="ej. $100â€“$110"/></div>
      <div class="form-field"><label>Stop Loss</label><input id="f-stop" placeholder="ej. $85"/></div>
      <div class="form-field"><label>Objetivo</label><input id="f-target" placeholder="ej. $150"/></div>
      <div class="form-field"><label>Upside %</label><input id="f-upside" type="number" placeholder="ej. 50"/></div>
      <div class="form-field"><label>Ratio R/R</label><input id="f-rr" type="number" step="0.1" placeholder="ej. 3.5"/></div>
      <div class="form-field"><label>Peso %</label><input id="f-weight" type="number" placeholder="ej. 5"/></div>
      <div class="form-field"><label>% bajo mÃ¡ximo</label><input id="f-drop" type="number" placeholder="ej. 25"/></div>
      <div class="form-field"><label>Precio entrada bajo $</label><input id="f-entrylow" type="number" step="0.01" placeholder="ej. 100"/></div>
      <div class="form-field full"><label>Catalizador</label><input id="f-catalyst" placeholder="ej. Revenue +50% YoY Â· Insiders comprando"/></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('positionModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="savePosition()">Guardar posiciÃ³n</button>
    </div>
  </div>
</div>

<!-- PURCHASES MODAL -->
<div class="modal-overlay" id="purchasesModal" onclick="closeModalOutside(event,'purchasesModal')">
  <div class="modal" style="max-width:580px;">
    <div class="modal-title" id="purchModalTitle">ğŸ’œ Compras â€” MSFT</div>

    <!-- Summary -->
    <div class="purchase-summary" id="purchSummary">
      <div class="ps-item"><label>Precio promedio</label><span id="purch-avg">â€”</span></div>
      <div class="ps-item"><label>Total invertido</label><span id="purch-total">â€”</span></div>
      <div class="ps-item"><label>P&L actual</label><span id="purch-pnl">â€”</span></div>
    </div>

    <!-- List -->
    <div class="purchase-list" id="purchaseList"></div>

    <!-- Add form -->
    <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">â• Registrar nueva compra</div>
    <div class="add-purchase-form">
      <div>
        <label>Fecha *</label>
        <input type="date" id="purch-date"/>
      </div>
      <div>
        <label>Precio compra $ *</label>
        <input type="number" step="0.01" id="purch-price" placeholder="ej. 398.50"/>
      </div>
      <div>
        <label>Cantidad *</label>
        <input type="number" step="1" id="purch-qty" placeholder="ej. 10"/>
      </div>
      <div class="full" style="margin-top:4px;">
        <button class="btn btn-purple" style="width:100%" onclick="addPurchase()">ğŸ’œ Registrar compra</button>
      </div>
    </div>

    <div class="modal-footer" style="margin-top:12px;">
      <button class="btn btn-ghost" onclick="closeModal('purchasesModal')">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let positions = [
  {id:1,layer:'core',ticker:'MSFT',company:'Microsoft',color:'#0078d4',entry:'$395â€“$410',stop:'$355',target:'$600',upside:49.6,rr:4.3,weight:10,drop:27.8,catalyst:'Azure AI Â· #1 compra Congreso',entryLow:395,currentPrice:0,hidden:false},
  {id:2,layer:'core',ticker:'GOOGL',company:'Alphabet',color:'#4285f4',entry:'$170â€“$182',stop:'$155',target:'$270',upside:51.7,rr:4.0,weight:10,drop:13.6,catalyst:'Cloud +48% YoY Â· Congresistas',entryLow:170,currentPrice:0,hidden:false},
  {id:3,layer:'core',ticker:'AVGO',company:'Broadcom',color:'#cc5500',entry:'$315â€“$335',stop:'$285',target:'$490',upside:50.8,rr:4.1,weight:8,drop:21.6,catalyst:'AI chips Â· MSFT/GOOGL/OpenAI',entryLow:315,currentPrice:0,hidden:false},
  {id:4,layer:'core',ticker:'SE',company:'Sea Limited',color:'#e91e63',entry:'$105â€“$115',stop:'$88',target:'$182',upside:67,rr:3.5,weight:7,drop:45.3,catalyst:'Shopee 52% ASEAN Â· FCF 7.2%',entryLow:105,currentPrice:0,hidden:false},
  {id:5,layer:'core',ticker:'PANW',company:'Palo Alto',color:'#00b4d8',entry:'$160â€“$172',stop:'$145',target:'$250',upside:49.7,rr:3.8,weight:7,drop:34.7,catalyst:'Ciberseg. Â· Pelosi $500Kâ€“$1M',entryLow:160,currentPrice:0,hidden:false},
  {id:6,layer:'core',ticker:'MU',company:'Micron',color:'#8b5cf6',entry:'$90â€“$100',stop:'$78',target:'$155',upside:63.2,rr:3.5,weight:8,drop:17,catalyst:'HBM3E para NVDA Â· Rev +57%',entryLow:90,currentPrice:0,hidden:false},
  {id:7,layer:'growth',ticker:'CRDO',company:'Credo Tech',color:'#f97316',entry:'$115â€“$130',stop:'$95',target:'$227',upside:84.6,rr:3.7,weight:6,drop:50,catalyst:'Conectividad AI Â· Rev +272%',entryLow:115,currentPrice:0,hidden:false},
  {id:8,layer:'growth',ticker:'DDOG',company:'Datadog',color:'#10b981',entry:'$120â€“$132',stop:'$100',target:'$185',upside:48,rr:2.4,weight:5,drop:38,catalyst:'NRR 120% Â· Multi-producto 84%',entryLow:120,currentPrice:0,hidden:false},
  {id:9,layer:'growth',ticker:'NET',company:'Cloudflare',color:'#f97316',entry:'$185â€“$205',stop:'$160',target:'$300',upside:53.1,rr:2.9,weight:5,drop:24.6,catalyst:'20% trÃ¡fico global Â· AI edge',entryLow:185,currentPrice:0,hidden:false},
  {id:10,layer:'growth',ticker:'APP',company:'AppLovin',color:'#6366f1',entry:'$370â€“$410',stop:'$310',target:'$670',upside:71.8,rr:3.5,weight:5,drop:47.7,catalyst:'EBITDA 84% Â· FCF +88% YoY',entryLow:370,currentPrice:0,hidden:false},
  {id:11,layer:'growth',ticker:'NBIS',company:'Nebius Group',color:'#0ea5e9',entry:'$90â€“$102',stop:'$72',target:'$164',upside:69.1,rr:2.7,weight:4,drop:31.3,catalyst:'Rev +355% Â· Contrato $17.4B',entryLow:90,currentPrice:0,hidden:false},
  {id:12,layer:'growth',ticker:'PLTR',company:'Palantir',color:'#8b5cf6',entry:'$125â€“$138',stop:'$105',target:'$207',upside:58,rr:2.9,weight:5,drop:36.9,catalyst:'DOGE + Gobierno Â· Com +121%',entryLow:125,currentPrice:0,hidden:false},
  {id:13,layer:'growth',ticker:'AMD',company:'Adv. Micro Dev.',color:'#ef4444',entry:'$100â€“$112',stop:'$85',target:'$175',upside:66.7,rr:3.5,weight:5,drop:40,catalyst:'Alt. NVDA Â· OpenAI partner',entryLow:100,currentPrice:0,hidden:false},
  {id:14,layer:'special',ticker:'HIMS',company:'Hims & Hers',color:'#ec4899',entry:'$14â€“$17',stop:'$11',target:'$38',upside:137.5,rr:4.4,weight:3,drop:77.7,catalyst:'âš ï¸ Earnings 23 Feb Â· Riesgo reg.',entryLow:14,currentPrice:0,hidden:false},
  {id:15,layer:'special',ticker:'CRWV',company:'CoreWeave',color:'#14b8a6',entry:'$35â€“$42',stop:'$26',target:'$90',upside:136.8,rr:4.3,weight:2,drop:99,catalyst:'âš ï¸ AI cloud Â· Backlog $55B',entryLow:35,currentPrice:0,hidden:false},
];

// purchases: { [positionId]: [{date, price, qty}] }
let purchases = {};

let nextId = 16;
let activeFilters = {layer:['core','growth','special'], signal:['green','yellow','red','none']};
let showHidden = false;
let filterWithBuys = false;
let editId = null;
let activePurchaseId = null;

// Sort state per layer
let sortStates = {core:{col:'signal',asc:false}, growth:{col:'signal',asc:false}, special:{col:'signal',asc:false}};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSignalPct(p) {
  if (!p.currentPrice || !p.entryLow || p.entryLow <= 0) return null;
  return ((p.currentPrice - p.entryLow) / p.entryLow) * 100;
}
function getSignalBucket(p) {
  const pct = getSignalPct(p);
  if (pct === null) return 'none';
  if (pct < 3) return 'red';
  if (pct <= 10) return 'yellow';
  return 'green';
}
function renderSignalCell(p) {
  const pct = getSignalPct(p);
  if (pct === null) return `<div class="signal-wrap"><div class="signal-dot sig-none"></div><span style="font-size:11px;color:var(--text3)">Sin precio</span></div>`;
  const bucket = getSignalBucket(p);
  const dotClass = bucket === 'green' ? 'sig-green' : bucket === 'yellow' ? 'sig-yellow' : 'sig-red';
  const color = bucket === 'green' ? '#10b981' : bucket === 'yellow' ? '#fbbf24' : '#f87171';
  const label = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
  return `<div class="signal-wrap"><div class="signal-dot ${dotClass}"></div><div><div style="font-size:12px;font-weight:800;color:${color}">${label}</div><div style="font-size:10px;color:var(--text3)">vs $${p.entryLow}</div></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PURCHASES HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPurchases(id) { return purchases[id] || []; }
function getAvgPrice(id) {
  const list = getPurchases(id);
  if (!list.length) return null;
  const totalQty = list.reduce((a,b) => a + b.qty, 0);
  const totalCost = list.reduce((a,b) => a + b.price * b.qty, 0);
  return totalQty > 0 ? totalCost / totalQty : null;
}
function getTotalInvested(id) {
  return getPurchases(id).reduce((a,b) => a + b.price * b.qty, 0);
}
function getTotalQty(id) {
  return getPurchases(id).reduce((a,b) => a + b.qty, 0);
}
function getEarliestDate(id) {
  const list = getPurchases(id);
  if (!list.length) return null;
  return list.reduce((a,b) => a < b.date ? a : b.date, list[0].date);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PORTFOLIO SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePortfolioSummary() {
  let totalInvested = 0, totalCurrent = 0;
  let posWithBuys = 0;
  let bestPct = -Infinity, worstPct = Infinity;
  let bestTicker = 'â€”', worstTicker = 'â€”';
  let earliestDate = null;

  positions.forEach(p => {
    const list = getPurchases(p.id);
    if (!list.length) return;
    posWithBuys++;
    const invested = getTotalInvested(p.id);
    const qty = getTotalQty(p.id);
    const currentVal = p.currentPrice ? p.currentPrice * qty : invested;
    totalInvested += invested;
    totalCurrent += currentVal;
    if (p.currentPrice) {
      const pnlPct = ((currentVal - invested) / invested) * 100;
      if (pnlPct > bestPct) { bestPct = pnlPct; bestTicker = p.ticker; }
      if (pnlPct < worstPct) { worstPct = pnlPct; worstTicker = p.ticker; }
    }
    const ed = getEarliestDate(p.id);
    if (ed && (!earliestDate || ed < earliestDate)) earliestDate = ed;
  });

  const pnl = totalCurrent - totalInvested;
  const pnlPct = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;
  const pnlColor = pnl >= 0 ? '#10b981' : '#f87171';

  document.getElementById('ps-invested').textContent = '$' + fmt(totalInvested);
  document.getElementById('ps-positions-count').textContent = posWithBuys + ' posiciÃ³n' + (posWithBuys !== 1 ? 'es' : '') + ' con compras';
  document.getElementById('ps-current').textContent = '$' + fmt(totalCurrent);

  const pnlEl = document.getElementById('ps-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + fmt(Math.abs(pnl));
  pnlEl.style.color = pnlColor;
  const pnlPctEl = document.getElementById('ps-pnl-pct');
  pnlPctEl.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
  pnlPctEl.style.color = pnlColor;

  // Annual return
  if (earliestDate && totalInvested > 0) {
    const days = Math.max(1, (new Date() - new Date(earliestDate)) / 86400000);
    const annualReturn = (Math.pow(totalCurrent / totalInvested, 365 / days) - 1) * 100;
    const arEl = document.getElementById('ps-annual');
    arEl.textContent = (annualReturn >= 0 ? '+' : '') + annualReturn.toFixed(1) + '%';
    arEl.style.color = annualReturn >= 0 ? '#10b981' : '#f87171';
    document.getElementById('ps-annual-sub').textContent = Math.round(days) + ' dÃ­as activo';
  } else {
    document.getElementById('ps-annual').textContent = 'â€”';
    document.getElementById('ps-annual-sub').textContent = 'Sin compras registradas';
  }

  const bestEl = document.getElementById('ps-best');
  bestEl.textContent = bestPct === -Infinity ? 'â€”' : bestTicker + ' ' + (bestPct >= 0 ? '+' : '') + bestPct.toFixed(1) + '%';
  document.getElementById('ps-best-sub').textContent = bestPct === -Infinity ? '' : 'mejor posiciÃ³n';
  const worstEl = document.getElementById('ps-worst');
  worstEl.textContent = worstPct === Infinity ? 'â€”' : worstTicker + ' ' + (worstPct >= 0 ? '+' : '') + worstPct.toFixed(1) + '%';
  document.getElementById('ps-worst-sub').textContent = worstPct === Infinity ? '' : 'peor posiciÃ³n';
}

function fmt(n) {
  if (n >= 1000000) return (n/1000000).toFixed(2) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return n.toFixed(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADINGVIEW URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTVUrl(ticker) {
  const ex = {SE:'NYSE', NET:'NYSE', HIMS:'NYSE'};
  const exchange = ex[ticker] || 'NASDAQ';
  const sym = encodeURIComponent(exchange + ':' + ticker);
  return `https://www.tradingview.com/chart/?symbol=${sym}&interval=W&studies=MASimple%408%2CMASimple%4020%2CMASimple%4050%2CMASimple%40200`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLS = [
  {key:'ticker',  label:'Ticker',       sortable:true},
  {key:'signal',  label:'ğŸš¦ SeÃ±al',     sortable:true},
  {key:'currentPrice', label:'Precio actual', sortable:true},
  {key:'entryLow',label:'P. Entrada',   sortable:true},
  {key:'compras', label:'ğŸ’œ Compras',   sortable:false},
  {key:'entry',   label:'Rango entrada',sortable:false},
  {key:'stop',    label:'Stop Loss',    sortable:false},
  {key:'target',  label:'Objetivo',     sortable:false},
  {key:'upside',  label:'Upside',       sortable:true},
  {key:'rr',      label:'R/R',          sortable:true},
  {key:'weight',  label:'Peso',         sortable:true},
  {key:'drop',    label:'% Bajo mÃ¡x.',  sortable:true},
  {key:'catalyst',label:'Catalizador',  sortable:false},
  {key:'actions', label:'',             sortable:false},
];

function buildHeader(layer) {
  const ss = sortStates[layer];
  const th = document.querySelector(`#thead-${layer} tr`);
  th.innerHTML = COLS.map(c => {
    let cls = c.sortable ? 'sortable' : '';
    if (ss.col === c.key) cls += ss.asc ? ' sorted-asc' : ' sorted-desc';
    const onclick = c.sortable ? `onclick="sortTable('${layer}','${c.key}')"` : '';
    return `<th class="${cls}" ${onclick}>${c.label}</th>`;
  }).join('');
}

function sortValue(p, col) {
  if (col === 'signal') { const v = getSignalPct(p); return v === null ? -9999 : v; }
  if (col === 'ticker') return p.ticker;
  return p[col] ?? 0;
}

function renderRow(p, layer) {
  const vis = isVisible(p);
  const hidden = (p.hidden && !showHidden) || !vis;
  const wc = layer==='core'?'wb-blue':layer==='growth'?'wb-yellow':'wb-red';
  const dc = p.drop<15?'pill-blue':p.drop<30?'pill-yellow':'pill-red';
  const uc = p.layer==='special'?'upside-warn':'upside-val';
  const tvUrl = getTVUrl(p.ticker);

  // purchases badge
  const pList = getPurchases(p.id);
  const avg = getAvgPrice(p.id);
  const qty = getTotalQty(p.id);
  let purchasesCell = '';
  if (pList.length) {
    const invested = getTotalInvested(p.id);
    let pnlHtml = '';
    if (p.currentPrice && avg) {
      const pnlPct = ((p.currentPrice - avg) / avg) * 100;
      const pnlColor = pnlPct >= 0 ? '#10b981' : '#f87171';
      pnlHtml = `<div style="font-size:10px;font-weight:700;color:${pnlColor}">${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>`;
    }
    purchasesCell = `
      <div onclick="openPurchasesModal(${p.id})" style="cursor:pointer;">
        <div class="avg-price">Avg: $${avg.toFixed(2)}</div>
        <div class="avg-sub">${qty} acc Â· $${fmt(invested)}</div>
        ${pnlHtml}
        <div class="purchases-badge">ğŸ’œ ${pList.length} compra${pList.length>1?'s':''}</div>
      </div>`;
  } else {
    purchasesCell = `<div class="purchases-badge" onclick="openPurchasesModal(${p.id})" style="cursor:pointer">+ Registrar</div>`;
  }

  const priceCell = p.currentPrice
    ? `<div style="font-size:13px;font-weight:700;color:#f1f5f9">$${p.currentPrice.toFixed(2)}</div>`
    : `<span style="color:var(--text3);font-size:11px">Cargando...</span>`;

  return `<tr id="row-${p.id}" class="${hidden?'row-hidden':''}">
    <td>
      <div class="ticker-cell">
        <div class="tlogo" style="background:${p.color}">${p.ticker.substring(0,4)}</div>
        <div><div class="tfull">${p.ticker}</div><div class="tname">${p.company}</div></div>
      </div>
      <a href="${tvUrl}" target="_blank" class="tv-link">ğŸ“ˆ TV</a>
    </td>
    <td id="sig-${p.id}">${renderSignalCell(p)}</td>
    <td>${priceCell}</td>
    <td><span style="font-size:12px;font-weight:700;color:var(--blue)">$${p.entryLow||'â€”'}</span></td>
    <td>${purchasesCell}</td>
    <td><input class="editable" value="${p.entry}" onchange="updateField(${p.id},'entry',this.value)"/></td>
    <td><span class="pill pill-red">${p.stop}</span></td>
    <td><span class="pill pill-green">${p.target}</span></td>
    <td><span class="${uc}">+${p.upside}%</span></td>
    <td><span class="rr-val">${p.rr}:1</span></td>
    <td><div class="w-bar-wrap"><div class="w-bar ${wc}" style="width:${Math.min(p.weight*6,72)}px"></div><span style="font-size:11px;font-weight:700;color:#94a3b8">${p.weight}%</span></div></td>
    <td><span class="pill ${dc}">âˆ’${p.drop}%</span></td>
    <td style="max-width:170px;color:#94a3b8;font-size:11px">${p.catalyst}</td>
    <td><div class="row-actions">
      <button class="row-btn row-btn-buy" onclick="openPurchasesModal(${p.id})" title="Compras">ğŸ’œ</button>
      <button class="row-btn row-btn-hide" onclick="toggleHideRow(${p.id})">${p.hidden?'ğŸ‘':'ğŸ™ˆ'}</button>
      <button class="row-btn row-btn-del" onclick="deleteRow(${p.id})">âœ•</button>
    </div></td>
  </tr>`;
}

function render() {
  ['core','growth','special'].forEach(layer => {
    buildHeader(layer);
    const ss = sortStates[layer];
    let lp = positions.filter(p => p.layer === layer);

    // Sort
    lp.sort((a,b) => {
      const va = sortValue(a, ss.col), vb = sortValue(b, ss.col);
      if (typeof va === 'string') return ss.asc ? va.localeCompare(vb) : vb.localeCompare(va);
      return ss.asc ? va - vb : vb - va;
    });

    const tbody = document.getElementById('tbody-' + layer);
    if (!lp.length) {
      tbody.innerHTML = `<tr><td colspan="${COLS.length}"><div class="empty-state"><div style="font-size:28px">ğŸ“­</div><p>Sin posiciones</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = lp.map(p => renderRow(p, layer)).join('');
  });

  updateKPIs();
  updateCounts();
  updatePortfolioSummary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VISIBILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isVisible(p) {
  const s = document.getElementById('searchInput').value.toLowerCase();
  const mu = parseFloat(document.getElementById('upsideRange').value);
  const mr = parseFloat(document.getElementById('rrRange').value);
  if (!activeFilters.layer.includes(p.layer)) return false;
  if (s && !p.ticker.toLowerCase().includes(s) && !p.company.toLowerCase().includes(s)) return false;
  if (p.upside < mu) return false;
  if (p.rr < mr) return false;
  const sig = getSignalBucket(p);
  if (!activeFilters.signal.includes(sig)) return false;
  if (filterWithBuys && !getPurchases(p.id).length) return false;
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKPIs() {
  const vis = positions.filter(p => isVisible(p) && (!p.hidden || showHidden));
  const tw = vis.reduce((a,p) => a+p.weight, 0);
  const wu = tw > 0 ? (vis.reduce((a,p) => a+(p.upside*p.weight), 0)/tw).toFixed(1) : 0;
  const au = vis.length ? (vis.reduce((a,p) => a+p.upside, 0)/vis.length).toFixed(1) : 0;
  const ar = vis.length ? (vis.reduce((a,p) => a+p.rr, 0)/vis.length).toFixed(1) : 0;
  const greenCount = vis.filter(p => getSignalBucket(p) === 'green').length;
  document.getElementById('kpiBar').innerHTML = `
    <div class="kpi-card"><div class="kpi-label">Posiciones</div><div class="kpi-val" style="color:#60a5fa">${vis.length}</div><div class="kpi-sub">de ${positions.length} totales</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside ponderado</div><div class="kpi-val" style="color:#10b981">+${wu}%</div><div class="kpi-sub">por peso portfolio</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside promedio</div><div class="kpi-val" style="color:#10b981">+${au}%</div><div class="kpi-sub">media simple</div></div>
    <div class="kpi-card"><div class="kpi-label">R/R promedio</div><div class="kpi-val" style="color:#60a5fa">${ar}:1</div></div>
    <div class="kpi-card"><div class="kpi-label">Peso total</div><div class="kpi-val" style="color:${tw>100?'#f87171':'#fbbf24'}">${tw}%</div><div class="kpi-sub">${tw>100?'âš ï¸ >100%':''}</div></div>
    <div class="kpi-card"><div class="kpi-label">ğŸŸ¢ En zona verde</div><div class="kpi-val" style="color:#10b981">${greenCount}</div><div class="kpi-sub">posiciones &gt;10% sobre entrada</div></div>`;
}
function updateCounts() {
  ['core','growth','special'].forEach(l => {
    const el = document.getElementById('cnt-'+l);
    if (el) el.textContent = positions.filter(p => p.layer===l && (!p.hidden||showHidden)).length;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS & SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleFilter(el, type, val) {
  el.classList.toggle('active');
  el.querySelector('input').checked = el.classList.contains('active');
  const arr = activeFilters[type];
  const idx = arr.indexOf(val);
  if (idx > -1) arr.splice(idx, 1); else arr.push(val);
  render();
}
function toggleBuyFilter(el) {
  el.classList.toggle('active');
  el.querySelector('input').checked = el.classList.contains('active');
  filterWithBuys = el.classList.contains('active');
  render();
}
function applyFilters() { render(); }
function resetFilters() {
  activeFilters = {layer:['core','growth','special'], signal:['green','yellow','red','none']};
  filterWithBuys = false;
  document.querySelectorAll('.filter-chip').forEach(c => { c.classList.add('active'); c.querySelector('input').checked = true; });
  document.getElementById('chip-withbuys').classList.remove('active');
  document.getElementById('chip-withbuys').querySelector('input').checked = false;
  ['upsideRange','rrRange'].forEach(id => document.getElementById(id).value = 0);
  document.getElementById('upsideVal').textContent = '0%';
  document.getElementById('rrVal').textContent = '0.0';
  document.getElementById('searchInput').value = '';
  render(); showToast('â†º Filtros reseteados','');
}
function toggleSection(layer) {
  const t = document.getElementById('tbl-'+layer);
  const c = document.getElementById('chev-'+layer);
  const open = t.style.display !== 'none';
  t.style.display = open ? 'none' : '';
  c.classList.toggle('open', !open);
}
function sortTable(layer, col) {
  const ss = sortStates[layer];
  if (ss.col === col) ss.asc = !ss.asc;
  else { ss.col = col; ss.asc = col === 'signal' ? false : true; } // signal defaults descending
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EDIT / DELETE / HIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateField(id, field, val) {
  const p = positions.find(x => x.id === id);
  if (p) { p[field] = val; updateKPIs(); }
}
function deleteRow(id) {
  if (!confirm('Â¿Eliminar esta posiciÃ³n?')) return;
  positions = positions.filter(p => p.id !== id);
  delete purchases[id];
  render(); showToast('ğŸ—‘ Eliminada', 'error');
}
function toggleHideRow(id) {
  const p = positions.find(x => x.id === id);
  if (p) { p.hidden = !p.hidden; render(); }
}
function toggleHidden() {
  showHidden = !showHidden;
  document.getElementById('btnToggleHidden').textContent = showHidden ? 'ğŸ‘ Ocultar ocultas' : 'ğŸ‘ Mostrar ocultas';
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POSITION MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPositionModal(id = null) {
  editId = id;
  document.getElementById('posModalTitle').textContent = id ? 'âœï¸ Editar posiciÃ³n' : 'ï¼‹ Nueva posiciÃ³n';
  if (id) {
    const p = positions.find(x => x.id === id);
    ['ticker','company','entry','stop','target','catalyst'].forEach(f => document.getElementById('f-'+f).value = p[f]||'');
    document.getElementById('f-layer').value = p.layer;
    document.getElementById('f-color').value = p.color;
    document.getElementById('f-upside').value = p.upside;
    document.getElementById('f-rr').value = p.rr;
    document.getElementById('f-weight').value = p.weight;
    document.getElementById('f-drop').value = p.drop;
    document.getElementById('f-entrylow').value = p.entryLow||'';
  } else {
    ['ticker','company','entry','stop','target','upside','rr','weight','drop','catalyst','entrylow'].forEach(f => document.getElementById('f-'+f).value = '');
    document.getElementById('f-layer').value = 'core';
    document.getElementById('f-color').value = '#3b82f6';
  }
  document.getElementById('positionModal').classList.add('open');
}
function savePosition() {
  const ticker = document.getElementById('f-ticker').value.trim();
  const company = document.getElementById('f-company').value.trim();
  if (!ticker || !company) { showToast('âš ï¸ Ticker y Empresa son obligatorios','error'); return; }
  const data = {
    ticker, company,
    layer: document.getElementById('f-layer').value,
    color: document.getElementById('f-color').value,
    entry: document.getElementById('f-entry').value||'â€”',
    stop: document.getElementById('f-stop').value||'â€”',
    target: document.getElementById('f-target').value||'â€”',
    upside: parseFloat(document.getElementById('f-upside').value)||0,
    rr: parseFloat(document.getElementById('f-rr').value)||0,
    weight: parseFloat(document.getElementById('f-weight').value)||0,
    drop: parseFloat(document.getElementById('f-drop').value)||0,
    entryLow: parseFloat(document.getElementById('f-entrylow').value)||0,
    currentPrice: 0, hidden: false,
  };
  if (editId) {
    const idx = positions.findIndex(p => p.id === editId);
    positions[idx] = {...positions[idx], ...data};
    showToast('âœ… Actualizada','success');
  } else {
    positions.push({id: nextId++, ...data});
    showToast('âœ… Agregada','success');
  }
  closeModal('positionModal'); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PURCHASES MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPurchasesModal(id) {
  activePurchaseId = id;
  const p = positions.find(x => x.id === id);
  document.getElementById('purchModalTitle').textContent = `ğŸ’œ Compras â€” ${p.ticker} (${p.company})`;
  // default date = today
  document.getElementById('purch-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('purch-price').value = '';
  document.getElementById('purch-qty').value = '';
  refreshPurchasesModal();
  document.getElementById('purchasesModal').classList.add('open');
}
function refreshPurchasesModal() {
  const id = activePurchaseId;
  const p = positions.find(x => x.id === id);
  const list = getPurchases(id);
  const avg = getAvgPrice(id);
  const qty = getTotalQty(id);
  const invested = getTotalInvested(id);
  const currentVal = p.currentPrice ? p.currentPrice * qty : null;
  const pnl = currentVal !== null ? currentVal - invested : null;
  const pnlPct = pnl !== null && invested > 0 ? (pnl/invested)*100 : null;
  const pnlColor = pnl >= 0 ? '#10b981' : '#f87171';

  document.getElementById('purch-avg').textContent = avg ? '$' + avg.toFixed(2) + ' Â· ' + qty + ' acc.' : 'â€”';
  document.getElementById('purch-total').textContent = invested > 0 ? '$' + fmt(invested) : 'â€”';
  const pnlEl = document.getElementById('purch-pnl');
  if (pnl !== null) {
    pnlEl.textContent = (pnl>=0?'+$':'-$') + fmt(Math.abs(pnl)) + ' (' + (pnlPct>=0?'+':'') + pnlPct.toFixed(1) + '%)';
    pnlEl.style.color = pnlColor;
  } else { pnlEl.textContent = 'â€”'; pnlEl.style.color = 'var(--text3)'; }

  if (!list.length) {
    document.getElementById('purchaseList').innerHTML = `<div class="empty-state"><div style="font-size:24px">ğŸ“‹</div><p>Sin compras registradas todavÃ­a</p></div>`;
    return;
  }

  document.getElementById('purchaseList').innerHTML = list.map((b, i) => {
    let rowPnl = '';
    if (p.currentPrice) {
      const rPnlPct = ((p.currentPrice - b.price) / b.price) * 100;
      const rColor = rPnlPct >= 0 ? '#10b981' : '#f87171';
      rowPnl = `<div class="purchase-pnl" style="color:${rColor}">${rPnlPct>=0?'+':''}${rPnlPct.toFixed(1)}%</div>`;
    }
    return `<div class="purchase-item">
      <div class="purchase-item-info">
        <div class="purchase-date">${b.date}</div>
        <div class="purchase-detail">$${b.price.toFixed(2)} Ã— ${b.qty} acc. = $${fmt(b.price*b.qty)}</div>
      </div>
      ${rowPnl}
      <button class="del-purchase" onclick="deletePurchase(${id},${i})">âœ•</button>
    </div>`;
  }).join('');
}
function addPurchase() {
  const date = document.getElementById('purch-date').value;
  const price = parseFloat(document.getElementById('purch-price').value);
  const qty = parseFloat(document.getElementById('purch-qty').value);
  if (!date || !price || !qty || price<=0 || qty<=0) {
    showToast('âš ï¸ CompletÃ¡ fecha, precio y cantidad','error'); return;
  }
  if (!purchases[activePurchaseId]) purchases[activePurchaseId] = [];
  purchases[activePurchaseId].push({date, price, qty});
  purchases[activePurchaseId].sort((a,b) => a.date.localeCompare(b.date));
  document.getElementById('purch-price').value = '';
  document.getElementById('purch-qty').value = '';
  refreshPurchasesModal();
  render();
  showToast(`âœ… Compra registrada: ${qty} acc. a $${price}`, 'success');
}
function deletePurchase(id, idx) {
  if (!confirm('Â¿Eliminar esta compra?')) return;
  purchases[id].splice(idx, 1);
  if (!purchases[id].length) delete purchases[id];
  refreshPurchasesModal();
  render();
  showToast('ğŸ—‘ Compra eliminada','error');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) { if (e.target.id === id) closeModal(id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const h = ['Ticker','Empresa','Capa','SeÃ±al%','PrecioActual','EntradaLow','Entrada','Stop','Objetivo','Upside%','R/R','Peso%','%BajoMax','AvgCompra','TotalInvertido','Catalizador'];
  const r = positions.map(p => {
    const sig = getSignalPct(p);
    const avg = getAvgPrice(p.id);
    return [p.ticker,p.company,p.layer,sig?sig.toFixed(2):'',p.currentPrice||'',p.entryLow,p.entry,p.stop,p.target,p.upside,p.rr,p.weight,p.drop,avg?avg.toFixed(2):'',getTotalInvested(p.id)||'',p.catalyst];
  });
  const csv = [h,...r].map(x=>x.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = 'portfolio_2026.csv'; a.click();
  showToast('â¬‡ CSV descargado','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type||'');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YAHOO FINANCE â€” RAPIDAPI (versiÃ³n funcional)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RAPIDAPI_KEY = '1f1a074f75msh519b89fd0e03c4ep172cc3jsnfe77f0a20dcd';
const RAPIDAPI_HOST = 'apidojo-yahoo-finance-v1.p.rapidapi.com';

async function fetchPrices(){
  showToast('ğŸ”„ Actualizando precios desde Yahoo Finance...','');
  document.getElementById('lastUpdate').textContent = 'Actualizando...';

  try {
    const symbols = positions.map(p => p.ticker).join(',');
    const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/market/v2/get-quotes?region=US&symbols=${encodeURIComponent(symbols)}`;

    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'x-rapidapi-key': RAPIDAPI_KEY,
        'x-rapidapi-host': RAPIDAPI_HOST
      }
    });

    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const quotes = data?.quoteResponse?.result || [];
    let updated = 0;

    quotes.forEach(q => {
      const ticker = (q.symbol || '').replace(/\.[A-Z]+$/, '').toUpperCase();
      const price = parseFloat(q.regularMarketPrice || 0);
      if (!ticker || !price) return;
      const p = positions.find(x => x.ticker === ticker);
      if (p) {
        p.currentPrice = Math.round(price * 100) / 100;
        updated++;
      }
    });

    render();

    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
    const dateStr = now.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', year:'numeric'});
    document.getElementById('lastUpdate').textContent = `âœ… Actualizado: ${dateStr} ${timeStr} Â· ${updated}/${positions.length} tickers`;
    document.getElementById('lastUpdate').style.color = '#10b981';

    if (updated === 0) {
      showToast('âš ï¸ Sin precios en la respuesta. RevisÃ¡ tu suscripciÃ³n en RapidAPI.', 'error');
    } else {
      showToast(`âœ… ${updated} precios actualizados`, 'success');
    }

  } catch(err) {
    console.error('Yahoo Finance error:', err);
    document.getElementById('lastUpdate').textContent = `âŒ Error: ${err.message}`;
    document.getElementById('lastUpdate').style.color = '#f87171';
    showToast(`âŒ Error: ${err.message}`, 'error');
  }
}

function isMarketHours(){
  const now = new Date();
  const day = now.getUTCDay();
  if(day===0||day===6) return false;
  const utcMin = now.getUTCHours()*60+now.getUTCMinutes();
  return utcMin >= 14*60+30 && utcMin <= 21*60;
}

render();
fetchPrices();
setInterval(()=>{ if(isMarketHours()) fetchPrices(); }, 5*60*1000);
</script>
</body>
</html>
