<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TRADEFLOW ‚Äî Your Trading, In Flow</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#ffffff;--bg2:#f8fafc;--bg3:#f1f5f9;--bg4:#e2e8f0;
  --border:#e2e8f0;--border2:#cbd5e1;
  --text:#0f172a;--text2:#475569;--text3:#64748b;
  --green:#10b981;--green-bg:#d1fae5;--green-border:#6ee7b7;
  --red:#ef4444;--red-bg:#fee2e2;--red-border:#fca5a5;
  --yellow:#f59e0b;--yellow-bg:#fef3c7;--yellow-border:#fcd34d;
  --blue:#0ea5e9;--blue-bg:#e0f2fe;--blue-border:#7dd3fc;
  --purple:#8b5cf6;--purple-bg:#ede9fe;--purple-border:#c4b5fd;
  --primary:#0ea5e9;--secondary:#8b5cf6;
  --gradient-primary:linear-gradient(135deg,#0ea5e9,#8b5cf6);
}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* NAV */
.topnav{background:var(--bg2);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:100;}
.logo{font-size:15px;font-weight:800;letter-spacing:-0.5px;color:#f1f5f9;}
.logo span{color:var(--blue);}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.btn-primary{background:var(--blue);color:#000;}
.btn-primary:hover{background:#93c5fd;}
.btn-ghost{background:var(--bg3);color:var(--text2);border:1px solid var(--border2);}
.btn-ghost:hover{background:var(--bg4);color:var(--text);}
.btn-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.btn-green:hover{background:rgba(16,185,129,.22);}
.btn-purple{background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border);}
.btn-purple:hover{background:rgba(167,139,250,.22);}

/* LAYOUT */
.main{display:flex;min-height:calc(100vh - 53px);}
.sidebar{width:250px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);padding:18px 14px;position:sticky;top:53px;height:calc(100vh - 53px);overflow-y:auto;}
.content{flex:1;padding:22px;overflow-x:auto;}

/* SIDEBAR */
.sidebar-section{margin-bottom:20px;}
.sidebar-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);margin-bottom:10px;}
.filter-group{display:flex;flex-direction:column;gap:5px;}
.filter-chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;background:var(--bg3);border:1px solid var(--border);transition:all .15s;user-select:none;}
.filter-chip:hover{border-color:var(--border2);}
.filter-chip.active{border-color:var(--blue);background:var(--blue-bg);}
.filter-chip input[type=checkbox]{accent-color:var(--blue);width:13px;height:13px;flex-shrink:0;}
.filter-chip .chip-label{font-size:11px;font-weight:500;color:var(--text2);flex:1;}
.filter-chip.active .chip-label{color:var(--text);}
.chip-count{font-size:10px;font-weight:700;padding:1px 5px;border-radius:100px;background:var(--bg4);color:var(--text3);}
.range-item label{font-size:11px;color:var(--text3);display:block;margin-bottom:3px;}
.range-item input[type=range]{width:100%;accent-color:var(--blue);}
.range-val{font-size:11px;font-weight:700;color:var(--blue);float:right;}
.search-box{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-size:12px;font-family:'Inter',sans-serif;outline:none;transition:border-color .15s;}
.search-box:focus{border-color:var(--blue);}
.search-box::placeholder{color:var(--text3);}

/* PORTFOLIO SUMMARY CARD */
.portfolio-summary{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;
  margin-bottom:20px;padding:16px;
  background:linear-gradient(135deg,rgba(96,165,250,.06),rgba(167,139,250,.04));
  border:1px solid var(--border2);border-radius:14px;
}
.ps-title{grid-column:1/-1;font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.ps-card{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;}
.ps-label{font-size:10px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text3);margin-bottom:5px;}
.ps-val{font-size:18px;font-weight:800;}
.ps-sub{font-size:10px;color:var(--text3);margin-top:2px;}

/* KPI bar */
.kpi-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:18px;}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:11px 14px;flex:1;min-width:120px;}
.kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:5px;}
.kpi-val{font-size:18px;font-weight:800;}
.kpi-sub{font-size:10px;color:var(--text3);margin-top:2px;}

/* STATUS BAR */
.status-bar{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:9px 14px;background:#0d1521;border:1px solid #1e293b;border-radius:10px;}
.legend{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:14px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:11px;color:#94a3b8;}
.leg-dot{width:8px;height:8px;border-radius:50%;}

/* SECTION */
.section{margin-bottom:28px;}
.section-header{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;cursor:pointer;user-select:none;}
.sh-core{background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(59,130,246,.06));border:1px solid rgba(59,130,246,.2);}
.sh-growth{background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(245,158,11,.06));border:1px solid rgba(245,158,11,.2);}
.sh-special{background:linear-gradient(135deg,rgba(239,68,68,.12),rgba(239,68,68,.06));border:1px solid rgba(239,68,68,.2);}
.section-icon{font-size:18px;}
.section-name{font-size:14px;font-weight:800;color:#f1f5f9;}
.section-desc{font-size:11px;color:var(--text3);margin-top:1px;}
.section-badge{margin-left:auto;font-size:11px;font-weight:700;padding:3px 9px;border-radius:100px;}
.badge-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}
.badge-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.badge-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.chevron{margin-left:8px;font-size:11px;color:var(--text3);transition:transform .2s;}
.chevron.open{transform:rotate(180deg);}

/* TABLE */
.tbl-wrap{border:1px solid var(--border);border-radius:0 0 12px 12px;overflow:hidden;border-top:none;}
table{width:100%;border-collapse:collapse;min-width:1000px;}
thead th{background:var(--bg3);padding:8px 10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.7px;color:var(--text3);text-align:left;white-space:nowrap;cursor:pointer;user-select:none;}
thead th:hover{color:var(--text2);}
thead th.sorted-asc::after{content:' ‚ñ≤';color:var(--blue);}
thead th.sorted-desc::after{content:' ‚ñº';color:var(--blue);}
thead th.sortable{color:var(--text2);}
tbody td{padding:10px 10px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);vertical-align:middle;}
tbody tr{transition:background .1s;}
tbody tr:hover td{background:var(--bg3);}
tbody tr.row-hidden{display:none;}

/* CELLS */
.ticker-cell{display:flex;align-items:center;gap:8px;}
.tlogo{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff;flex-shrink:0;}
.tname{font-size:10px;color:var(--text3);}
.tfull{font-size:12px;font-weight:700;color:#f1f5f9;}
.tv-link{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:5px;background:rgba(41,98,255,.12);border:1px solid rgba(41,98,255,.25);color:#5b8af5;font-size:10px;font-weight:700;text-decoration:none;margin-top:4px;white-space:nowrap;}
.tv-link:hover{background:rgba(41,98,255,.22);}

.pill{display:inline-block;padding:2px 7px;border-radius:100px;font-size:11px;font-weight:700;}
.pill-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-border);}
.pill-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-border);}
.pill-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow-border);}
.pill-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-border);}

.signal-wrap{display:flex;align-items:center;gap:6px;}
.signal-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;box-shadow:0 0 7px 2px currentColor;}
.sig-green{background:#10b981;color:#10b981;}
.sig-yellow{background:#fbbf24;color:#fbbf24;}
.sig-red{background:#f87171;color:#f87171;}
.sig-none{background:#475569;color:#475569;box-shadow:none;}

.upside-val{font-size:13px;font-weight:800;color:var(--green);}
.upside-warn{font-size:13px;font-weight:800;color:var(--yellow);}
.rr-val{font-weight:700;color:var(--blue);}
.w-bar-wrap{display:flex;align-items:center;gap:5px;}
.w-bar{height:4px;border-radius:3px;}
.wb-blue{background:linear-gradient(90deg,#3b82f6,#60a5fa);}
.wb-yellow{background:linear-gradient(90deg,#d97706,#fbbf24);}
.wb-red{background:linear-gradient(90deg,#dc2626,#f87171);}

.editable{background:transparent;border:1px solid transparent;border-radius:5px;padding:2px 5px;color:var(--text2);font-size:12px;font-family:'Inter',sans-serif;cursor:text;transition:all .15s;width:85px;}
.editable:hover{border-color:var(--border2);}
.editable:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}
.price-input{background:transparent;border:1px solid transparent;border-radius:5px;padding:2px 5px;color:var(--text2);font-size:12px;font-family:'Inter',sans-serif;cursor:text;transition:all .15s;width:75px;}
.price-input:hover{border-color:var(--border2);}
.price-input:focus{border-color:var(--blue);background:var(--bg3);outline:none;color:var(--text);}

/* PURCHASES */
.purchases-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;background:var(--purple-bg);color:var(--purple);border:1px solid var(--purple-border);cursor:pointer;margin-top:3px;}
.purchases-badge:hover{background:rgba(167,139,250,.2);}
.avg-price{font-size:11px;font-weight:700;color:var(--purple);}
.avg-sub{font-size:10px;color:var(--text3);}
.pnl-pos{color:var(--green);font-weight:700;}
.pnl-neg{color:var(--red);font-weight:700;}

/* ROW ACTIONS */
.row-actions{display:flex;gap:3px;opacity:0;transition:opacity .15s;}
tbody tr:hover .row-actions{opacity:1;}
.row-btn{padding:3px 7px;border-radius:5px;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.row-btn-del{background:var(--red-bg);color:var(--red);}
.row-btn-del:hover{background:rgba(248,113,113,.25);}
.row-btn-hide{background:var(--bg4);color:var(--text3);}
.row-btn-hide:hover{background:var(--border2);color:var(--text2);}
.row-btn-buy{background:var(--purple-bg);color:var(--purple);}
.row-btn-buy:hover{background:rgba(167,139,250,.22);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:24px;width:100%;max-width:560px;max-height:92vh;overflow-y:auto;transform:translateY(20px);transition:transform .2s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-title{font-size:16px;font-weight:800;color:#f1f5f9;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-field{display:flex;flex-direction:column;gap:4px;}
.form-field.full{grid-column:1/-1;}
.form-field label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;}
.form-field input,.form-field select,.form-field textarea{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:8px 11px;color:var(--text);font-size:13px;font-family:'Inter',sans-serif;outline:none;transition:border-color .15s;}
.form-field input:focus,.form-field select:focus{border-color:var(--blue);}
.form-field select option{background:var(--bg3);}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;}
.modal-divider{grid-column:1/-1;border:none;border-top:1px solid var(--border);margin:4px 0;}

/* PURCHASES MODAL */
.purchase-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;max-height:280px;overflow-y:auto;}
.purchase-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;}
.purchase-item-info{flex:1;}
.purchase-date{font-size:10px;color:var(--text3);}
.purchase-detail{font-size:12px;font-weight:700;color:var(--text);}
.purchase-pnl{font-size:11px;font-weight:700;text-align:right;}
.del-purchase{background:var(--red-bg);color:var(--red);border:none;border-radius:5px;padding:3px 8px;font-size:11px;cursor:pointer;}
.del-purchase:hover{background:rgba(248,113,113,.25);}
.purchase-summary{padding:12px 14px;background:var(--bg4);border-radius:10px;margin-bottom:12px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.ps-item label{font-size:10px;color:var(--text3);display:block;text-transform:uppercase;letter-spacing:.5px;}
.ps-item span{font-size:14px;font-weight:800;}
.add-purchase-form{background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:14px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.add-purchase-form label{font-size:10px;color:var(--text3);display:block;margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}
.add-purchase-form input{background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px 9px;color:var(--text);font-size:12px;font-family:'Inter',sans-serif;outline:none;width:100%;}
.add-purchase-form input:focus{border-color:var(--blue);}
.add-purchase-form .full{grid-column:1/-1;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;z-index:300;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;padding:11px 16px;font-size:12px;font-weight:600;color:var(--text);transform:translateY(80px);opacity:0;transition:all .25s;display:flex;align-items:center;gap:8px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-color:var(--green-border);color:var(--green);}
.toast.error{border-color:var(--red-border);color:var(--red);}

.empty-state{text-align:center;padding:32px 20px;color:var(--text3);}

/* TAB BUTTONS */
.tab-btn{width:100%;display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;text-align:left;}
.tab-btn:hover{background:var(--bg4);border-color:var(--border2);}
.tab-btn.active{background:linear-gradient(135deg,rgba(96,165,250,.12),rgba(96,165,250,.06));border-color:var(--blue);color:var(--blue);}

/* TICKER AUTOCOMPLETE */
.ticker-autocomplete{position:relative;}
.ticker-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--border2);border-radius:8px;margin-top:4px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3);display:none;}
.ticker-suggestions.show{display:block;}
.ticker-suggestion-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;}
.ticker-suggestion-item:hover{background:var(--bg3);}
.ticker-suggestion-item:last-child{border-bottom:none;}
.suggestion-ticker{font-size:13px;font-weight:700;color:var(--text);}
.suggestion-name{font-size:11px;color:var(--text3);margin-top:2px;}
.suggestion-price{font-size:12px;font-weight:600;color:var(--blue);margin-top:2px;}

/* LOGIN SCREEN */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,#e0f2fe 0%,#ede9fe 50%,#dbeafe 100%);display:flex;align-items:center;justify-content:center;z-index:10000;}
.login-container{text-align:center;max-width:420px;padding:48px 40px;background:white;border-radius:24px;box-shadow:0 20px 60px rgba(14,165,233,.15),0 0 1px rgba(0,0,0,.05);}
.login-logo{width:120px;height:120px;margin:0 auto 32px;background:linear-gradient(135deg,#0ea5e9,#8b5cf6);border-radius:24px;display:flex;align-items:center;justify-content:center;font-size:56px;font-weight:900;color:white;letter-spacing:-2px;box-shadow:0 8px 32px rgba(14,165,233,.3);position:relative;overflow:hidden;}
.login-logo svg rect{animation:candleGrow 2s ease-in-out infinite;}
.login-logo svg rect:nth-child(3){animation-delay:0s;}
.login-logo svg rect:nth-child(5){animation-delay:0.15s;}
.login-logo svg rect:nth-child(7){animation-delay:0.3s;}
.login-logo svg rect:nth-child(9){animation-delay:0.45s;}
.login-logo svg rect:nth-child(11){animation-delay:0.6s;}
.login-logo svg rect:nth-child(13){animation-delay:0.75s;}
.login-logo svg rect:nth-child(15){animation-delay:0.9s;}
@keyframes candleGrow{0%{opacity:0.3;transform:scaleY(0.5);}50%{opacity:1;transform:scaleY(1.05);}100%{opacity:0.3;transform:scaleY(0.5);}}
.login-logo svg path:last-child{animation:arrowPulse 1.5s ease-in-out infinite;}
@keyframes arrowPulse{0%,100%{opacity:0.6;transform:translateX(0);}50%{opacity:1;transform:translateX(3px);}}
.login-title{font-size:32px;font-weight:900;color:#0f172a;margin-bottom:8px;letter-spacing:-1px;background:linear-gradient(135deg,#0ea5e9,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.login-subtitle{font-size:14px;color:#64748b;margin-bottom:32px;}
.pin-input-container{display:flex;gap:12px;justify-content:center;margin-bottom:24px;}
.pin-digit{width:56px;height:64px;font-size:32px;font-weight:700;text-align:center;border:2px solid #e2e8f0;border-radius:12px;background:white;color:#0f172a;transition:all .2s;}
.pin-digit:focus{outline:none;border-color:#0ea5e9;box-shadow:0 0 0 3px rgba(14,165,233,.1);}
.pin-error{color:#ef4444;font-size:13px;font-weight:600;margin-top:12px;min-height:20px;}
.pin-hint{font-size:12px;color:#94a3b8;margin-top:16px;}

/* NAVIGATION MENU */
#navMenu{position:fixed;top:0;left:0;right:0;background:white;border-bottom:2px solid #e2e8f0;padding:0;z-index:9999;box-shadow:0 1px 3px rgba(0,0,0,.04);}
.menu-container{max-width:1400px;margin:0 auto;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;}
.menu-logo-section{display:flex;align-items:center;gap:16px;}
.menu-logo{width:48px;height:48px;background:linear-gradient(135deg,#0ea5e9,#8b5cf6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:white;letter-spacing:-1px;box-shadow:0 4px 12px rgba(14,165,233,.2);position:relative;overflow:hidden;}
.menu-logo svg rect{animation:menuCandlePulse 2.5s ease-in-out infinite;}
.menu-logo svg rect:nth-child(3){animation-delay:0s;}
.menu-logo svg rect:nth-child(5){animation-delay:0.2s;}
.menu-logo svg rect:nth-child(7){animation-delay:0.4s;}
.menu-logo svg rect:nth-child(9){animation-delay:0.6s;}
.menu-logo svg rect:nth-child(11){animation-delay:0.8s;}
.menu-logo svg rect:nth-child(13){animation-delay:1s;}
.menu-logo svg rect:nth-child(15){animation-delay:1.2s;}
@keyframes menuCandlePulse{0%,100%{opacity:0.6;}50%{opacity:1;}}
.menu-brand{font-size:22px;font-weight:900;color:#0f172a;letter-spacing:-0.8px;}
.menu-brand span{background:linear-gradient(135deg,#0ea5e9,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:900;}
.menu-nav{display:flex;gap:8px;}
.menu-nav-btn{padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;background:transparent;border:none;cursor:pointer;transition:all .2s;color:#64748b;}
.menu-nav-btn:hover{background:#f1f5f9;color:#0f172a;}
.menu-nav-btn.active{background:linear-gradient(135deg,#0ea5e9,#8b5cf6);color:white;box-shadow:0 4px 12px rgba(14,165,233,.25);}
.menu-logout{padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;background:#fee2e2;color:#ef4444;border:1px solid #fca5a5;cursor:pointer;transition:all .2s;}
.menu-logout:hover{background:#fecaca;}

/* MAIN APP CONTAINER */
#appContainer{display:none;margin-top:88px;}

@media(max-width:800px){.sidebar{display:none;}.content{padding:14px;}.form-grid{grid-template-columns:1fr;}.portfolio-summary{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-container">
    <div class="login-logo">
      <svg viewBox="0 0 120 100" style="width:85px;height:70px;">
        <!-- Trend line (ascending) -->
        <path d="M5,85 L25,75 L45,70 L65,55 L85,45 L105,25" stroke="rgba(255,255,255,0.4)" stroke-width="2" fill="none" stroke-dasharray="3,3"/>
        
        <!-- Candlesticks (volatility with uptrend) -->
        <!-- Candle 1 - Green up -->
        <line x1="15" y1="90" x2="15" y2="75" stroke="rgba(16,185,129,0.8)" stroke-width="1.5"/>
        <rect x="12" y="80" width="6" height="10" fill="#10b981" rx="1"/>
        
        <!-- Candle 2 - Red down -->
        <line x1="30" y1="78" x2="30" y2="68" stroke="rgba(239,68,68,0.8)" stroke-width="1.5"/>
        <rect x="27" y="72" width="6" height="6" fill="#ef4444" rx="1"/>
        
        <!-- Candle 3 - Green up -->
        <line x1="45" y1="75" x2="45" y2="60" stroke="rgba(16,185,129,0.8)" stroke-width="1.5"/>
        <rect x="42" y="65" width="6" height="10" fill="#10b981" rx="1"/>
        
        <!-- Candle 4 - Red down -->
        <line x1="60" y1="63" x2="60" y2="53" stroke="rgba(239,68,68,0.8)" stroke-width="1.5"/>
        <rect x="57" y="57" width="6" height="6" fill="#ef4444" rx="1"/>
        
        <!-- Candle 5 - Green up -->
        <line x1="75" y1="58" x2="75" y2="38" stroke="rgba(16,185,129,0.8)" stroke-width="1.5"/>
        <rect x="72" y="43" width="6" height="15" fill="#10b981" rx="1"/>
        
        <!-- Candle 6 - Green up -->
        <line x1="90" y1="48" x2="90" y2="33" stroke="rgba(16,185,129,0.8)" stroke-width="1.5"/>
        <rect x="87" y="38" width="6" height="10" fill="#10b981" rx="1"/>
        
        <!-- Candle 7 - Green breakout -->
        <line x1="105" y1="35" x2="105" y2="15" stroke="rgba(16,185,129,0.8)" stroke-width="1.5"/>
        <rect x="102" y="20" width="6" height="15" fill="#10b981" rx="1"/>
        
        <!-- Arrow at end -->
        <path d="M105,15 L105,25 L98,18 Z" fill="white" opacity="0.9"/>
      </svg>
    </div>
    <h1 class="login-title">TRADEFLOW</h1>
    <p class="login-subtitle">Your Trading, In Flow</p>
    <div class="pin-input-container">
      <input type="password" maxlength="1" class="pin-digit" id="pin1" oninput="movePinFocus(1)" onkeydown="handlePinBackspace(event,1)"/>
      <input type="password" maxlength="1" class="pin-digit" id="pin2" oninput="movePinFocus(2)" onkeydown="handlePinBackspace(event,2)"/>
      <input type="password" maxlength="1" class="pin-digit" id="pin3" oninput="movePinFocus(3)" onkeydown="handlePinBackspace(event,3)"/>
      <input type="password" maxlength="1" class="pin-digit" id="pin4" oninput="movePinFocus(4)" onkeydown="handlePinBackspace(event,4)"/>
    </div>
    <div class="pin-error" id="pinError"></div>
    <p class="pin-hint">C√≥digo por defecto: 1234</p>
  </div>
</div>

<!-- NAVIGATION MENU -->
<div id="navMenu" style="display:none;">
  <div class="menu-container">
    <div class="menu-logo-section">
      <div class="menu-logo">
        <svg viewBox="0 0 120 100" style="width:34px;height:28px;">
          <!-- Trend line -->
          <path d="M5,85 L25,75 L45,70 L65,55 L85,45 L105,25" stroke="rgba(255,255,255,0.5)" stroke-width="2" fill="none" stroke-dasharray="2,2"/>
          <!-- Candlesticks -->
          <line x1="15" y1="90" x2="15" y2="75" stroke="rgba(16,185,129,0.9)" stroke-width="2"/>
          <rect x="12" y="80" width="6" height="10" fill="#10b981" rx="1"/>
          <line x1="30" y1="78" x2="30" y2="68" stroke="rgba(239,68,68,0.9)" stroke-width="2"/>
          <rect x="27" y="72" width="6" height="6" fill="#ef4444" rx="1"/>
          <line x1="45" y1="75" x2="45" y2="60" stroke="rgba(16,185,129,0.9)" stroke-width="2"/>
          <rect x="42" y="65" width="6" height="10" fill="#10b981" rx="1"/>
          <line x1="60" y1="63" x2="60" y2="53" stroke="rgba(239,68,68,0.9)" stroke-width="2"/>
          <rect x="57" y="57" width="6" height="6" fill="#ef4444" rx="1"/>
          <line x1="75" y1="58" x2="75" y2="38" stroke="rgba(16,185,129,0.9)" stroke-width="2"/>
          <rect x="72" y="43" width="6" height="15" fill="#10b981" rx="1"/>
          <line x1="90" y1="48" x2="90" y2="33" stroke="rgba(16,185,129,0.9)" stroke-width="2"/>
          <rect x="87" y="38" width="6" height="10" fill="#10b981" rx="1"/>
          <line x1="105" y1="35" x2="105" y2="15" stroke="rgba(16,185,129,0.9)" stroke-width="2"/>
          <rect x="102" y="20" width="6" height="15" fill="#10b981" rx="1"/>
          <path d="M105,15 L105,25 L98,18 Z" fill="white" opacity="0.95"/>
        </svg>
      </div>
      <div class="menu-brand">TRADE<span>FLOW</span></div>
    </div>
    <div class="menu-nav">
      <button class="menu-nav-btn active" onclick="switchToPortfolio()">üìä Portfolio</button>
      <button class="menu-nav-btn" onclick="switchToDayTrading()">üìà Day Trading</button>
    </div>
    <button class="menu-logout" onclick="logout()">üö™ Salir</button>
  </div>
</div>

<!-- MAIN APP CONTAINER -->
<div id="appContainer">

<nav class="topnav" style="display:none;">
  <div class="logo">Portfolio<span>2026</span></div>
  <div class="nav-right">
    <button class="btn btn-purple" onclick="openTickerSearch()">üîç Buscar ticker</button>
    <button class="btn btn-ghost" id="btnToggleHidden" onclick="toggleHidden()">üëÅ Mostrar ocultas</button>
    <button class="btn btn-green" onclick="fetchPrices()">üîÑ Actualizar precios</button>
    <button class="btn btn-ghost" onclick="exportCSV()">‚¨á CSV</button>
    <button class="btn btn-primary" onclick="openPositionModal()">Ôºã Agregar posici√≥n</button>
  </div>
</nav>

<div class="main">
<aside class="sidebar">
  <!-- Tabs Navigation -->
  <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px;border-bottom:2px solid var(--border);padding-bottom:16px;">
    <button class="tab-btn active" onclick="switchTab('portfolio')" id="tab-portfolio-btn">
      <span style="font-size:16px;">üìä</span>
      <span>Portfolio</span>
    </button>
    <button class="tab-btn" onclick="switchTab('journal')" id="tab-journal-btn">
      <span style="font-size:16px;">üìà</span>
      <span>Day Trading</span>
    </button>
  </div>

  <!-- Portfolio Filters (shown only when portfolio tab active) -->
  <div id="portfolio-filters">
  <div class="sidebar-section">
    <div class="sidebar-title">üîç Buscar</div>
    <input class="search-box" type="text" placeholder="Ticker o empresa..." oninput="applyFilters()" id="searchInput"/>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">üìÇ Capa</div>
    <div class="filter-group">
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','core')"><input type="checkbox" checked readonly/><span class="chip-label">üîµ Core</span><span class="chip-count" id="cnt-core">6</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','growth')"><input type="checkbox" checked readonly/><span class="chip-label">üü° Growth</span><span class="chip-count" id="cnt-growth">7</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'layer','special')"><input type="checkbox" checked readonly/><span class="chip-label">üî¥ Special</span><span class="chip-count" id="cnt-special">2</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">üö¶ Se√±al</div>
    <div class="filter-group">
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','green')"><input type="checkbox" checked readonly/><span class="chip-label">üü¢ Verde (&gt;10%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','yellow')"><input type="checkbox" checked readonly/><span class="chip-label">üü° Amarillo (3‚Äì10%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','red')"><input type="checkbox" checked readonly/><span class="chip-label">üî¥ Rojo (&lt;3%)</span></label>
      <label class="filter-chip active" onclick="toggleFilter(this,'signal','none')"><input type="checkbox" checked readonly/><span class="chip-label">‚ö™ Sin precio</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">üìà Upside m√≠nimo</div>
    <div class="range-item"><label>Upside: <span class="range-val" id="upsideVal">0%</span></label><input type="range" min="0" max="140" value="0" id="upsideRange" oninput="document.getElementById('upsideVal').textContent=this.value+'%';applyFilters()"/></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">‚öñÔ∏è R/R m√≠nimo</div>
    <div class="range-item"><label>Ratio: <span class="range-val" id="rrVal">0.0</span>:1</label><input type="range" min="0" max="5" step="0.1" value="0" id="rrRange" oninput="document.getElementById('rrVal').textContent=parseFloat(this.value).toFixed(1);applyFilters()"/></div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-title">üíº Solo con compras</div>
    <div class="filter-group">
      <label class="filter-chip" id="chip-withbuys" onclick="toggleBuyFilter(this)"><input type="checkbox" readonly/><span class="chip-label">üíú Con compras reales</span></label>
    </div>
  </div>
  <div class="sidebar-section">
    <button class="btn btn-ghost" style="width:100%" onclick="resetFilters()">‚Ü∫ Resetear filtros</button>
  </div>
  </div>

  <!-- Journal Filters (shown only when journal tab active) -->
  <div id="journal-filters" style="display:none;">
    <div class="sidebar-section">
      <div class="sidebar-title">üìÖ Per√≠odo</div>
      <div class="filter-group">
        <label class="filter-chip active" onclick="filterJournalPeriod('all',this)"><input type="checkbox" checked readonly/><span class="chip-label">üìä Todo</span></label>
        <label class="filter-chip" onclick="filterJournalPeriod('week',this)"><input type="checkbox" readonly/><span class="chip-label">üìÖ Esta semana</span></label>
        <label class="filter-chip" onclick="filterJournalPeriod('month',this)"><input type="checkbox" readonly/><span class="chip-label">üìÜ Este mes</span></label>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">üìà Direcci√≥n</div>
      <div class="filter-group">
        <label class="filter-chip active" onclick="filterJournalDirection('all',this)"><input type="checkbox" checked readonly/><span class="chip-label">üîÑ Todas</span></label>
        <label class="filter-chip" onclick="filterJournalDirection('long',this)"><input type="checkbox" readonly/><span class="chip-label">üìà Long</span></label>
        <label class="filter-chip" onclick="filterJournalDirection('short',this)"><input type="checkbox" readonly/><span class="chip-label">üìâ Short</span></label>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">‚úÖ Resultado</div>
      <div class="filter-group">
        <label class="filter-chip active" onclick="filterJournalResult('all',this)"><input type="checkbox" checked readonly/><span class="chip-label">üîÑ Todos</span></label>
        <label class="filter-chip" onclick="filterJournalResult('wins',this)"><input type="checkbox" readonly/><span class="chip-label">‚úÖ Ganadores</span></label>
        <label class="filter-chip" onclick="filterJournalResult('breakeven',this)"><input type="checkbox" readonly/><span class="chip-label">‚öñÔ∏è Break Even</span></label>
        <label class="filter-chip" onclick="filterJournalResult('losses',this)"><input type="checkbox" readonly/><span class="chip-label">‚ùå Perdedores</span></label>
      </div>
    </div>
  </div>
</aside>

<main class="content">
  <!-- PORTFOLIO TAB CONTENT -->
  <div id="tab-portfolio-content">

  <!-- ACTION BAR -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;">
    <h2 style="font-size:18px;font-weight:800;color:var(--text);margin:0;">üíº Portfolio Largo Plazo</h2>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-purple" onclick="openTickerSearch()">üîç Buscar ticker</button>
      <button class="btn btn-ghost" id="btnToggleHidden" onclick="toggleHidden()">üëÅ Mostrar ocultas</button>
      <button class="btn btn-green" onclick="fetchPrices()">üîÑ Actualizar precios</button>
      <button class="btn btn-ghost" onclick="exportCSV()">‚¨á CSV</button>
      <button class="btn btn-primary" onclick="openPositionModal()">Ôºã Agregar posici√≥n</button>
    </div>
  </div>

  <!-- PORTFOLIO SUMMARY -->\n  <div class="portfolio-summary" id="portfolioSummary">
    <div class="ps-title">üíº RESUMEN DEL PORTFOLIO ‚Äî Inversiones Largo Plazo</div>
    <div style="font-size:10px;color:var(--text3);margin:-8px 0 12px 0;">No incluye operaciones de Day Trading ¬∑ Solo posiciones con compras reales</div>
    <div class="ps-card"><div class="ps-label">Capital invertido</div><div class="ps-val" id="ps-invested" style="color:var(--blue)">$0</div><div class="ps-sub" id="ps-positions-count">0 posiciones con compras</div></div>
    <div class="ps-card"><div class="ps-label">Valor actual</div><div class="ps-val" id="ps-current" style="color:var(--text)">$0</div><div class="ps-sub">a precios de hoy</div></div>
    <div class="ps-card"><div class="ps-label">P&L total</div><div class="ps-val" id="ps-pnl">$0</div><div class="ps-sub" id="ps-pnl-pct">0.00%</div></div>
    <div class="ps-card"><div class="ps-label">Rendimiento anual</div><div class="ps-val" id="ps-annual">‚Äî</div><div class="ps-sub" id="ps-annual-sub">d√≠as desde primer compra</div></div>
    <div class="ps-card"><div class="ps-label">Mejor posici√≥n</div><div class="ps-val" id="ps-best" style="color:var(--green)">‚Äî</div><div class="ps-sub" id="ps-best-sub"></div></div>
    <div class="ps-card"><div class="ps-label">Peor posici√≥n</div><div class="ps-val" id="ps-worst" style="color:var(--red)">‚Äî</div><div class="ps-sub" id="ps-worst-sub"></div></div>
  </div>

  <!-- HEADER -->
  <div class="legend">
    <div class="leg-item"><div class="leg-dot" style="background:#f87171;box-shadow:0 0 4px #f87171"></div>Rojo: &lt;3% sobre entrada</div>
    <div class="leg-item"><div class="leg-dot" style="background:#fbbf24;box-shadow:0 0 4px #fbbf24"></div>Amarillo: 3‚Äì10%</div>
    <div class="leg-item"><div class="leg-dot" style="background:#10b981;box-shadow:0 0 4px #10b981"></div>Verde: &gt;10%</div>
    <div class="leg-item" style="margin-left:auto;font-size:10px;color:var(--text3)">üíú Click en ticker para registrar compras</div>
  </div>

  <div class="status-bar">
    <span style="font-size:12px;color:var(--text3)" id="lastUpdate">‚è≥ Cargando precios desde TradingView...</span>
  </div>

  <div class="kpi-bar" id="kpiBar"></div>

  <!-- CORE -->
  <div class="section">
    <div class="section-header sh-core" onclick="toggleSection('core')">
      <span class="section-icon">üîµ</span>
      <div><div class="section-name">CAPA 1 ‚Äî CORE HOLDINGS</div><div class="section-desc">Mayor convicci√≥n ¬∑ Menor volatilidad</div></div>
      <span class="section-badge badge-blue">50% Peso</span>
      <span class="chevron open" id="chev-core">‚ñº</span>
    </div>
    <div class="tbl-wrap" id="tbl-core">
      <table><thead id="thead-core"><tr></tr></thead><tbody id="tbody-core"></tbody></table>
    </div>
  </div>

  <!-- GROWTH -->
  <div class="section">
    <div class="section-header sh-growth" onclick="toggleSection('growth')">
      <span class="section-icon">üü°</span>
      <div><div class="section-name">CAPA 2 ‚Äî GROWTH HOLDINGS</div><div class="section-desc">Mayor upside ¬∑ Volatilidad media-alta</div></div>
      <span class="section-badge badge-yellow">35% Peso</span>
      <span class="chevron open" id="chev-growth">‚ñº</span>
    </div>
    <div class="tbl-wrap" id="tbl-growth">
      <table><thead id="thead-growth"><tr></tr></thead><tbody id="tbody-growth"></tbody></table>
    </div>
  </div>

  <!-- SPECIAL -->
  <div class="section">
    <div class="section-header sh-special" onclick="toggleSection('special')">
      <span class="section-icon">üî¥</span>
      <div><div class="section-name">CAPA 3 ‚Äî SPECIAL SITUATIONS</div><div class="section-desc">Alto riesgo ¬∑ Retorno asim√©trico</div></div>
      <span class="section-badge badge-red">15% Peso</span>
      <span class="chevron open" id="chev-special">‚ñº</span>
    </div>
    <div class="tbl-wrap" id="tbl-special">
      <table><thead id="thead-special"><tr></tr></thead><tbody id="tbody-special"></tbody></table>
    </div>
  </div>

  </div>
  <!-- END PORTFOLIO TAB -->

  <!-- JOURNAL TAB CONTENT -->
  <div id="tab-journal-content" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div>
        <h2 style="font-size:20px;font-weight:900;color:#f1f5f9;margin:0;">üìà Day Trading Journal</h2>
        <p style="font-size:11px;color:var(--text3);margin:4px 0 0 0;">Operaciones intradiarias independientes ¬∑ Riesgo: $100 ¬∑ Objetivo: $300 (3:1)</p>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" style="font-size:11px;padding:5px 12px;" onclick="exportJournalCSV()">‚¨á CSV</button>
        <button class="btn btn-purple" style="font-size:11px;padding:5px 12px;" onclick="showAddTradeForm()">Ôºã Registrar trade DT</button>
      </div>
    </div>

    <!-- KPI Dashboard -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px;padding:16px;background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(245,158,11,.04));border:1px solid var(--yellow-border);border-radius:12px;">
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">Total trades</div><div style="font-size:20px;font-weight:800;color:var(--text);margin-top:3px;" id="j-total">0</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">Win rate</div><div style="font-size:20px;font-weight:800;margin-top:3px;" id="j-winrate">0%</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">R/R ratio</div><div style="font-size:20px;font-weight:800;color:var(--blue);margin-top:3px;" id="j-rr">0.0</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">Avg trades/d√≠a</div><div style="font-size:20px;font-weight:800;color:var(--text);margin-top:3px;" id="j-avgday">0</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">Avg win</div><div style="font-size:20px;font-weight:800;color:var(--green);margin-top:3px;" id="j-avgwin">+0R</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">Avg loss</div><div style="font-size:20px;font-weight:800;color:var(--red);margin-top:3px;" id="j-avgloss">‚àí0R</div></div>
      <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;">P&L total</div><div style="font-size:20px;font-weight:800;margin-top:3px;" id="j-pnl">+0R</div></div>
    </div>

    <!-- Progress to Goal -->
    <div style="padding:14px;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;">üéØ Progreso hacia objetivo R/R 2.5</div>
        <div style="font-size:12px;font-weight:700;" id="j-progress-text">Actual: 1.3 ‚Üí Meta: 2.5</div>
      </div>
      <div style="height:8px;background:var(--bg4);border-radius:10px;overflow:hidden;">
        <div id="j-progress-bar" style="height:100%;background:linear-gradient(90deg,var(--yellow),var(--green));width:52%;transition:width .3s;"></div>
      </div>
      <div style="font-size:10px;color:var(--text3);margin-top:6px;">Estrategia: Dejar correr ganadores | Win rate m√≠nimo necesario: ~29% con R/R 2.5</div>
    </div>

    <!-- Charts Row -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
      <!-- Win Rate by Strategy Chart -->
      <div style="padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;">üìä Win Rate por Estrategia</div>
        <canvas id="strategyWinRateChart" style="max-height:200px;"></canvas>
      </div>
      <!-- R Distribution Chart -->
      <div style="padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;">
        <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;">üìà Distribuci√≥n de R</div>
        <canvas id="rDistributionChart" style="max-height:200px;"></canvas>
      </div>
    </div>

    <!-- Weekly Progress -->
    <div style="margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;">üìÖ Progreso semanal (√∫ltimas 4 semanas)</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;" id="j-weekly"></div>
    </div>

    <!-- Cumulative P&L Chart -->
    <div style="padding:14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;margin-bottom:16px;">
      <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;">üíπ P&L Acumulado (R)</div>
      <canvas id="cumulativePnlChart" style="max-height:220px;"></canvas>
    </div>

    <!-- Trade Form -->
    <div id="tradeForm" style="display:none;padding:16px;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;margin-bottom:16px;">
      <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:4px;">‚ûï Registrar nuevo trade de Day Trading</div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:12px;">Riesgo fijo: $100 USD ¬∑ Objetivo: $300 USD (3:1) ¬∑ Operaciones intradiarias independientes del portfolio</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Fecha/Hora</label><input type="datetime-local" id="tf-datetime" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"/></div>
        <div class="ticker-autocomplete" style="position:relative;"><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Ticker</label><input id="tf-ticker" placeholder="SPY" oninput="handleTickerSearch(this.value, 'daytrading')" autocomplete="off" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;text-transform:uppercase;"/><div id="tf-ticker-suggestions" class="ticker-suggestions"></div></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Direcci√≥n</label><select id="tf-direction" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"><option value="long">üìà Long</option><option value="short">üìâ Short</option></select></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Estrategia</label><select id="tf-strategy" onchange="toggleCustomStrategy()" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"><option value="Corto Vel">Corto Vel</option><option value="Largo Vel">Largo Vel</option><option value="Rompe Alto/Bajo">Rompe Alto/Bajo</option><option value="Ext + n@entero">Ext + n@entero</option><option value="Doble piso + sop">Doble piso + sop</option><option value="Doble techo + sop">Doble techo + sop</option><option value="Soporte FUERTE anterior">Soporte FUERTE anterior</option><option value="__custom__">‚úèÔ∏è Otra...</option></select><input id="tf-strategy-custom" placeholder="Escrib√≠ tu estrategia" style="display:none;width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;margin-top:6px;"/></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Precio entrada</label><input type="number" step="0.01" id="tf-entry" placeholder="420.50" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"/></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Stop Loss</label><input type="number" step="0.01" id="tf-stop" placeholder="419.00" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"/></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Target (3:1)</label><input type="number" step="0.01" id="tf-target" placeholder="425.00" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"/></div>
        <div><label style="font-size:10px;color:var(--text3);display:block;margin-bottom:4px;">Precio salida</label><input type="number" step="0.01" id="tf-exit" placeholder="424.20" style="width:100%;background:var(--bg4);border:1px solid var(--border2);border-radius:6px;padding:7px;color:var(--text);font-size:12px;"/></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn btn-ghost" onclick="hideAddTradeForm()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveJournalTrade()">üíæ Guardar trade</button>
      </div>
    </div>

    <!-- Trades List -->
    <div style="max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
      <table style="width:100%;border-collapse:collapse;">
        <thead style="position:sticky;top:0;background:var(--bg3);z-index:10;">
          <tr>
            <th style="padding:8px 10px;font-size:10px;text-align:left;border-bottom:1px solid var(--border);">Fecha</th>
            <th style="padding:8px 10px;font-size:10px;text-align:left;border-bottom:1px solid var(--border);">Ticker</th>
            <th style="padding:8px 10px;font-size:10px;text-align:left;border-bottom:1px solid var(--border);">Dir.</th>
            <th style="padding:8px 10px;font-size:10px;text-align:left;border-bottom:1px solid var(--border);">Estrategia</th>
            <th style="padding:8px 10px;font-size:10px;text-align:right;border-bottom:1px solid var(--border);">Entrada</th>
            <th style="padding:8px 10px;font-size:10px;text-align:right;border-bottom:1px solid var(--border);">Stop</th>
            <th style="padding:8px 10px;font-size:10px;text-align:right;border-bottom:1px solid var(--border);">Target</th>
            <th style="padding:8px 10px;font-size:10px;text-align:right;border-bottom:1px solid var(--border);">Salida</th>
            <th style="padding:8px 10px;font-size:10px;text-align:right;border-bottom:1px solid var(--border);">R</th>
            <th style="padding:8px 10px;font-size:10px;text-align:center;border-bottom:1px solid var(--border);">Win</th>
            <th style="padding:8px 10px;font-size:10px;text-align:center;border-bottom:1px solid var(--border);"></th>
          </tr>
        </thead>
        <tbody id="j-trades-list"></tbody>
      </table>
    </div>
  </div>
  <!-- END JOURNAL TAB -->

</main>
</div>

<!-- POSITION MODAL -->
<div class="modal-overlay" id="positionModal" onclick="closeModalOutside(event,'positionModal')">
  <div class="modal">
    <div class="modal-title" id="posModalTitle">Ôºã Nueva posici√≥n</div>
    <div class="form-grid">
      <div class="form-field ticker-autocomplete">
        <label>Ticker *</label>
        <input id="f-ticker" placeholder="ej. AAPL" oninput="handleTickerSearch(this.value, 'portfolio')" autocomplete="off"/>
        <div id="f-ticker-suggestions" class="ticker-suggestions"></div>
      </div>
      <div class="form-field"><label>Empresa *</label><input id="f-company" placeholder="ej. Apple Inc."/></div>
      <div class="form-field"><label>Direcci√≥n *</label><select id="f-direction"><option value="long">üìà Long</option><option value="short">üìâ Short</option></select></div>
      <div class="form-field"><label>Capa *</label><select id="f-layer"><option value="core">üîµ Core</option><option value="growth">üü° Growth</option><option value="special">üî¥ Special</option></select></div>
      <div class="form-field"><label>Entrada</label><input id="f-entry" placeholder="ej. $100‚Äì$110"/></div>
      <div class="form-field"><label>Stop Loss</label><input id="f-stop" placeholder="ej. $85"/></div>
      <div class="form-field"><label>Objetivo</label><input id="f-target" placeholder="ej. $150"/></div>
      <div class="form-field"><label>Upside %</label><input id="f-upside" type="number" placeholder="ej. 50"/></div>
      <div class="form-field"><label>Ratio R/R</label><input id="f-rr" type="number" step="0.1" placeholder="ej. 3.5"/></div>
      <div class="form-field"><label>Peso %</label><input id="f-weight" type="number" placeholder="ej. 5"/></div>
      <div class="form-field"><label>% bajo m√°ximo</label><input id="f-drop" type="number" placeholder="ej. 25"/></div>
      <div class="form-field"><label>Precio entrada bajo $</label><input id="f-entrylow" type="number" step="0.01" placeholder="ej. 100"/></div>
      
      <div class="form-field full">
        <label>Catalizador *</label>
        <input id="f-catalyst" placeholder="ej. Azure AI ¬∑ #1 compra Congreso"/>
      </div>

      <div class="form-field full">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="f-let-winner-run" style="width:18px;height:18px;cursor:pointer;"/>
          <span style="font-size:13px;font-weight:600;color:var(--green);">üöÄ Dej√© correr el ganador</span>
        </label>
      </div>

      <div class="form-field full">
        <label>Comentarios adicionales</label>
        <textarea id="f-comments" placeholder="Notas, observaciones, lecciones aprendidas..." style="width:100%;min-height:70px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:10px;color:var(--text);font-size:13px;font-family:'Inter',sans-serif;resize:vertical;"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('positionModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="savePosition()">Guardar posici√≥n</button>
    </div>
  </div>
</div>

<!-- PURCHASES MODAL -->
<div class="modal-overlay" id="purchasesModal" onclick="closeModalOutside(event,'purchasesModal')">
  <div class="modal" style="max-width:580px;">
    <div class="modal-title" id="purchModalTitle">üíú Compras ‚Äî MSFT</div>

    <!-- Summary -->
    <div class="purchase-summary" id="purchSummary">
      <div class="ps-item"><label>Precio promedio</label><span id="purch-avg">‚Äî</span></div>
      <div class="ps-item"><label>Total invertido</label><span id="purch-total">‚Äî</span></div>
      <div class="ps-item"><label>P&L actual</label><span id="purch-pnl">‚Äî</span></div>
    </div>

    <!-- List -->
    <div class="purchase-list" id="purchaseList"></div>

    <!-- Add form -->
    <div style="font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">‚ûï Registrar nueva compra</div>
    <div class="add-purchase-form">
      <div>
        <label>Fecha *</label>
        <input type="date" id="purch-date"/>
      </div>
      <div>
        <label>Precio compra $ *</label>
        <input type="number" step="0.01" id="purch-price" placeholder="ej. 398.50"/>
      </div>
      <div>
        <label>Cantidad *</label>
        <input type="number" step="1" id="purch-qty" placeholder="ej. 10"/>
      </div>
      <div class="full" style="margin-top:4px;">
        <button class="btn btn-purple" style="width:100%" onclick="addPurchase()">üíú Registrar compra</button>
      </div>
    </div>

    <div class="modal-footer" style="margin-top:12px;">
      <button class="btn btn-ghost" onclick="closeModal('purchasesModal')">Cerrar</button>
    </div>
  </div>
</div>

<!-- QUICK PRICE MODAL -->
<div class="modal-overlay" id="quickPriceModal" onclick="closeModalOutside(event,'quickPriceModal')">
  <div class="modal" style="max-width:500px;">
    <div class="modal-title">üìã Actualizar precios r√°pido</div>
    <p style="font-size:12px;color:var(--text3);margin-bottom:12px;line-height:1.6;">
      Copi√° los precios desde <a href="https://finance.yahoo.com" target="_blank" style="color:var(--blue)">Yahoo Finance</a>, 
      <a href="https://www.google.com/finance" target="_blank" style="color:var(--blue)">Google Finance</a> o cualquier fuente.<br>
      Formato: <code style="background:var(--bg3);padding:2px 5px;border-radius:4px;">TICKER: precio</code> ‚Äî uno por l√≠nea.
    </p>
    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
      <a href="https://finance.yahoo.com/quotes/MSFT,GOOGL,AVGO,SE,PANW,MU,CRDO,DDOG,NET,APP,NBIS,PLTR,AMD,HIMS,CRWV" 
         target="_blank" class="btn btn-ghost" style="font-size:11px;">üîó Abrir todos en Yahoo Finance</a>
    </div>
    <textarea id="quickPriceText" 
      style="width:100%;height:320px;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;
             padding:12px;color:var(--text);font-family:'Inter',monospace;font-size:13px;line-height:1.8;
             outline:none;resize:vertical;"
      placeholder="MSFT: 415.20&#10;GOOGL: 175.50&#10;AVGO: 185.30&#10;..."></textarea>
    <p style="font-size:11px;color:var(--text3);margin-top:8px;">Los precios se guardan autom√°ticamente en tu navegador y persisten entre sesiones.</p>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('quickPriceModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="applyQuickPrices()">‚úÖ Aplicar precios</button>
    </div>
  </div>
</div>

<!-- TICKER SEARCH MODAL -->
<div class="modal-overlay" id="tickerSearchModal" onclick="closeModalOutside(event,'tickerSearchModal')">
  <div class="modal" style="max-width:680px;">
    <div class="modal-title">üîç Buscar y analizar ticker</div>
    <p style="font-size:12px;color:var(--text3);margin-bottom:14px;">
      Ingres√° un ticker para obtener datos en tiempo real: precio actual, m√°ximo hist√≥rico, analizar el % bajo m√°ximo, y calculadora de upside/R:R.
    </p>
    
    <div class="form-grid" style="margin-bottom:16px;">
      <div class="form-field">
        <label>Ticker (ej. TSLA, NVDA)</label>
        <input id="search-ticker" placeholder="TSLA" style="text-transform:uppercase" oninput="this.value=this.value.toUpperCase()"/>
      </div>
      <div class="form-field">
        <button class="btn btn-primary" style="width:100%;margin-top:20px;" onclick="searchTicker()">üîé Buscar</button>
      </div>
    </div>

    <div id="tickerSearchResults" style="display:none;">
      <div style="background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:16px;margin-bottom:14px;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <div style="font-size:24px;font-weight:900;color:#f1f5f9;" id="sr-ticker">TSLA</div>
          <div style="font-size:13px;color:var(--text3);" id="sr-company">Tesla Inc.</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;">
          <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;">Precio actual</div><div style="font-size:18px;font-weight:800;color:#f1f5f9;margin-top:3px;" id="sr-price">$285.50</div></div>
          <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;">M√°x. 52 semanas</div><div style="font-size:18px;font-weight:800;color:var(--purple);margin-top:3px;" id="sr-high52">$488.54</div></div>
          <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;">M√≠n. 52 semanas</div><div style="font-size:18px;font-weight:800;color:var(--text3);margin-top:3px;" id="sr-low52">$138.80</div></div>
          <div><div style="font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;">% Bajo m√°ximo</div><div style="font-size:18px;font-weight:800;margin-top:3px;" id="sr-drop">‚àí41.6%</div></div>
        </div>
      </div>

      <div style="border:1px solid var(--border);border-radius:12px;padding:16px;background:linear-gradient(135deg,rgba(96,165,250,.04),rgba(167,139,250,.04));">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
          <div style="font-size:12px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.8px;">üìä Setup & Calculadora</div>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;" onclick="autoCalculateStops()">ü§ñ Auto-calcular stops/target</button>
        </div>
        <div class="form-grid">
          <div class="form-field">
            <label>Precio entrada $ *</label>
            <input type="number" step="0.01" id="calc-entry" placeholder="Precio entrada" oninput="calculateSetupLive()"/>
          </div>
          <div class="form-field">
            <label>Stop Loss $ * <span id="stop-hint" style="font-size:9px;color:var(--blue);font-weight:400;"></span></label>
            <input type="number" step="0.01" id="calc-stop" placeholder="Stop loss" oninput="calculateSetupLive()"/>
          </div>
          <div class="form-field">
            <label>Objetivo $ * <span id="target-hint" style="font-size:9px;color:var(--blue);font-weight:400;"></span></label>
            <input type="number" step="0.01" id="calc-target" placeholder="Objetivo" oninput="calculateSetupLive()"/>
          </div>
          <div class="form-field">
            <label>Peso portfolio %</label>
            <input type="number" step="0.5" id="calc-weight" placeholder="5" value="5" oninput="calculateSetupLive()"/>
          </div>
        </div>
        <div id="calc-results" style="margin-top:14px;padding:14px;background:var(--bg3);border-radius:10px;display:none;">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;">
            <div><div style="font-size:10px;color:var(--text3);">Upside</div><div style="font-size:16px;font-weight:800;color:var(--green);margin-top:2px;" id="calc-upside">+60.7%</div></div>
            <div><div style="font-size:10px;color:var(--text3);">Riesgo</div><div style="font-size:16px;font-weight:800;color:var(--red);margin-top:2px;" id="calc-risk">‚àí10.7%</div></div>
            <div><div style="font-size:10px;color:var(--text3);">R/R Ratio</div><div style="font-size:16px;font-weight:800;color:var(--blue);margin-top:2px;" id="calc-rr">5.7:1</div></div>
            <div><div style="font-size:10px;color:var(--text3);">P√©rdida m√°x.</div><div style="font-size:16px;font-weight:800;margin-top:2px;" id="calc-maxloss">‚àí0.54%</div><div style="font-size:9px;color:var(--text3);margin-top:1px;">del portfolio</div></div>
            <div><div style="font-size:10px;color:var(--text3);">Capa sugerida</div><div style="font-size:16px;font-weight:800;margin-top:2px;" id="calc-layer">Growth</div></div>
          </div>
        </div>
      </div>

      <div class="modal-footer" style="margin-top:14px;">
        <button class="btn btn-ghost" onclick="closeModal('tickerSearchModal')">Cerrar</button>
        <button class="btn btn-primary" onclick="addSearchedTicker()">Ôºã Agregar al portfolio</button>
      </div>
    </div>

    <div class="modal-footer" id="search-empty-footer">
      <button class="btn btn-ghost" onclick="closeModal('tickerSearchModal')">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let positions = [
  {id:1,layer:'core',ticker:'MSFT',company:'Microsoft',color:'#0078d4',entry:'$395‚Äì$410',stop:'$355',target:'$600',upside:49.6,rr:4.3,weight:10,drop:27.8,catalyst:'Azure AI ¬∑ #1 compra Congreso',entryLow:395,currentPrice:0,hidden:false},
  {id:2,layer:'core',ticker:'GOOGL',company:'Alphabet',color:'#4285f4',entry:'$170‚Äì$182',stop:'$155',target:'$270',upside:51.7,rr:4.0,weight:10,drop:13.6,catalyst:'Cloud +48% YoY ¬∑ Congresistas',entryLow:170,currentPrice:0,hidden:false},
  {id:3,layer:'core',ticker:'AVGO',company:'Broadcom',color:'#cc5500',entry:'$315‚Äì$335',stop:'$285',target:'$490',upside:50.8,rr:4.1,weight:8,drop:21.6,catalyst:'AI chips ¬∑ MSFT/GOOGL/OpenAI',entryLow:315,currentPrice:0,hidden:false},
  {id:4,layer:'core',ticker:'SE',company:'Sea Limited',color:'#e91e63',entry:'$105‚Äì$115',stop:'$88',target:'$182',upside:67,rr:3.5,weight:7,drop:45.3,catalyst:'Shopee 52% ASEAN ¬∑ FCF 7.2%',entryLow:105,currentPrice:0,hidden:false},
  {id:5,layer:'core',ticker:'PANW',company:'Palo Alto',color:'#00b4d8',entry:'$160‚Äì$172',stop:'$145',target:'$250',upside:49.7,rr:3.8,weight:7,drop:34.7,catalyst:'Ciberseg. ¬∑ Pelosi $500K‚Äì$1M',entryLow:160,currentPrice:0,hidden:false},
  {id:6,layer:'core',ticker:'MU',company:'Micron',color:'#8b5cf6',entry:'$90‚Äì$100',stop:'$78',target:'$155',upside:63.2,rr:3.5,weight:8,drop:17,catalyst:'HBM3E para NVDA ¬∑ Rev +57%',entryLow:90,currentPrice:0,hidden:false},
  {id:7,layer:'growth',ticker:'CRDO',company:'Credo Tech',color:'#f97316',entry:'$115‚Äì$130',stop:'$95',target:'$227',upside:84.6,rr:3.7,weight:6,drop:50,catalyst:'Conectividad AI ¬∑ Rev +272%',entryLow:115,currentPrice:0,hidden:false},
  {id:8,layer:'growth',ticker:'DDOG',company:'Datadog',color:'#10b981',entry:'$120‚Äì$132',stop:'$100',target:'$185',upside:48,rr:2.4,weight:5,drop:38,catalyst:'NRR 120% ¬∑ Multi-producto 84%',entryLow:120,currentPrice:0,hidden:false},
  {id:9,layer:'growth',ticker:'NET',company:'Cloudflare',color:'#f97316',entry:'$185‚Äì$205',stop:'$160',target:'$300',upside:53.1,rr:2.9,weight:5,drop:24.6,catalyst:'20% tr√°fico global ¬∑ AI edge',entryLow:185,currentPrice:0,hidden:false},
  {id:10,layer:'growth',ticker:'APP',company:'AppLovin',color:'#6366f1',entry:'$370‚Äì$410',stop:'$310',target:'$670',upside:71.8,rr:3.5,weight:5,drop:47.7,catalyst:'EBITDA 84% ¬∑ FCF +88% YoY',entryLow:370,currentPrice:0,hidden:false},
  {id:11,layer:'growth',ticker:'NBIS',company:'Nebius Group',color:'#0ea5e9',entry:'$90‚Äì$102',stop:'$72',target:'$164',upside:69.1,rr:2.7,weight:4,drop:31.3,catalyst:'Rev +355% ¬∑ Contrato $17.4B',entryLow:90,currentPrice:0,hidden:false},
  {id:12,layer:'growth',ticker:'PLTR',company:'Palantir',color:'#8b5cf6',entry:'$125‚Äì$138',stop:'$105',target:'$207',upside:58,rr:2.9,weight:5,drop:36.9,catalyst:'DOGE + Gobierno ¬∑ Com +121%',entryLow:125,currentPrice:0,hidden:false},
  {id:13,layer:'growth',ticker:'AMD',company:'Adv. Micro Dev.',color:'#ef4444',entry:'$100‚Äì$112',stop:'$85',target:'$175',upside:66.7,rr:3.5,weight:5,drop:40,catalyst:'Alt. NVDA ¬∑ OpenAI partner',entryLow:100,currentPrice:0,hidden:false},
  {id:14,layer:'special',ticker:'HIMS',company:'Hims & Hers',color:'#ec4899',entry:'$14‚Äì$17',stop:'$11',target:'$38',upside:137.5,rr:4.4,weight:3,drop:77.7,catalyst:'‚ö†Ô∏è Earnings 23 Feb ¬∑ Riesgo reg.',entryLow:14,currentPrice:0,hidden:false},
  {id:15,layer:'special',ticker:'CRWV',company:'CoreWeave',color:'#14b8a6',entry:'$35‚Äì$42',stop:'$26',target:'$90',upside:136.8,rr:4.3,weight:2,drop:99,catalyst:'‚ö†Ô∏è AI cloud ¬∑ Backlog $55B',entryLow:35,currentPrice:0,hidden:false},
];

// purchases: { [positionId]: [{date, price, qty}] }
let purchases = {};

let nextId = 16;
let activeFilters = {layer:['core','growth','special'], signal:['green','yellow','red','none']};
let showHidden = false;
let filterWithBuys = false;
let editId = null;
let activePurchaseId = null;

// Tab system
let activeTab = 'portfolio';
let journalPeriodFilter = 'all';
let journalDirectionFilter = 'all';
let journalResultFilter = 'all';

// Chart instances
let strategyChart, rDistChart, cumulativeChart;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  activeTab = tab;
  
  // Update buttons
  document.getElementById('tab-portfolio-btn').classList.toggle('active', tab === 'portfolio');
  document.getElementById('tab-journal-btn').classList.toggle('active', tab === 'journal');
  
  // Update content
  document.getElementById('tab-portfolio-content').style.display = tab === 'portfolio' ? 'block' : 'none';
  document.getElementById('tab-journal-content').style.display = tab === 'journal' ? 'block' : 'none';
  
  // Update sidebar filters
  document.getElementById('portfolio-filters').style.display = tab === 'portfolio' ? 'block' : 'none';
  document.getElementById('journal-filters').style.display = tab === 'journal' ? 'block' : 'none';
  
  if (tab === 'journal') {
    refreshJournalStats();
  }
}

function filterJournalPeriod(period, el) {
  document.querySelectorAll('#journal-filters .filter-chip').forEach(c => {
    if (c.textContent.includes('Todo') || c.textContent.includes('Esta semana') || c.textContent.includes('Este mes')) {
      c.classList.remove('active');
      c.querySelector('input').checked = false;
    }
  });
  el.classList.add('active');
  el.querySelector('input').checked = true;
  journalPeriodFilter = period;
  refreshJournalStats();
}

function filterJournalDirection(dir, el) {
  document.querySelectorAll('#journal-filters .filter-chip').forEach(c => {
    if (c.textContent.includes('Todas') || c.textContent.includes('Long') || c.textContent.includes('Short')) {
      c.classList.remove('active');
      c.querySelector('input').checked = false;
    }
  });
  el.classList.add('active');
  el.querySelector('input').checked = true;
  journalDirectionFilter = dir;
  refreshJournalStats();
}

function filterJournalResult(result, el) {
  document.querySelectorAll('#journal-filters .filter-chip').forEach(c => {
    if (c.textContent.includes('Todos') || c.textContent.includes('Ganadores') || c.textContent.includes('Break Even') || c.textContent.includes('Perdedores')) {
      c.classList.remove('active');
      c.querySelector('input').checked = false;
    }
  });
  el.classList.add('active');
  el.querySelector('input').checked = true;
  journalResultFilter = result;
  refreshJournalStats();
}

// Sort state per layer
let sortStates = {core:{col:'signal',asc:true}, growth:{col:'signal',asc:true}, special:{col:'signal',asc:true}};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGNAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSignalPct(p) {
  if (!p.currentPrice || !p.entryLow || p.entryLow <= 0) return null;
  return ((p.currentPrice - p.entryLow) / p.entryLow) * 100;
}
function getSignalBucket(p) {
  const pct = getSignalPct(p);
  if (pct === null) return 'none';
  if (pct < 3) return 'red';
  if (pct <= 10) return 'yellow';
  return 'green';
}
function renderSignalCell(p) {
  const pct = getSignalPct(p);
  if (pct === null) return `<div class="signal-wrap"><div class="signal-dot sig-none"></div><span style="font-size:11px;color:var(--text3)">Sin precio</span></div>`;
  const bucket = getSignalBucket(p);
  const dotClass = bucket === 'green' ? 'sig-green' : bucket === 'yellow' ? 'sig-yellow' : 'sig-red';
  const color = bucket === 'green' ? '#10b981' : bucket === 'yellow' ? '#fbbf24' : '#f87171';
  const label = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
  return `<div class="signal-wrap"><div class="signal-dot ${dotClass}"></div><div><div style="font-size:12px;font-weight:800;color:${color}">${label}</div><div style="font-size:10px;color:var(--text3)">vs $${p.entryLow}</div></div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PURCHASES HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPurchases(id) { return purchases[id] || []; }
function getAvgPrice(id) {
  const list = getPurchases(id);
  if (!list.length) return null;
  const totalQty = list.reduce((a,b) => a + b.qty, 0);
  const totalCost = list.reduce((a,b) => a + b.price * b.qty, 0);
  return totalQty > 0 ? totalCost / totalQty : null;
}
function getTotalInvested(id) {
  return getPurchases(id).reduce((a,b) => a + b.price * b.qty, 0);
}
function getTotalQty(id) {
  return getPurchases(id).reduce((a,b) => a + b.qty, 0);
}
function getEarliestDate(id) {
  const list = getPurchases(id);
  if (!list.length) return null;
  return list.reduce((a,b) => a < b.date ? a : b.date, list[0].date);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PORTFOLIO SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePortfolioSummary() {
  let totalInvested = 0, totalCurrent = 0;
  let posWithBuys = 0;
  let bestPct = -Infinity, worstPct = Infinity;
  let bestTicker = '‚Äî', worstTicker = '‚Äî';
  let earliestDate = null;

  positions.forEach(p => {
    const list = getPurchases(p.id);
    if (!list.length) return;
    posWithBuys++;
    const invested = getTotalInvested(p.id);
    const qty = getTotalQty(p.id);
    const currentVal = p.currentPrice ? p.currentPrice * qty : invested;
    totalInvested += invested;
    totalCurrent += currentVal;
    if (p.currentPrice) {
      const pnlPct = ((currentVal - invested) / invested) * 100;
      if (pnlPct > bestPct) { bestPct = pnlPct; bestTicker = p.ticker; }
      if (pnlPct < worstPct) { worstPct = pnlPct; worstTicker = p.ticker; }
    }
    const ed = getEarliestDate(p.id);
    if (ed && (!earliestDate || ed < earliestDate)) earliestDate = ed;
  });

  const pnl = totalCurrent - totalInvested;
  const pnlPct = totalInvested > 0 ? (pnl / totalInvested) * 100 : 0;
  const pnlColor = pnl >= 0 ? '#10b981' : '#f87171';

  document.getElementById('ps-invested').textContent = '$' + fmt(totalInvested);
  document.getElementById('ps-positions-count').textContent = posWithBuys + ' posici√≥n' + (posWithBuys !== 1 ? 'es' : '') + ' con compras';
  document.getElementById('ps-current').textContent = '$' + fmt(totalCurrent);

  const pnlEl = document.getElementById('ps-pnl');
  pnlEl.textContent = (pnl >= 0 ? '+$' : '-$') + fmt(Math.abs(pnl));
  pnlEl.style.color = pnlColor;
  const pnlPctEl = document.getElementById('ps-pnl-pct');
  pnlPctEl.textContent = (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%';
  pnlPctEl.style.color = pnlColor;

  // Annual return
  if (earliestDate && totalInvested > 0) {
    const days = Math.max(1, (new Date() - new Date(earliestDate)) / 86400000);
    const annualReturn = (Math.pow(totalCurrent / totalInvested, 365 / days) - 1) * 100;
    const arEl = document.getElementById('ps-annual');
    arEl.textContent = (annualReturn >= 0 ? '+' : '') + annualReturn.toFixed(1) + '%';
    arEl.style.color = annualReturn >= 0 ? '#10b981' : '#f87171';
    document.getElementById('ps-annual-sub').textContent = Math.round(days) + ' d√≠as activo';
  } else {
    document.getElementById('ps-annual').textContent = '‚Äî';
    document.getElementById('ps-annual-sub').textContent = 'Sin compras registradas';
  }

  const bestEl = document.getElementById('ps-best');
  bestEl.textContent = bestPct === -Infinity ? '‚Äî' : bestTicker + ' ' + (bestPct >= 0 ? '+' : '') + bestPct.toFixed(1) + '%';
  document.getElementById('ps-best-sub').textContent = bestPct === -Infinity ? '' : 'mejor posici√≥n';
  const worstEl = document.getElementById('ps-worst');
  worstEl.textContent = worstPct === Infinity ? '‚Äî' : worstTicker + ' ' + (worstPct >= 0 ? '+' : '') + worstPct.toFixed(1) + '%';
  document.getElementById('ps-worst-sub').textContent = worstPct === Infinity ? '' : 'peor posici√≥n';
}

function fmt(n) {
  if (n >= 1000000) return (n/1000000).toFixed(2) + 'M';
  if (n >= 1000) return (n/1000).toFixed(1) + 'K';
  return n.toFixed(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADINGVIEW URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTVUrl(ticker) {
  const ex = {SE:'NYSE', NET:'NYSE', HIMS:'NYSE'};
  const exchange = ex[ticker] || 'NASDAQ';
  const sym = encodeURIComponent(exchange + ':' + ticker);
  return `https://www.tradingview.com/chart/?symbol=${sym}&interval=W&studies=MASimple%408%2CMASimple%4020%2CMASimple%4050%2CMASimple%40200`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COLS = [
  {key:'ticker',  label:'Ticker',       sortable:true},
  {key:'signal',  label:'üö¶ Se√±al',     sortable:true},
  {key:'currentPrice', label:'Precio actual', sortable:true},
  {key:'entryLow',label:'P. Entrada',   sortable:true},
  {key:'compras', label:'üíú Compras',   sortable:false},
  {key:'entry',   label:'Rango entrada',sortable:false},
  {key:'stop',    label:'Stop Loss',    sortable:false},
  {key:'target',  label:'Objetivo',     sortable:false},
  {key:'upside',  label:'Upside',       sortable:true},
  {key:'rr',      label:'R/R',          sortable:true},
  {key:'weight',  label:'Peso',         sortable:true},
  {key:'drop',    label:'% Bajo m√°x.',  sortable:true},
  {key:'catalyst',label:'Catalizador',  sortable:false},
  {key:'actions', label:'',             sortable:false},
];

function buildHeader(layer) {
  const ss = sortStates[layer];
  const th = document.querySelector(`#thead-${layer} tr`);
  th.innerHTML = COLS.map(c => {
    let cls = c.sortable ? 'sortable' : '';
    if (ss.col === c.key) cls += ss.asc ? ' sorted-asc' : ' sorted-desc';
    const onclick = c.sortable ? `onclick="sortTable('${layer}','${c.key}')"` : '';
    return `<th class="${cls}" ${onclick}>${c.label}</th>`;
  }).join('');
}

function sortValue(p, col) {
  if (col === 'signal') { const v = getSignalPct(p); return v === null ? -9999 : v; }
  if (col === 'ticker') return p.ticker;
  return p[col] ?? 0;
}

function renderRow(p, layer) {
  const vis = isVisible(p);
  const hidden = (p.hidden && !showHidden) || !vis;
  const wc = layer==='core'?'wb-blue':layer==='growth'?'wb-yellow':'wb-red';
  const dc = p.drop<15?'pill-blue':p.drop<30?'pill-yellow':'pill-red';
  const uc = p.layer==='special'?'upside-warn':'upside-val';
  const tvUrl = getTVUrl(p.ticker);

  // purchases badge
  const pList = getPurchases(p.id);
  const avg = getAvgPrice(p.id);
  const qty = getTotalQty(p.id);
  let purchasesCell = '';
  if (pList.length) {
    const invested = getTotalInvested(p.id);
    let pnlHtml = '';
    if (p.currentPrice && avg) {
      const pnlPct = ((p.currentPrice - avg) / avg) * 100;
      const pnlColor = pnlPct >= 0 ? '#10b981' : '#f87171';
      pnlHtml = `<div style="font-size:10px;font-weight:700;color:${pnlColor}">${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%</div>`;
    }
    purchasesCell = `
      <div onclick="openPurchasesModal(${p.id})" style="cursor:pointer;">
        <div class="avg-price">Avg: $${avg.toFixed(2)}</div>
        <div class="avg-sub">${qty} acc ¬∑ $${fmt(invested)}</div>
        ${pnlHtml}
        <div class="purchases-badge">üíú ${pList.length} compra${pList.length>1?'s':''}</div>
      </div>`;
  } else {
    purchasesCell = `<div class="purchases-badge" onclick="openPurchasesModal(${p.id})" style="cursor:pointer">+ Registrar</div>`;
  }

  const exchange = getExchange ? getExchange(p.ticker) : 'NASDAQ';
  const tvPriceUrl = `https://www.tradingview.com/symbols/${exchange}-${p.ticker}/`;
  const priceCell = `<div>
    <input class="price-input" id="price-input-${p.id}"
      type="number" step="0.01" min="0"
      value="${p.currentPrice ? p.currentPrice.toFixed(2) : ''}"
      placeholder="$ precio"
      onchange="updatePrice(${p.id}, this.value)"
      title="Ingres√° o edit√° el precio manualmente"
      style="width:80px;font-weight:700;color:${p.currentPrice ? '#f1f5f9' : 'var(--text3)'}"/>
    <div style="margin-top:3px;">
      <a href="${tvPriceUrl}" target="_blank"
        style="font-size:10px;color:var(--blue);text-decoration:none;opacity:0.7"
        title="Ver precio en TradingView">üìä ver precio</a>
    </div>
  </div>`;

  return `<tr id="row-${p.id}" class="${hidden?'row-hidden':''}">
    <td>
      <div class="ticker-cell">
        <div class="tlogo" style="background:${p.color}">${p.ticker.substring(0,4)}</div>
        <div><div class="tfull">${p.ticker}</div><div class="tname">${p.company}</div></div>
      </div>
      <a href="${tvUrl}" target="_blank" class="tv-link">üìà TV</a>
    </td>
    <td id="sig-${p.id}">${renderSignalCell(p)}</td>
    <td>${priceCell}</td>
    <td><span style="font-size:12px;font-weight:700;color:var(--blue)">$${p.entryLow||'‚Äî'}</span></td>
    <td>${purchasesCell}</td>
    <td><input class="editable" value="${p.entry}" onchange="updateField(${p.id},'entry',this.value)"/></td>
    <td><input class="price-input" style="width:65px;background:var(--red-bg);border:1px solid var(--red-border);color:var(--red);font-weight:700;" value="${p.stop.replace('$','')}" onchange="updateStopTarget(${p.id},'stop',this.value)" placeholder="Stop"/></td>
    <td><input class="price-input" style="width:65px;background:var(--green-bg);border:1px solid var(--green-border);color:var(--green);font-weight:700;" value="${p.target.replace('$','')}" onchange="updateStopTarget(${p.id},'target',this.value)" placeholder="Target"/></td>
    <td><span class="${uc}" id="upside-${p.id}">+${p.upside}%</span></td>
    <td><span class="rr-val" id="rr-${p.id}">${p.rr}:1</span></td>
    <td><div class="w-bar-wrap"><div class="w-bar ${wc}" style="width:${Math.min(p.weight*6,72)}px"></div><span style="font-size:11px;font-weight:700;color:#94a3b8">${p.weight}%</span></div></td>
    <td><span class="pill ${dc}">‚àí${p.drop}%</span></td>
    <td style="max-width:200px;color:#94a3b8;font-size:11px;">
      ${p.direction ? `<span style="font-size:10px;opacity:0.7;">${p.direction === 'long' ? 'üìà' : 'üìâ'}</span> ` : ''}${p.catalyst}${p.letWinnerRun ? ' <span style="color:var(--green);font-size:10px;" title="Dej√© correr el ganador">üöÄ</span>' : ''}
    </td>
    <td><div class="row-actions">
      <button class="row-btn row-btn-buy" onclick="openPurchasesModal(${p.id})" title="Compras">üíú</button>
      <button class="row-btn row-btn-hide" onclick="toggleHideRow(${p.id})">${p.hidden?'üëÅ':'üôà'}</button>
      <button class="row-btn row-btn-del" onclick="deleteRow(${p.id})">‚úï</button>
    </div></td>
  </tr>`;
}

function render() {
  ['core','growth','special'].forEach(layer => {
    buildHeader(layer);
    const ss = sortStates[layer];
    let lp = positions.filter(p => p.layer === layer);

    // Sort
    lp.sort((a,b) => {
      const va = sortValue(a, ss.col), vb = sortValue(b, ss.col);
      if (typeof va === 'string') return ss.asc ? va.localeCompare(vb) : vb.localeCompare(va);
      return ss.asc ? va - vb : vb - va;
    });

    const tbody = document.getElementById('tbody-' + layer);
    if (!lp.length) {
      tbody.innerHTML = `<tr><td colspan="${COLS.length}"><div class="empty-state"><div style="font-size:28px">üì≠</div><p>Sin posiciones</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = lp.map(p => renderRow(p, layer)).join('');
  });

  updateKPIs();
  updateCounts();
  updatePortfolioSummary();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VISIBILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isVisible(p) {
  const s = document.getElementById('searchInput').value.toLowerCase();
  const mu = parseFloat(document.getElementById('upsideRange').value);
  const mr = parseFloat(document.getElementById('rrRange').value);
  if (!activeFilters.layer.includes(p.layer)) return false;
  if (s && !p.ticker.toLowerCase().includes(s) && !p.company.toLowerCase().includes(s)) return false;
  if (p.upside < mu) return false;
  if (p.rr < mr) return false;
  const sig = getSignalBucket(p);
  if (!activeFilters.signal.includes(sig)) return false;
  if (filterWithBuys && !getPurchases(p.id).length) return false;
  return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateKPIs() {
  const vis = positions.filter(p => isVisible(p) && (!p.hidden || showHidden));
  const tw = vis.reduce((a,p) => a+p.weight, 0);
  const wu = tw > 0 ? (vis.reduce((a,p) => a+(p.upside*p.weight), 0)/tw).toFixed(1) : 0;
  const au = vis.length ? (vis.reduce((a,p) => a+p.upside, 0)/vis.length).toFixed(1) : 0;
  const ar = vis.length ? (vis.reduce((a,p) => a+p.rr, 0)/vis.length).toFixed(1) : 0;
  const greenCount = vis.filter(p => getSignalBucket(p) === 'green').length;
  document.getElementById('kpiBar').innerHTML = `
    <div class="kpi-card"><div class="kpi-label">Posiciones</div><div class="kpi-val" style="color:#60a5fa">${vis.length}</div><div class="kpi-sub">de ${positions.length} totales</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside ponderado</div><div class="kpi-val" style="color:#10b981">+${wu}%</div><div class="kpi-sub">por peso portfolio</div></div>
    <div class="kpi-card"><div class="kpi-label">Upside promedio</div><div class="kpi-val" style="color:#10b981">+${au}%</div><div class="kpi-sub">media simple</div></div>
    <div class="kpi-card"><div class="kpi-label">R/R promedio</div><div class="kpi-val" style="color:#60a5fa">${ar}:1</div></div>
    <div class="kpi-card"><div class="kpi-label">Peso total</div><div class="kpi-val" style="color:${tw>100?'#f87171':'#fbbf24'}">${tw}%</div><div class="kpi-sub">${tw>100?'‚ö†Ô∏è >100%':''}</div></div>
    <div class="kpi-card"><div class="kpi-label">üü¢ En zona verde</div><div class="kpi-val" style="color:#10b981">${greenCount}</div><div class="kpi-sub">posiciones &gt;10% sobre entrada</div></div>`;
}
function updateCounts() {
  ['core','growth','special'].forEach(l => {
    const el = document.getElementById('cnt-'+l);
    if (el) el.textContent = positions.filter(p => p.layer===l && (!p.hidden||showHidden)).length;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS & SORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFilter(el, type, val) {
  el.classList.toggle('active');
  el.querySelector('input').checked = el.classList.contains('active');
  const arr = activeFilters[type];
  const idx = arr.indexOf(val);
  if (idx > -1) arr.splice(idx, 1); else arr.push(val);
  render();
}
function toggleBuyFilter(el) {
  el.classList.toggle('active');
  el.querySelector('input').checked = el.classList.contains('active');
  filterWithBuys = el.classList.contains('active');
  render();
}
function applyFilters() { render(); }
function resetFilters() {
  activeFilters = {layer:['core','growth','special'], signal:['green','yellow','red','none']};
  filterWithBuys = false;
  document.querySelectorAll('.filter-chip').forEach(c => { c.classList.add('active'); c.querySelector('input').checked = true; });
  document.getElementById('chip-withbuys').classList.remove('active');
  document.getElementById('chip-withbuys').querySelector('input').checked = false;
  ['upsideRange','rrRange'].forEach(id => document.getElementById(id).value = 0);
  document.getElementById('upsideVal').textContent = '0%';
  document.getElementById('rrVal').textContent = '0.0';
  document.getElementById('searchInput').value = '';
  render(); showToast('‚Ü∫ Filtros reseteados','');
}
function toggleSection(layer) {
  const t = document.getElementById('tbl-'+layer);
  const c = document.getElementById('chev-'+layer);
  const open = t.style.display !== 'none';
  t.style.display = open ? 'none' : '';
  c.classList.toggle('open', !open);
}
function sortTable(layer, col) {
  const ss = sortStates[layer];
  if (ss.col === col) ss.asc = !ss.asc;
  else { ss.col = col; ss.asc = col === 'signal' ? false : true; } // signal defaults descending
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT / DELETE / HIDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateField(id, field, val) {
  const p = positions.find(x => x.id === id);
  if (p) { p[field] = val; updateKPIs(); }
}

function updateStopTarget(id, field, val) {
  const p = positions.find(x => x.id === id);
  if (!p) return;
  
  // Update the field
  const numVal = parseFloat(val);
  if (isNaN(numVal) || numVal <= 0) return;
  
  p[field] = '$' + Math.round(numVal);
  
  // Extract numeric values for calculation
  const entryLow = p.entryLow || 0;
  const stop = parseFloat(p.stop.replace('$', '')) || 0;
  const target = parseFloat(p.target.replace('$', '')) || 0;
  
  if (entryLow > 0 && stop > 0 && target > 0 && stop < entryLow && target > entryLow) {
    // Recalculate upside and R/R
    const upside = ((target - entryLow) / entryLow) * 100;
    const rr = (target - entryLow) / (entryLow - stop);
    
    p.upside = Math.round(upside * 10) / 10;
    p.rr = Math.round(rr * 10) / 10;
    
    // Update display
    const upsideEl = document.getElementById('upside-' + id);
    const rrEl = document.getElementById('rr-' + id);
    if (upsideEl) upsideEl.textContent = '+' + p.upside + '%';
    if (rrEl) rrEl.textContent = p.rr + ':1';
  }
  
  updateKPIs();
  showToast(`‚úÖ ${field === 'stop' ? 'Stop Loss' : 'Objetivo'} actualizado`, 'success');
}

function deleteRow(id) {
  if (!confirm('¬øEliminar esta posici√≥n?')) return;
  positions = positions.filter(p => p.id !== id);
  delete purchases[id];
  render(); showToast('üóë Eliminada', 'error');
}
function toggleHideRow(id) {
  const p = positions.find(x => x.id === id);
  if (p) { p.hidden = !p.hidden; render(); }
}
function toggleHidden() {
  showHidden = !showHidden;
  document.getElementById('btnToggleHidden').textContent = showHidden ? 'üëÅ Ocultar ocultas' : 'üëÅ Mostrar ocultas';
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POSITION MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPositionModal(id = null) {
  editId = id;
  document.getElementById('posModalTitle').textContent = id ? '‚úèÔ∏è Editar posici√≥n' : 'Ôºã Nueva posici√≥n';
  
  if (id) {
    const p = positions.find(x => x.id === id);
    ['ticker','company','entry','stop','target'].forEach(f => document.getElementById('f-'+f).value = p[f]||'');
    document.getElementById('f-layer').value = p.layer;
    document.getElementById('f-direction').value = p.direction || 'long';
    document.getElementById('f-upside').value = p.upside;
    document.getElementById('f-rr').value = p.rr;
    document.getElementById('f-weight').value = p.weight;
    document.getElementById('f-drop').value = p.drop;
    document.getElementById('f-entrylow').value = p.entryLow||'';
    document.getElementById('f-let-winner-run').checked = p.letWinnerRun || false;
    document.getElementById('f-comments').value = p.comments || '';
    document.getElementById('f-catalyst').value = p.catalyst || '';
  } else {
    ['ticker','company','entry','stop','target','upside','rr','weight','drop','entrylow','comments','catalyst'].forEach(f => document.getElementById('f-'+f).value = '');
    document.getElementById('f-layer').value = 'core';
    document.getElementById('f-direction').value = 'long';
    document.getElementById('f-let-winner-run').checked = false;
  }
  document.getElementById('positionModal').classList.add('open');
}
function savePosition() {
  const ticker = document.getElementById('f-ticker').value.trim();
  const company = document.getElementById('f-company').value.trim();
  const catalyst = document.getElementById('f-catalyst').value.trim();
  
  if (!ticker || !company) { 
    showToast('‚ö†Ô∏è Ticker y Empresa son obligatorios','error'); 
    return; 
  }
  
  if (!catalyst) {
    showToast('‚ö†Ô∏è Seleccion√° una estrategia o ingres√° un catalizador','error'); 
    return;
  }
  
  const data = {
    ticker, 
    company,
    layer: document.getElementById('f-layer').value,
    direction: document.getElementById('f-direction').value,
    color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'), // Random color
    entry: document.getElementById('f-entry').value||'‚Äî',
    stop: document.getElementById('f-stop').value||'‚Äî',
    target: document.getElementById('f-target').value||'‚Äî',
    upside: parseFloat(document.getElementById('f-upside').value)||0,
    rr: parseFloat(document.getElementById('f-rr').value)||0,
    weight: parseFloat(document.getElementById('f-weight').value)||0,
    drop: parseFloat(document.getElementById('f-drop').value)||0,
    entryLow: parseFloat(document.getElementById('f-entrylow').value)||0,
    catalyst: catalyst,
    letWinnerRun: document.getElementById('f-let-winner-run').checked,
    comments: document.getElementById('f-comments').value.trim(),
    currentPrice: 0, 
    hidden: false,
  };
  
  if (editId) {
    const idx = positions.findIndex(p => p.id === editId);
    positions[idx] = {...positions[idx], ...data};
    showToast('‚úÖ Posici√≥n actualizada','success');
  } else {
    positions.push({id: nextId++, ...data});
    showToast('‚úÖ Posici√≥n agregada','success');
  }
  
  closeModal('positionModal'); 
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type||'');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PURCHASES ‚Äî PERSISTENCIA EN LOCALSTORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function savePurchasesToStorage() {
  try { localStorage.setItem('pf_purchases', JSON.stringify(purchases)); } catch(e) {}
}
function loadPurchasesFromStorage() {
  try {
    const raw = localStorage.getItem('pf_purchases');
    if (raw) {
      const parsed = JSON.parse(raw);
      // keys are strings in JSON, convert to int
      Object.entries(parsed).forEach(([k, v]) => { purchases[parseInt(k)] = v; });
    }
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PURCHASES MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPurchasesModal(id) {
  activePurchaseId = id;
  const p = positions.find(x => x.id === id);
  if (!p) return;
  document.getElementById('purchModalTitle').textContent = `üíú Compras ‚Äî ${p.ticker} (${p.company})`;
  document.getElementById('purch-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('purch-price').value = '';
  document.getElementById('purch-qty').value = '';
  refreshPurchasesModal();
  document.getElementById('purchasesModal').classList.add('open');
}

function refreshPurchasesModal() {
  const id = activePurchaseId;
  if (!id) return;
  const p = positions.find(x => x.id === id);
  if (!p) return;
  const list = getPurchases(id);
  const avg = getAvgPrice(id);
  const qty = getTotalQty(id);
  const invested = getTotalInvested(id);
  const currentVal = p.currentPrice ? p.currentPrice * qty : null;
  const pnl = currentVal !== null ? currentVal - invested : null;
  const pnlPct = (pnl !== null && invested > 0) ? (pnl / invested) * 100 : null;
  const pnlColor = (pnl !== null && pnl >= 0) ? '#10b981' : '#f87171';

  document.getElementById('purch-avg').textContent = avg ? '$' + avg.toFixed(2) + ' ¬∑ ' + qty + ' acc.' : '‚Äî';
  document.getElementById('purch-total').textContent = invested > 0 ? '$' + fmt(invested) : '‚Äî';
  const pnlEl = document.getElementById('purch-pnl');
  if (pnl !== null && pnlPct !== null) {
    pnlEl.textContent = (pnl>=0?'+$':'-$') + fmt(Math.abs(pnl)) + ' (' + (pnlPct>=0?'+':'') + pnlPct.toFixed(1) + '%)';
    pnlEl.style.color = pnlColor;
  } else {
    pnlEl.textContent = '‚Äî';
    pnlEl.style.color = 'var(--text3)';
  }

  if (!list.length) {
    document.getElementById('purchaseList').innerHTML = `<div class="empty-state"><div style="font-size:24px">üìã</div><p>Sin compras registradas todav√≠a</p></div>`;
    return;
  }

  document.getElementById('purchaseList').innerHTML = list.map((b, i) => {
    let rowPnl = '';
    if (p.currentPrice && b.price > 0) {
      const rPct = ((p.currentPrice - b.price) / b.price) * 100;
      const rColor = rPct >= 0 ? '#10b981' : '#f87171';
      rowPnl = `<div class="purchase-pnl" style="color:${rColor}">${rPct>=0?'+':''}${rPct.toFixed(1)}%</div>`;
    }
    return `<div class="purchase-item">
      <div class="purchase-item-info">
        <div class="purchase-date">${b.date}</div>
        <div class="purchase-detail">$${b.price.toFixed(2)} √ó ${b.qty} acc. = $${fmt(b.price * b.qty)}</div>
      </div>
      ${rowPnl}
      <button class="del-purchase" onclick="deletePurchase(${id},${i})">‚úï</button>
    </div>`;
  }).join('');
}

function addPurchase() {
  const date = document.getElementById('purch-date').value;
  const price = parseFloat(document.getElementById('purch-price').value);
  const qty = parseFloat(document.getElementById('purch-qty').value);
  if (!date || !price || !qty || price <= 0 || qty <= 0) {
    showToast('‚ö†Ô∏è Complet√° fecha, precio y cantidad', 'error'); return;
  }
  if (!purchases[activePurchaseId]) purchases[activePurchaseId] = [];
  purchases[activePurchaseId].push({date, price, qty});
  purchases[activePurchaseId].sort((a,b) => a.date.localeCompare(b.date));
  document.getElementById('purch-price').value = '';
  document.getElementById('purch-qty').value = '';
  savePurchasesToStorage();
  refreshPurchasesModal();
  render();
  showToast(`‚úÖ Compra registrada: ${qty} acc. a $${price}`, 'success');
}

function deletePurchase(id, idx) {
  if (!confirm('¬øEliminar esta compra?')) return;
  purchases[id].splice(idx, 1);
  if (!purchases[id].length) delete purchases[id];
  savePurchasesToStorage();
  refreshPurchasesModal();
  render();
  showToast('üóë Compra eliminada', 'error');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOutside(e, id) { if (e.target.id === id) closeModal(id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUICK PRICE UPDATE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openQuickPriceModal() {
  document.getElementById('quickPriceText').value = '';
  document.getElementById('quickPriceModal').classList.add('open');
}

function applyQuickPrices() {
  const text = document.getElementById('quickPriceText').value;
  if (!text.trim()) { showToast('‚ö†Ô∏è Ingres√° al menos un precio', 'error'); return; }

  let updated = 0;
  const lines = text.trim().split('\n');

  lines.forEach(line => {
    const match = line.match(/^([A-Z]+)[\s:]+([0-9.]+)/i);
    if (!match) return;
    const ticker = match[1].toUpperCase();
    const price = parseFloat(match[2]);
    if (!price || price <= 0) return;

    const p = positions.find(x => x.ticker === ticker);
    if (p) {
      p.currentPrice = Math.round(price * 100) / 100;
      savePricesToStorage();
      updated++;
    }
  });

  if (updated > 0) {
    render();
    closeModal('quickPriceModal');
    showToast(`‚úÖ ${updated} precios actualizados`, 'success');
  } else {
    showToast('‚ö†Ô∏è No se reconoci√≥ ning√∫n ticker', 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICKER SEARCH & CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let searchedTickerData = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TICKER AUTOCOMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tickerSearchTimeout = null;
let lastTickerSearchCache = {};

async function handleTickerSearch(query, context) {
  const ticker = query.trim().toUpperCase();
  const suggestionsId = context === 'portfolio' ? 'f-ticker-suggestions' : 'tf-ticker-suggestions';
  const suggestionsEl = document.getElementById(suggestionsId);
  
  // Clear previous timeout
  if (tickerSearchTimeout) clearTimeout(tickerSearchTimeout);
  
  // Hide suggestions if query too short
  if (ticker.length < 1) {
    suggestionsEl.classList.remove('show');
    return;
  }
  
  // Auto-uppercase the input
  if (context === 'portfolio') {
    document.getElementById('f-ticker').value = ticker;
  } else {
    document.getElementById('tf-ticker').value = ticker;
  }
  
  // Debounce search
  tickerSearchTimeout = setTimeout(async () => {
    try {
      const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/market/v2/get-quotes?region=US&symbols=${encodeURIComponent(ticker)}`;
      const res = await fetch(url, {
        headers: {
          'x-rapidapi-key': '1f1a074f75msh519b89fd0e03c4ep172cc3jsnfe77f0a20dcd',
          'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
        },
        signal: AbortSignal.timeout(5000)
      });
      
      if (!res.ok) throw new Error('API error');
      const data = await res.json();
      const quote = data?.quoteResponse?.result?.[0];
      
      if (quote) {
        const price = parseFloat(quote.regularMarketPrice || 0);
        const company = quote.longName || quote.shortName || ticker;
        const high52 = parseFloat(quote.fiftyTwoWeekHigh || 0);
        const low52 = parseFloat(quote.fiftyTwoWeekLow || 0);
        
        // Cache the result
        lastTickerSearchCache = {ticker, company, price, high52, low52};
        
        // Show suggestion
        suggestionsEl.innerHTML = `
          <div class="ticker-suggestion-item" onclick="selectTickerSuggestion('${context}')">
            <div class="suggestion-ticker">${ticker}</div>
            <div class="suggestion-name">${company}</div>
            <div class="suggestion-price">$${price.toFixed(2)} ¬∑ M√°x 52w: $${high52.toFixed(2)}</div>
          </div>
        `;
        suggestionsEl.classList.add('show');
      } else {
        suggestionsEl.classList.remove('show');
      }
    } catch(err) {
      console.warn('Ticker search error:', err);
      suggestionsEl.classList.remove('show');
    }
  }, 500); // Wait 500ms after user stops typing
}

function selectTickerSuggestion(context) {
  const {ticker, company, price, high52, low52} = lastTickerSearchCache;
  
  if (context === 'portfolio') {
    document.getElementById('f-ticker').value = ticker;
    document.getElementById('f-company').value = company;
    // Don't auto-fill entry/stop/target - let user decide
    document.getElementById('f-ticker-suggestions').classList.remove('show');
  } else {
    document.getElementById('tf-ticker').value = ticker;
    // Suggest entry at current price
    document.getElementById('tf-entry').value = price.toFixed(2);
    // Don't auto-fill stop/target - user should set based on their strategy
    document.getElementById('tf-ticker-suggestions').classList.remove('show');
  }
  
  showToast(`‚úÖ ${ticker} ¬∑ $${price.toFixed(2)}`, 'success');
}

// Close suggestions when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.ticker-autocomplete')) {
    document.querySelectorAll('.ticker-suggestions').forEach(el => el.classList.remove('show'));
  }
});

function openTickerSearch() {
  document.getElementById('search-ticker').value = '';
  document.getElementById('tickerSearchResults').style.display = 'none';
  document.getElementById('search-empty-footer').style.display = 'flex';
  document.getElementById('tickerSearchModal').classList.add('open');
}

async function searchTicker() {
  const ticker = document.getElementById('search-ticker').value.trim().toUpperCase();
  if (!ticker) { showToast('‚ö†Ô∏è Ingres√° un ticker', 'error'); return; }

  showToast('üîç Buscando ' + ticker + '...', '');

  try {
    // Use RapidAPI Yahoo Finance
    const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/market/v2/get-quotes?region=US&symbols=${encodeURIComponent(ticker)}`;
    const res = await fetch(url, {
      headers: {
        'x-rapidapi-key': '1f1a074f75msh519b89fd0e03c4ep172cc3jsnfe77f0a20dcd',
        'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
      },
      signal: AbortSignal.timeout(8000)
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const quote = data?.quoteResponse?.result?.[0];

    if (!quote) { showToast('‚ùå Ticker no encontrado', 'error'); return; }

    const currentPrice = parseFloat(quote.regularMarketPrice || 0);
    const high52 = parseFloat(quote.fiftyTwoWeekHigh || 0);
    const low52 = parseFloat(quote.fiftyTwoWeekLow || 0);
    const company = quote.longName || quote.shortName || ticker;
    const twoHundredDayAvg = parseFloat(quote.twoHundredDayAverage || 0);

    if (!currentPrice) { showToast('‚ùå Sin datos de precio', 'error'); return; }

    // Calculate % drop from 52w high
    const dropPct = high52 > 0 ? ((currentPrice - high52) / high52) * 100 : 0;

    searchedTickerData = { 
      ticker, company, currentPrice, high52, low52, dropPct,
      ma200: twoHundredDayAvg
    };

    // Display results
    document.getElementById('sr-ticker').textContent = ticker;
    document.getElementById('sr-company').textContent = company;
    document.getElementById('sr-price').textContent = '$' + currentPrice.toFixed(2);
    document.getElementById('sr-high52').textContent = '$' + high52.toFixed(2);
    document.getElementById('sr-low52').textContent = '$' + low52.toFixed(2);
    const dropEl = document.getElementById('sr-drop');
    dropEl.textContent = (dropPct >= 0 ? '+' : '') + dropPct.toFixed(1) + '%';
    dropEl.style.color = dropPct >= 0 ? 'var(--green)' : 'var(--red)';

    // Pre-fill entry with current price
    document.getElementById('calc-entry').value = currentPrice.toFixed(2);

    document.getElementById('tickerSearchResults').style.display = 'block';
    document.getElementById('search-empty-footer').style.display = 'none';
    document.getElementById('calc-results').style.display = 'none';

    showToast('‚úÖ Datos obtenidos para ' + ticker, 'success');

    // Auto-calculate stops immediately
    autoCalculateStops();

  } catch(err) {
    console.error('Search error:', err);
    showToast('‚ùå Error al buscar: ' + err.message, 'error');
  }
}

function autoCalculateStops() {
  if (!searchedTickerData) return;

  const { currentPrice, high52, low52, ma200 } = searchedTickerData;

  // STOP LOSS calculation (methodology: MM200 weekly o √∫ltimo soporte fuerte)
  // Aproximamos usando MA200 daily como proxy de MM200 weekly (suele estar 5-10% m√°s abajo)
  let stopPrice = ma200 > 0 ? ma200 : low52;
  
  // Si MA200 est√° muy lejos (>20% abajo), usar soporte m√°s cercano
  const ma200Distance = ma200 > 0 ? ((currentPrice - ma200) / currentPrice) * 100 : 0;
  if (ma200Distance > 20) {
    // Usar soporte intermedio: promedio entre low52 y currentPrice - 15%
    stopPrice = Math.max(low52, currentPrice * 0.85);
  }

  // Validar que stop no sea >15% del precio actual (regla de riesgo)
  const maxStop = currentPrice * 0.85; // -15% m√°ximo
  if (stopPrice < maxStop) stopPrice = maxStop;

  // TARGET calculation
  // Metodolog√≠a: resistencia t√©cnica (high52) o precio actual + upside sectorial t√≠pico
  let targetPrice = high52;
  
  // Si est√° muy cerca del m√°ximo (<10%), usar m√∫ltiplo conservador
  const distanceToHigh = ((high52 - currentPrice) / currentPrice) * 100;
  if (distanceToHigh < 10) {
    targetPrice = currentPrice * 1.5; // +50% upside conservador
  }

  // Fill fields
  document.getElementById('calc-stop').value = stopPrice.toFixed(2);
  document.getElementById('calc-target').value = targetPrice.toFixed(2);

  // Show hints
  const stopHint = ma200 > 0 ? `(MA200: $${ma200.toFixed(2)})` : `(Soporte: $${low52.toFixed(2)})`;
  const targetHint = distanceToHigh > 10 ? `(M√°x 52w)` : `(+50% conservador)`;
  document.getElementById('stop-hint').textContent = stopHint;
  document.getElementById('target-hint').textContent = targetHint;

  // Trigger live calculation
  calculateSetupLive();

  showToast('ü§ñ Stops/target calculados autom√°ticamente', 'success');
}

function calculateSetupLive() {
  const entry = parseFloat(document.getElementById('calc-entry').value);
  const stop = parseFloat(document.getElementById('calc-stop').value);
  const target = parseFloat(document.getElementById('calc-target').value);
  const weight = parseFloat(document.getElementById('calc-weight').value) || 5;

  if (!entry || !stop || !target || entry <= 0 || stop <= 0 || target <= 0) {
    document.getElementById('calc-results').style.display = 'none';
    return;
  }

  if (stop >= entry) {
    document.getElementById('calc-results').style.display = 'none';
    return;
  }

  if (target <= entry) {
    document.getElementById('calc-results').style.display = 'none';
    return;
  }

  const upside = ((target - entry) / entry) * 100;
  const risk = ((entry - stop) / entry) * 100;
  const rr = (target - entry) / (entry - stop);
  const maxLossPortfolio = (risk / 100) * (weight / 100) * 100; // % del portfolio total

  // Suggest layer based on metrics
  let suggestedLayer = 'growth';
  if (upside < 40 && rr > 3.5) suggestedLayer = 'core';
  else if (upside > 100 || Math.abs(searchedTickerData?.dropPct || 0) > 60) suggestedLayer = 'special';

  const layerColors = { core: '#60a5fa', growth: '#fbbf24', special: '#f87171' };

  document.getElementById('calc-upside').textContent = '+' + upside.toFixed(1) + '%';
  document.getElementById('calc-risk').textContent = '‚àí' + risk.toFixed(1) + '%';
  document.getElementById('calc-rr').textContent = rr.toFixed(1) + ':1';
  document.getElementById('calc-maxloss').textContent = '‚àí' + maxLossPortfolio.toFixed(2) + '%';
  const layerEl = document.getElementById('calc-layer');
  layerEl.textContent = suggestedLayer.charAt(0).toUpperCase() + suggestedLayer.slice(1);
  layerEl.style.color = layerColors[suggestedLayer];

  document.getElementById('calc-results').style.display = 'block';
}

function calculateSetup() {
  // Legacy function - now just calls live version
  calculateSetupLive();
  if (document.getElementById('calc-results').style.display === 'block') {
    showToast('‚úÖ Setup calculado', 'success');
  } else {
    showToast('‚ö†Ô∏è Complet√° entrada, stop y objetivo', 'error');
  }
}

function addSearchedTicker() {
  if (!searchedTickerData) { showToast('‚ö†Ô∏è Primero busc√° un ticker', 'error'); return; }

  const entry = parseFloat(document.getElementById('calc-entry').value);
  const stop = parseFloat(document.getElementById('calc-stop').value);
  const target = parseFloat(document.getElementById('calc-target').value);
  const weight = parseFloat(document.getElementById('calc-weight').value) || 5;

  if (!entry || !stop || !target) {
    showToast('‚ö†Ô∏è Complet√° entrada, stop y objetivo antes de agregar', 'error'); return;
  }

  const upside = ((target - entry) / entry) * 100;
  const rr = (target - entry) / (entry - stop);
  const dropAbs = Math.abs(searchedTickerData.dropPct);

  // Auto-classify in layer based on calculated metrics
  let layer = 'growth';
  if (upside < 40 && rr > 3.5) layer = 'core';
  else if (upside > 100 || dropAbs > 60) layer = 'special';

  const newPos = {
    id: nextId++,
    ticker: searchedTickerData.ticker,
    company: searchedTickerData.company,
    layer,
    color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'),
    entry: `$${Math.round(entry)}`,
    stop: `$${Math.round(stop)}`,
    target: `$${Math.round(target)}`,
    upside: Math.round(upside * 10) / 10,
    rr: Math.round(rr * 10) / 10,
    weight: weight,
    drop: Math.round(dropAbs * 10) / 10,
    entryLow: entry,
    currentPrice: searchedTickerData.currentPrice,
    catalyst: 'üìä An√°lisis t√©cnico + fundamentals',
    hidden: false
  };

  positions.push(newPos);
  render();
  closeModal('tickerSearchModal');
  showToast(`‚úÖ ${newPos.ticker} agregado a ${layer.toUpperCase()}`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  const h = ['Ticker','Empresa','Capa','Se√±al%','PrecioActual','EntradaLow','Entrada','Stop','Objetivo','Upside%','R/R','Peso%','%BajoMax','AvgCompra','TotalInvertido','Catalizador'];
  const r = positions.map(p => {
    const sig = getSignalPct(p);
    const avg = getAvgPrice(p.id);
    return [p.ticker,p.company,p.layer,sig?sig.toFixed(2):'',p.currentPrice||'',p.entryLow,p.entry,p.stop,p.target,p.upside,p.rr,p.weight,p.drop,avg?avg.toFixed(2):'',getTotalInvested(p.id)||'',p.catalyst];
  });
  const csv = [h,...r].map(x => x.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = 'portfolio_2026.csv'; a.click();
  showToast('‚¨á CSV descargado', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRECIOS ‚Äî TradingView + corsproxy + localStorage cache
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EXCHANGES = { SE:'NYSE', NET:'NYSE', HIMS:'NYSE' };
function getExchange(ticker) { return EXCHANGES[ticker] || 'NASDAQ'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY TRADING JOURNAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let journalTrades = [];

function loadJournalFromStorage() {
  try {
    const raw = localStorage.getItem('daytrading_journal');
    if (raw) journalTrades = JSON.parse(raw);
  } catch(e) {}
}

function saveJournalToStorage() {
  try { localStorage.setItem('daytrading_journal', JSON.stringify(journalTrades)); } catch(e) {}
}


function showAddTradeForm() {
  document.getElementById('tradeForm').style.display = 'block';
  // Set default datetime to now
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  const localISOTime = new Date(now - offset).toISOString().slice(0, 16);
  document.getElementById('tf-datetime').value = localISOTime;
}

function toggleCustomStrategy() {
  const select = document.getElementById('tf-strategy');
  const customInput = document.getElementById('tf-strategy-custom');
  if (select.value === '__custom__') {
    customInput.style.display = 'block';
    customInput.focus();
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
  }
}

function hideAddTradeForm() {
  document.getElementById('tradeForm').style.display = 'none';
  // Clear form
  ['tf-ticker','tf-entry','tf-stop','tf-target','tf-exit'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('tf-strategy').selectedIndex = 0; // Reset to first strategy
  document.getElementById('tf-strategy-custom').style.display = 'none';
  document.getElementById('tf-strategy-custom').value = '';
}

function saveJournalTrade() {
  const datetime = document.getElementById('tf-datetime').value;
  const ticker = document.getElementById('tf-ticker').value.trim().toUpperCase();
  const direction = document.getElementById('tf-direction').value;
  let strategy = document.getElementById('tf-strategy').value;
  
  // If custom strategy selected, use the custom input
  if (strategy === '__custom__') {
    strategy = document.getElementById('tf-strategy-custom').value.trim();
    if (!strategy) {
      showToast('‚ö†Ô∏è Escrib√≠ el nombre de la estrategia', 'error'); return;
    }
  }
  
  const entry = parseFloat(document.getElementById('tf-entry').value);
  const stop = parseFloat(document.getElementById('tf-stop').value);
  const target = parseFloat(document.getElementById('tf-target').value);
  const exit = parseFloat(document.getElementById('tf-exit').value);

  if (!datetime || !ticker || !entry || !stop || !target || !exit) {
    showToast('‚ö†Ô∏è Complet√° todos los campos', 'error'); return;
  }

  // Constants
  const RISK_USD = 100; // Riesgo fijo por operaci√≥n
  const TARGET_USD = 300; // Objetivo fijo por operaci√≥n

  // Calculate R and USD P&L
  const riskPerShare = Math.abs(entry - stop);
  const pnlPerShare = direction === 'long' ? (exit - entry) : (entry - exit);
  const rMultiple = riskPerShare > 0 ? pnlPerShare / riskPerShare : 0;
  const pnlUSD = rMultiple * RISK_USD;

  // Classify: win / breakeven / loss
  let tradeType = 'loss';
  if (pnlUSD >= -20 && pnlUSD <= 20) {
    tradeType = 'breakeven';
  } else if (pnlUSD > 20) {
    tradeType = 'win';
  }

  const trade = {
    id: Date.now(),
    datetime,
    date: datetime.split('T')[0],
    ticker,
    direction,
    strategy,
    entry,
    stop,
    target,
    exit,
    rMultiple: Math.round(rMultiple * 100) / 100,
    pnlUSD: Math.round(pnlUSD * 100) / 100,
    riskUSD: RISK_USD,
    targetUSD: TARGET_USD,
    isWin: tradeType === 'win',
    isBreakeven: tradeType === 'breakeven',
    tradeType
  };

  journalTrades.push(trade);
  saveJournalToStorage();
  refreshJournalStats();
  hideAddTradeForm();
  showToast(`‚úÖ Trade ${ticker} registrado: ${rMultiple >= 0 ? '+' : ''}${rMultiple.toFixed(2)}R (${pnlUSD >= 0 ? '+' : ''}$${pnlUSD.toFixed(2)})`, 'success');
}

function deleteJournalTrade(id) {
  if (!confirm('¬øEliminar este trade?')) return;
  journalTrades = journalTrades.filter(t => t.id !== id);
  saveJournalToStorage();
  refreshJournalStats();
  showToast('üóë Trade eliminado', 'error');
}

function refreshJournalStats() {
  const total = journalTrades.length;
  const wins = journalTrades.filter(t => t.tradeType === 'win' || (t.isWin && !t.tradeType)).length;
  const breakevens = journalTrades.filter(t => t.tradeType === 'breakeven' || t.isBreakeven).length;
  const losses = total - wins - breakevens;
  const winRate = total > 0 ? (wins / total) * 100 : 0;

  const totalR = journalTrades.reduce((a, t) => a + t.rMultiple, 0);
  const avgWin = wins > 0 ? journalTrades.filter(t => t.tradeType === 'win' || (t.isWin && !t.tradeType)).reduce((a,t) => a + t.rMultiple, 0) / wins : 0;
  const avgLoss = losses > 0 ? journalTrades.filter(t => t.tradeType === 'loss' || (!t.isWin && !t.isBreakeven && !t.tradeType)).reduce((a,t) => a + t.rMultiple, 0) / losses : 0;
  const rrRatio = wins > 0 && losses > 0 ? Math.abs(avgWin / avgLoss) : 0;

  // Trades per day
  const uniqueDates = [...new Set(journalTrades.map(t => t.date))];
  const tradesPerDay = uniqueDates.length > 0 ? total / uniqueDates.length : 0;

  // Update KPIs
  document.getElementById('j-total').textContent = total;
  document.getElementById('j-winrate').textContent = winRate.toFixed(1) + '%';
  document.getElementById('j-winrate').style.color = winRate >= 45 ? 'var(--green)' : winRate >= 35 ? 'var(--yellow)' : 'var(--red)';
  document.getElementById('j-rr').textContent = rrRatio.toFixed(2);
  document.getElementById('j-avgday').textContent = tradesPerDay.toFixed(1);
  document.getElementById('j-avgwin').textContent = '+' + avgWin.toFixed(2) + 'R';
  document.getElementById('j-avgloss').textContent = avgLoss.toFixed(2) + 'R';
  const pnlEl = document.getElementById('j-pnl');
  pnlEl.textContent = (totalR >= 0 ? '+' : '') + totalR.toFixed(2) + 'R';
  pnlEl.style.color = totalR >= 0 ? 'var(--green)' : 'var(--red)';

  // Progress bar
  const currentRR = rrRatio || 1.3; // default to your current
  const targetRR = 2.5;
  const progressPct = Math.min((currentRR / targetRR) * 100, 100);
  document.getElementById('j-progress-bar').style.width = progressPct + '%';
  document.getElementById('j-progress-text').textContent = `Actual: ${currentRR.toFixed(2)} ‚Üí Meta: ${targetRR}`;

  // Weekly progress (last 4 weeks)
  const now = new Date();
  const weeks = [];
  for (let i = 3; i >= 0; i--) {
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - (i * 7) - now.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    const weekTrades = journalTrades.filter(t => {
      const td = new Date(t.date);
      return td >= weekStart && td <= weekEnd;
    });

    const weekWins = weekTrades.filter(t => t.isWin).length;
    const weekTotal = weekTrades.length;
    const weekWinRate = weekTotal > 0 ? (weekWins / weekTotal) * 100 : 0;
    const weekR = weekTrades.reduce((a, t) => a + t.rMultiple, 0);

    weeks.push({
      label: `Sem ${4-i}`,
      date: weekStart.toLocaleDateString('es-AR', {day:'2-digit', month:'short'}),
      total: weekTotal,
      winRate: weekWinRate,
      pnl: weekR
    });
  }

  document.getElementById('j-weekly').innerHTML = weeks.map(w => {
    const barColor = w.pnl >= 0 ? 'var(--green)' : 'var(--red)';
    return `<div style="padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;">
      <div style="font-size:10px;color:var(--text3);margin-bottom:4px;">${w.label} (${w.date})</div>
      <div style="font-size:18px;font-weight:800;color:${barColor};margin-bottom:6px;">${w.pnl >= 0 ? '+' : ''}${w.pnl.toFixed(1)}R</div>
      <div style="font-size:10px;color:var(--text2);">${w.total} trades ¬∑ ${w.winRate.toFixed(0)}% win</div>
    </div>`;
  }).join('');

  // Render trades list (apply filters)
  let filtered = [...journalTrades];
  
  // Apply result filter
  if (journalResultFilter === 'wins') {
    filtered = filtered.filter(t => t.tradeType === 'win' || (t.isWin && !t.tradeType));
  } else if (journalResultFilter === 'breakeven') {
    filtered = filtered.filter(t => t.tradeType === 'breakeven' || (t.isBreakeven));
  } else if (journalResultFilter === 'losses') {
    filtered = filtered.filter(t => t.tradeType === 'loss' || (!t.isWin && !t.isBreakeven && !t.tradeType));
  }
  
  const sorted = filtered.sort((a,b) => b.datetime.localeCompare(a.datetime));
  document.getElementById('j-trades-list').innerHTML = sorted.length ? sorted.map(t => {
    const rColor = t.rMultiple >= 0 ? 'var(--green)' : 'var(--red)';
    const dirIcon = t.direction === 'long' ? 'üìà' : 'üìâ';
    
    // Win icon based on trade type
    let winIcon = '‚ùå';
    if (t.tradeType === 'win' || (t.isWin && !t.tradeType)) winIcon = '‚úÖ';
    else if (t.tradeType === 'breakeven' || t.isBreakeven) winIcon = '‚öñÔ∏è';
    
    const dt = new Date(t.datetime);
    const timeStr = dt.toLocaleString('es-AR', {month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    
    return `<tr style="border-bottom:1px solid var(--border);">
      <td style="padding:10px;font-size:11px;color:var(--text2);">${timeStr}</td>
      <td style="padding:10px;font-size:12px;font-weight:700;">${t.ticker}</td>
      <td style="padding:10px;font-size:11px;">${dirIcon}</td>
      <td style="padding:10px;font-size:11px;color:var(--text3);">${t.strategy}</td>
      <td style="padding:10px;font-size:11px;text-align:right;">${t.entry.toFixed(2)}</td>
      <td style="padding:10px;font-size:11px;text-align:right;color:var(--red);">${t.stop.toFixed(2)}</td>
      <td style="padding:10px;font-size:11px;text-align:right;color:var(--green);">${t.target.toFixed(2)}</td>
      <td style="padding:10px;font-size:11px;text-align:right;font-weight:700;">${t.exit.toFixed(2)}</td>
      <td style="padding:10px;font-size:12px;font-weight:800;text-align:right;color:${rColor};">${t.rMultiple >= 0 ? '+' : ''}${t.rMultiple.toFixed(2)}R</td>
      <td style="padding:10px;font-size:12px;font-weight:800;text-align:right;color:${rColor};">${t.pnlUSD ? (t.pnlUSD >= 0 ? '+$' : '-$') + Math.abs(t.pnlUSD).toFixed(2) : '‚Äî'}</td>
      <td style="padding:10px;text-align:center;">${winIcon}</td>
      <td style="padding:10px;text-align:center;"><button onclick="deleteJournalTrade(${t.id})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;">‚úï</button></td>
    </tr>`;
  }).join('') : `<tr><td colspan="12" style="padding:32px;text-align:center;color:var(--text3);">üìã Sin trades registrados todav√≠a</td></tr>`;
}

function exportJournalCSV() {
  if (!journalTrades.length) { showToast('‚ö†Ô∏è No hay trades para exportar', 'error'); return; }
  const h = ['Fecha','Hora','Ticker','Direcci√≥n','Estrategia','Entrada','Stop','Target','Salida','R','Win/Loss'];
  const rows = journalTrades.map(t => {
    const dt = new Date(t.datetime);
    return [
      dt.toLocaleDateString('es-AR'),
      dt.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'}),
      t.ticker,
      t.direction,
      t.strategy,
      t.entry,
      t.stop,
      t.target,
      t.exit,
      t.rMultiple.toFixed(2),
      t.isWin ? 'Win' : 'Loss'
    ];
  });
  const csv = [h, ...rows].map(r => r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `daytrading_journal_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast('‚¨á Journal exportado', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRECIOS ‚Äî localStorage cache
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function savePricesToStorage() {
  try {
    const cache = {};
    positions.forEach(p => { if (p.currentPrice) cache[p.ticker] = { price: p.currentPrice, ts: Date.now() }; });
    localStorage.setItem('pf_prices', JSON.stringify(cache));
  } catch(e) {}
}
function loadPricesFromStorage() {
  let loaded = 0;
  try {
    const cache = JSON.parse(localStorage.getItem('pf_prices') || '{}');
    positions.forEach(p => { if (cache[p.ticker]) { p.currentPrice = cache[p.ticker].price; loaded++; } });
  } catch(e) {}
  return loaded;
}

function updatePrice(id, val) {
  const p = positions.find(x => x.id === id);
  if (!p) return;
  const price = parseFloat(val);
  if (isNaN(price) || price <= 0) return;
  p.currentPrice = Math.round(price * 100) / 100;
  savePricesToStorage();
  const cell = document.getElementById('sig-' + p.id);
  if (cell) cell.innerHTML = renderSignalCell(p);
  updatePortfolioSummary();
  updateKPIs();
  showToast(`‚úÖ $${p.ticker} = $${p.currentPrice}`, 'success');
}

async function fetchPrices() {
  showToast('üîÑ Cargando precios...', '');
  document.getElementById('lastUpdate').textContent = 'Cargando precios...';
  document.getElementById('lastUpdate').style.color = '#fbbf24';

  let updated = 0;
  const symbols = positions.map(p => p.ticker).join(',');

  // Strategy 1: RapidAPI Yahoo Finance (m√°s confiable para GitHub Pages)
  try {
    const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/market/v2/get-quotes?region=US&symbols=${encodeURIComponent(symbols)}`;
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'x-rapidapi-key': '1f1a074f75msh519b89fd0e03c4ep172cc3jsnfe77f0a20dcd',
        'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com'
      },
      signal: AbortSignal.timeout(8000)
    });
    if (res.ok) {
      const data = await res.json();
      (data?.quoteResponse?.result || []).forEach(q => {
        const ticker = (q.symbol || '').replace(/\.[A-Z]+$/, '').toUpperCase();
        const price = parseFloat(q.regularMarketPrice || 0);
        if (ticker && price > 0) {
          const p = positions.find(x => x.ticker === ticker);
          if (p) { p.currentPrice = Math.round(price * 100) / 100; updated++; }
        }
      });
    }
  } catch(e) { console.warn('RapidAPI Yahoo failed:', e.message); }

  // Strategy 2: allorigins proxy (si RapidAPI falla)
  if (updated === 0) {
    for (const p of positions) {
      try {
        const yahooUrl = encodeURIComponent(`https://query2.finance.yahoo.com/v8/finance/chart/${p.ticker}?interval=1d&range=1d`);
        const res = await fetch(`https://api.allorigins.win/raw?url=${yahooUrl}`, {
          signal: AbortSignal.timeout(4000)
        });
        if (res.ok) {
          const data = await res.json();
          const price = data?.chart?.result?.[0]?.meta?.regularMarketPrice;
          if (price && price > 0) {
            p.currentPrice = Math.round(price * 100) / 100;
            updated++;
          }
        }
      } catch(e) { continue; }
    }
  }

  // Strategy 3: Load from localStorage cache if all failed
  if (updated === 0) updated = loadPricesFromStorage();

  if (updated > 0) savePricesToStorage();
  render();

  const now = new Date();
  const ts = now.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
  const ds = now.toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', year:'numeric'});

  if (updated > 0) {
    document.getElementById('lastUpdate').textContent = `‚úÖ ${ds} ${ts} ¬∑ ${updated} precios ¬∑ Edit√° cualquier precio en la tabla`;
    document.getElementById('lastUpdate').style.color = '#10b981';
    showToast(`‚úÖ ${updated} precios actualizados`, 'success');
  } else {
    document.getElementById('lastUpdate').textContent = `‚ö†Ô∏è Sin precios autom√°ticos ‚Äî ingres√° manualmente (se guardan solos)`;
    document.getElementById('lastUpdate').style.color = '#fbbf24';
    showToast('üí° Hac√© clic en "üìä ver precio" de cada fila para ver el precio en TradingView', '');
  }
}

function isMarketHours() {
  const now = new Date(); const day = now.getUTCDay();
  if (day === 0 || day === 6) return false;
  const m = now.getUTCHours() * 60 + now.getUTCMinutes();
  return m >= 14*60+30 && m <= 21*60;
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
// Initialization now handled in checkPin() after successful login
// loadJournalFromStorage();
// loadPurchasesFromStorage();
// loadPricesFromStorage();
// render();
// fetchPrices();
setInterval(() => { if (isMarketHours() && isLoggedIn) fetchPrices(); }, 5*60*1000);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CORRECT_PIN = '1234'; // Change this to your desired PIN
let isLoggedIn = false;

function movePinFocus(current) {
  const val = document.getElementById(`pin${current}`).value;
  if (val.length === 1 && current < 4) {
    document.getElementById(`pin${current + 1}`).focus();
  }
  if (current === 4 && val.length === 1) {
    checkPin();
  }
}

function handlePinBackspace(event, current) {
  if (event.key === 'Backspace') {
    const input = document.getElementById(`pin${current}`);
    if (input.value === '' && current > 1) {
      setTimeout(() => document.getElementById(`pin${current - 1}`).focus(), 10);
    }
  }
}

function checkPin() {
  const pin = ['pin1','pin2','pin3','pin4'].map(id => document.getElementById(id).value).join('');
  if (pin === CORRECT_PIN) {
    isLoggedIn = true;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('navMenu').style.display = 'block';
    document.getElementById('appContainer').style.display = 'block';
    localStorage.setItem('portfolio_logged_in', 'true');
    
    // Initialize app
    loadJournalFromStorage();
    loadPurchasesFromStorage();
    loadPricesFromStorage();
    render();
    fetchPrices();
  } else {
    document.getElementById('pinError').textContent = '‚ùå C√≥digo incorrecto';
    ['pin1','pin2','pin3','pin4'].forEach(id => {
      const el = document.getElementById(id);
      el.value = '';
      el.style.borderColor = '#ef4444';
    });
    document.getElementById('pin1').focus();
    setTimeout(() => {
      ['pin1','pin2','pin3','pin4'].forEach(id => {
        document.getElementById(id).style.borderColor = '#e2e8f0';
      });
      document.getElementById('pinError').textContent = '';
    }, 2000);
  }
}

function logout() {
  if (confirm('¬øCerrar sesi√≥n?')) {
    isLoggedIn = false;
    localStorage.removeItem('portfolio_logged_in');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('navMenu').style.display = 'none';
    document.getElementById('appContainer').style.display = 'none';
    ['pin1','pin2','pin3','pin4'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('pin1').focus();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchToPortfolio() {
  document.querySelectorAll('.menu-nav-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  switchTab('portfolio');
}

function switchToDayTrading() {
  document.querySelectorAll('.menu-nav-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  switchTab('journal');
}

// Check if already logged in on page load
if (localStorage.getItem('portfolio_logged_in') === 'true') {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('navMenu').style.display = 'block';
  document.getElementById('appContainer').style.display = 'block';
  isLoggedIn = true;
} else {
  // Focus on first PIN input
  setTimeout(() => document.getElementById('pin1').focus(), 100);
}

</script>
</div><!-- END appContainer -->

</body>
</html>
